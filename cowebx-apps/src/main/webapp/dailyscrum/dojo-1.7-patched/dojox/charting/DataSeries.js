/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/lang","dojo/_base/declare","dojo/_base/connect","dojox/lang/functional"],function(_1,_2,_3,df){return _1.declare("dojox.charting.DataSeries",null,{constructor:function(_4,_5,_6){this.store=_4;this.kwArgs=_5;if(_6){if(_1.isFunction(_6)){this.value=_6;}else{if(_1.isObject(_6)){this.value=_1.hitch(this,"_dictValue",df.keys(_6),_6);}else{this.value=_1.hitch(this,"_fieldValue",_6);}}}else{this.value=_1.hitch(this,"_defaultValue");}this.data=[];this._events=[];if(this.store.getFeatures()["dojo.data.api.Notification"]){this._events.push(_1.connect(this.store,"onNew",this,"_onStoreNew"),_1.connect(this.store,"onDelete",this,"_onStoreDelete"),_1.connect(this.store,"onSet",this,"_onStoreSet"));}this.fetch();},destroy:function(){_1.forEach(this._events,_1.disconnect);},setSeriesObject:function(_7){this.series=_7;},_dictValue:function(_8,_9,_a,_b){var o={};_1.forEach(_8,function(_c){o[_c]=_a.getValue(_b,_9[_c]);});return o;},_fieldValue:function(_d,_e,_f){return _e.getValue(_f,_d);},_defaultValue:function(_10,_11){return _10.getValue(_11,"value");},fetch:function(){if(!this._inFlight){this._inFlight=true;var _12=_1.delegate(this.kwArgs);_12.onComplete=_1.hitch(this,"_onFetchComplete");_12.onError=_1.hitch(this,"onFetchError");this.store.fetch(_12);}},_onFetchComplete:function(_13,_14){this.items=_13;this._buildItemMap();this.data=_1.map(this.items,function(_15){return this.value(this.store,_15);},this);this._pushDataChanges();this._inFlight=false;},onFetchError:function(_16,_17){this._inFlight=false;},_buildItemMap:function(){if(this.store.getFeatures()["dojo.data.api.Identity"]){var _18={};_1.forEach(this.items,function(_19,_1a){_18[this.store.getIdentity(_19)]=_1a;},this);this.itemMap=_18;}},_pushDataChanges:function(){if(this.series){this.series.chart.updateSeries(this.series.name,this);this.series.chart.delayedRender();}},_onStoreNew:function(){this.fetch();},_onStoreDelete:function(_1b){if(this.items){var _1c=_1.xsome(this.items,function(it,_1d){if(it===_1b){this.items.splice(_1d,1);this._buildItemMap();this.data.splice(_1d,1);return true;}return false;},this);if(_1c){this._pushDataChanges();}}},_onStoreSet:function(_1e){if(this.itemMap){var id=this.store.getIdentity(_1e),_1f=this.itemMap[id];if(typeof _1f=="number"){this.data[_1f]=this.value(this.store,this.items[_1f]);this._pushDataChanges();}}else{if(this.items){var _20=_1.some(this.items,function(it,_21){if(it===_1e){this.data[_21]=this.value(this.store,it);return true;}return false;},this);if(_20){this._pushDataChanges();}}}}});});