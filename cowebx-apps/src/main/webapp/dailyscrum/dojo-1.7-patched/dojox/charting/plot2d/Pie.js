/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/lang","dojo/_base/declare","../Element","./_PlotEvents","./common","../axis2d/common","dojox/gfx","dojox/gfx/matrix","dojox/lang/functional","dojox/lang/utils"],function(_1,_2,_3,_4,dc,da,g,m,df,du){var _5=0.2;return _1.declare("dojox.charting.plot2d.Pie",[dojox.charting.Element,dojox.charting.plot2d._PlotEvents],{defaultParams:{labels:true,ticks:false,fixed:true,precision:1,labelOffset:20,labelStyle:"default",htmlLabels:true,radGrad:"native",fanSize:5,startAngle:0},optionalParams:{radius:0,stroke:{},outline:{},shadow:{},fill:{},font:"",fontColor:"",labelWiring:{}},constructor:function(_6,_7){this.opt=_1.clone(this.defaultParams);du.updateWithObject(this.opt,_7);du.updateWithPattern(this.opt,_7,this.optionalParams);this.run=null;this.dyn=[];},clear:function(){this.dirty=true;this.dyn=[];this.run=null;return this;},setAxis:function(_8){return this;},addSeries:function(_9){this.run=_9;return this;},getSeriesStats:function(){return _1.delegate(dc.defaultStats);},initializeScalers:function(){return this;},getRequiredColors:function(){return this.run?this.run.data.length:0;},render:function(_a,_b){if(!this.dirty){return this;}this.resetEvents();this.dirty=false;this._eventSeries={};this.cleanGroup();var s=this.group,t=this.chart.theme;if(!this.run||!this.run.data.length){return this;}var rx=(_a.width-_b.l-_b.r)/2,ry=(_a.height-_b.t-_b.b)/2,r=Math.min(rx,ry),_c="font" in this.opt?this.opt.font:t.axis.font,_d=_c?g.normalizedLength(g.splitFontString(_c).size):0,_e="fontColor" in this.opt?this.opt.fontColor:t.axis.fontColor,_f=m._degToRad(this.opt.startAngle),_10=_f,_11,_12,_13,_14,_15,_16,run=this.run.data,_17=this.events();if(typeof run[0]=="number"){_12=df.map(run,"x ? Math.max(x, 0) : 0");if(df.every(_12,"<= 0")){return this;}_13=df.map(_12,"/this",df.foldl(_12,"+",0));if(this.opt.labels){_14=_1.map(_13,function(x){return x>0?this._getLabel(x*100)+"%":"";},this);}}else{_12=df.map(run,"x ? Math.max(x.y, 0) : 0");if(df.every(_12,"<= 0")){return this;}_13=df.map(_12,"/this",df.foldl(_12,"+",0));if(this.opt.labels){_14=_1.map(_13,function(x,i){if(x<=0){return "";}var v=run[i];return "text" in v?v.text:this._getLabel(x*100)+"%";},this);}}var _18=df.map(run,function(v,i){if(v===null||typeof v=="number"){return t.next("slice",[this.opt,this.run],true);}return t.next("slice",[this.opt,this.run,v],true);},this);if(this.opt.labels){_15=df.foldl1(df.map(_14,function(_19,i){var _1a=_18[i].series.font;return g._base._getTextBox(_19,{font:_1a}).w;},this),"Math.max(a, b)")/2;if(this.opt.labelOffset<0){r=Math.min(rx-2*_15,ry-_d)+this.opt.labelOffset;}_16=r-this.opt.labelOffset;}if("radius" in this.opt){r=this.opt.radius;_16=r-this.opt.labelOffset;}var _1b={cx:_b.l+rx,cy:_b.t+ry,r:r};this.dyn=[];var _1c=new Array(_13.length);_1.some(_13,function(_1d,i){if(_1d<0){return false;}if(_1d==0){this.dyn.push({fill:null,stroke:null});return false;}var v=run[i],_1e=_18[i],_1f;if(_1d>=1){_1f=this._plotFill(_1e.series.fill,_a,_b);_1f=this._shapeFill(_1f,{x:_1b.cx-_1b.r,y:_1b.cy-_1b.r,width:2*_1b.r,height:2*_1b.r});_1f=this._pseudoRadialFill(_1f,{x:_1b.cx,y:_1b.cy},_1b.r);var _20=s.createCircle(_1b).setFill(_1f).setStroke(_1e.series.stroke);this.dyn.push({fill:_1f,stroke:_1e.series.stroke});if(_17){var o={element:"slice",index:i,run:this.run,shape:_20,x:i,y:typeof v=="number"?v:v.y,cx:_1b.cx,cy:_1b.cy,cr:r};this._connectEvents(o);_1c[i]=o;}return true;}var end=_10+_1d*2*Math.PI;if(i+1==_13.length){end=_f+2*Math.PI;}var _21=end-_10,x1=_1b.cx+r*Math.cos(_10),y1=_1b.cy+r*Math.sin(_10),x2=_1b.cx+r*Math.cos(end),y2=_1b.cy+r*Math.sin(end);var _22=m._degToRad(this.opt.fanSize);if(_1e.series.fill&&_1e.series.fill.type==="radial"&&this.opt.radGrad==="fan"&&_21>_22){var _23=s.createGroup(),_24=Math.ceil(_21/_22),_25=_21/_24;_1f=this._shapeFill(_1e.series.fill,{x:_1b.cx-_1b.r,y:_1b.cy-_1b.r,width:2*_1b.r,height:2*_1b.r});for(var j=0;j<_24;++j){var _26=j==0?x1:_1b.cx+r*Math.cos(_10+(j-_5)*_25),_27=j==0?y1:_1b.cy+r*Math.sin(_10+(j-_5)*_25),_28=j==_24-1?x2:_1b.cx+r*Math.cos(_10+(j+1+_5)*_25),_29=j==_24-1?y2:_1b.cy+r*Math.sin(_10+(j+1+_5)*_25),fan=_23.createPath().moveTo(_1b.cx,_1b.cy).lineTo(_26,_27).arcTo(r,r,0,_25>Math.PI,true,_28,_29).lineTo(_1b.cx,_1b.cy).closePath().setFill(this._pseudoRadialFill(_1f,{x:_1b.cx,y:_1b.cy},r,_10+(j+0.5)*_25,_10+(j+0.5)*_25));}_23.createPath().moveTo(_1b.cx,_1b.cy).lineTo(x1,y1).arcTo(r,r,0,_21>Math.PI,true,x2,y2).lineTo(_1b.cx,_1b.cy).closePath().setStroke(_1e.series.stroke);_20=_23;}else{_20=s.createPath().moveTo(_1b.cx,_1b.cy).lineTo(x1,y1).arcTo(r,r,0,_21>Math.PI,true,x2,y2).lineTo(_1b.cx,_1b.cy).closePath().setStroke(_1e.series.stroke);var _1f=_1e.series.fill;if(_1f&&_1f.type==="radial"){_1f=this._shapeFill(_1f,{x:_1b.cx-_1b.r,y:_1b.cy-_1b.r,width:2*_1b.r,height:2*_1b.r});if(this.opt.radGrad==="linear"){_1f=this._pseudoRadialFill(_1f,{x:_1b.cx,y:_1b.cy},r,_10,end);}}else{if(_1f&&_1f.type==="linear"){_1f=this._plotFill(_1f,_a,_b);_1f=this._shapeFill(_1f,_20.getBoundingBox());}}_20.setFill(_1f);}this.dyn.push({fill:_1f,stroke:_1e.series.stroke});if(_17){var o={element:"slice",index:i,run:this.run,shape:_20,x:i,y:typeof v=="number"?v:v.y,cx:_1b.cx,cy:_1b.cy,cr:r};this._connectEvents(o);_1c[i]=o;}_10=end;return false;},this);if(this.opt.labels){if(this.opt.labelStyle=="default"){_10=_f;_1.some(_13,function(_2a,i){if(_2a<=0){return false;}var _2b=_18[i];if(_2a>=1){var v=run[i],_2c=da.createText[this.opt.htmlLabels&&g.renderer!="vml"?"html":"gfx"](this.chart,s,_1b.cx,_1b.cy+_d/2,"middle",_14[i],_2b.series.font,_2b.series.fontColor);if(this.opt.htmlLabels){this.htmlElements.push(_2c);}return true;}var end=_10+_2a*2*Math.PI,v=run[i];if(i+1==_13.length){end=_f+2*Math.PI;}var _2d=(_10+end)/2,x=_1b.cx+_16*Math.cos(_2d),y=_1b.cy+_16*Math.sin(_2d)+_d/2;var _2c=da.createText[this.opt.htmlLabels&&g.renderer!="vml"?"html":"gfx"](this.chart,s,x,y,"middle",_14[i],_2b.series.font,_2b.series.fontColor);if(this.opt.htmlLabels){this.htmlElements.push(_2c);}_10=end;return false;},this);}else{if(this.opt.labelStyle=="columns"){_10=_f;var _2e=[];_1.forEach(_13,function(_2f,i){var end=_10+_2f*2*Math.PI;if(i+1==_13.length){end=_f+2*Math.PI;}var _30=(_10+end)/2;_2e.push({angle:_30,left:Math.cos(_30)<0,theme:_18[i],index:i,omit:end-_10<0.001});_10=end;});var _31=g._base._getTextBox("a",{font:_c}).h;this._getProperLabelRadius(_2e,_31,_1b.r*1.1);_1.forEach(_2e,function(_32,i){if(!_32.omit){var _33=_1b.cx-_1b.r*2,_34=_1b.cx+_1b.r*2,_35=g._base._getTextBox(_14[i],{font:_c}).w,x=_1b.cx+_32.labelR*Math.cos(_32.angle),y=_1b.cy+_32.labelR*Math.sin(_32.angle),_36=(_32.left)?(_33+_35):(_34-_35),_37=(_32.left)?_33:_36;var _38=s.createPath().moveTo(_1b.cx+_1b.r*Math.cos(_32.angle),_1b.cy+_1b.r*Math.sin(_32.angle));if(Math.abs(_32.labelR*Math.cos(_32.angle))<_1b.r*2-_35){_38.lineTo(x,y);}_38.lineTo(_36,y).setStroke(_32.theme.series.labelWiring);var _39=da.createText[this.opt.htmlLabels&&g.renderer!="vml"?"html":"gfx"](this.chart,s,_37,y,"left",_14[i],_32.theme.series.font,_32.theme.series.fontColor);if(this.opt.htmlLabels){this.htmlElements.push(_39);}}},this);}}}var esi=0;this._eventSeries[this.run.name]=df.map(run,function(v){return v<=0?null:_1c[esi++];});return this;},_getProperLabelRadius:function(_3a,_3b,_3c){var _3d={},_3e={},_3f=1,_40=1;if(_3a.length==1){_3a[0].labelR=_3c;return;}for(var i=0;i<_3a.length;i++){var _41=Math.abs(Math.sin(_3a[i].angle));if(_3a[i].left){if(_3f>_41){_3f=_41;_3d=_3a[i];}}else{if(_40>_41){_40=_41;_3e=_3a[i];}}}_3d.labelR=_3e.labelR=_3c;this._calculateLabelR(_3d,_3a,_3b);this._calculateLabelR(_3e,_3a,_3b);},_calculateLabelR:function(_42,_43,_44){var i=_42.index,_45=_43.length,_46=_42.labelR;while(!(_43[i%_45].left^_43[(i+1)%_45].left)){if(!_43[(i+1)%_45].omit){var _47=(Math.sin(_43[i%_45].angle)*_46+((_43[i%_45].left)?(-_44):_44))/Math.sin(_43[(i+1)%_45].angle);_46=(_47<_42.labelR)?_42.labelR:_47;_43[(i+1)%_45].labelR=_46;}i++;}i=_42.index;var j=(i==0)?_45-1:i-1;while(!(_43[i].left^_43[j].left)){if(!_43[j].omit){var _47=(Math.sin(_43[i].angle)*_46+((_43[i].left)?_44:(-_44)))/Math.sin(_43[j].angle);_46=(_47<_42.labelR)?_42.labelR:_47;_43[j].labelR=_46;}i--;j--;i=(i<0)?i+_43.length:i;j=(j<0)?j+_43.length:j;}},_getLabel:function(_48){return dc.getLabel(_48,this.opt.fixed,this.opt.precision);}});});