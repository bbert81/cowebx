/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/lang","dojo/_base/declare","./Base","./common","dojox/lang/functional","dojox/lang/functional/reversed","dojox/lang/utils","dojox/gfx/fx"],function(_1,_2,_3,dc,df,_4,du,fx){var _5=df.lambda("item.purgeGroup()");return _1.declare("dojox.charting.plot2d.Columns",dojox.charting.plot2d.Base,{defaultParams:{hAxis:"x",vAxis:"y",gap:0,animate:null,enableCache:false},optionalParams:{minBarSize:1,maxBarSize:1,stroke:{},outline:{},shadow:{},fill:{},font:"",fontColor:""},constructor:function(_6,_7){this.opt=_1.clone(this.defaultParams);du.updateWithObject(this.opt,_7);du.updateWithPattern(this.opt,_7,this.optionalParams);this.series=[];this.hAxis=this.opt.hAxis;this.vAxis=this.opt.vAxis;this.animate=this.opt.animate;},getSeriesStats:function(){var _8=dc.collectSimpleStats(this.series);_8.hmin-=0.5;_8.hmax+=0.5;return _8;},createRect:function(_9,_a,_b){var _c;if(this.opt.enableCache&&_9._rectFreePool.length>0){_c=_9._rectFreePool.pop();_c.setShape(_b);_a.add(_c);}else{_c=_a.createRect(_b);}if(this.opt.enableCache){_9._rectUsePool.push(_c);}return _c;},render:function(_d,_e){if(this.zoom&&!this.isDataDirty()){return this.performZoom(_d,_e);}var t=this.getSeriesStats();this.resetEvents();this.dirty=this.isDirty();if(this.dirty){_1.forEach(this.series,_5);this._eventSeries={};this.cleanGroup();var s=this.group;df.forEachRev(this.series,function(_f){_f.cleanGroup(s);});}var t=this.chart.theme,f,gap,_10,ht=this._hScaler.scaler.getTransformerFromModel(this._hScaler),vt=this._vScaler.scaler.getTransformerFromModel(this._vScaler),_11=Math.max(0,this._vScaler.bounds.lower),_12=vt(_11),min=Math.max(0,Math.floor(this._hScaler.bounds.from-1)),max=Math.ceil(this._hScaler.bounds.to),_13=this.events();f=dc.calculateBarSize(this._hScaler.bounds.scale,this.opt);gap=f.gap;_10=f.size;for(var i=this.series.length-1;i>=0;--i){var run=this.series[i];if(!this.dirty&&!run.dirty){t.skip();this._reconnectEvents(run.name);continue;}run.cleanGroup();if(this.opt.enableCache){run._rectFreePool=(run._rectFreePool?run._rectFreePool:[]).concat(run._rectUsePool?run._rectUsePool:[]);run._rectUsePool=[];}var _14=t.next("column",[this.opt,run]),s=run.group,_15=new Array(run.data.length);var l=Math.min(run.data.length,max);for(var j=min;j<l;++j){var _16=run.data[j];if(_16!==null){var v=typeof _16=="number"?_16:_16.y,vv=vt(v),_17=vv-_12,h=Math.abs(_17),_18=typeof _16!="number"?t.addMixin(_14,"column",_16,true):t.post(_14,"column");if(_10>=1&&h>=1){var _19={x:_e.l+ht(j+0.5)+gap,y:_d.height-_e.b-(v>_11?vv:_12),width:_10,height:h};var _1a=this._plotFill(_18.series.fill,_d,_e);_1a=this._shapeFill(_1a,_19);var _1b=this.createRect(run,s,_19).setFill(_1a).setStroke(_18.series.stroke);run.dyn.fill=_1b.getFill();run.dyn.stroke=_1b.getStroke();if(_13){var o={element:"column",index:j,run:run,shape:_1b,x:j+0.5,y:v};this._connectEvents(o);_15[j]=o;}if(this.animate){this._animateColumn(_1b,_d.height-_e.b-_12,h);}}}}this._eventSeries[run.name]=_15;run.dirty=false;}this.dirty=false;return this;},_animateColumn:function(_1c,_1d,_1e){fx.animateTransform(_1.delegate({shape:_1c,duration:1200,transform:[{name:"translate",start:[0,_1d-(_1d/_1e)],end:[0,0]},{name:"scale",start:[1,1/_1e],end:[1,1]},{name:"original"}]},this.animate)).play();}});});