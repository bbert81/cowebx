/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/lang","dojo/_base/declare","dojo/_base/html","dojo/_base/connect","./Chart2D","./themes/PlotKit/blue"],function(_1,_2,_3,_4,_5){_1.experimental("dojox.charting.DataChart");var _6={vertical:true,min:0,max:10,majorTickStep:5,minorTickStep:1,natural:false,stroke:"black",majorTick:{stroke:"black",length:8},minorTick:{stroke:"gray",length:2},majorLabels:true};var _7={natural:true,majorLabels:true,includeZero:false,majorTickStep:1,majorTick:{stroke:"black",length:8},fixUpper:"major",stroke:"black",htmlLabels:true,from:1};var _8={markers:true,tension:2,gap:2};return _1.declare("dojox.charting.DataChart",dojox.charting.Chart2D,{scroll:true,comparative:false,query:"*",queryOptions:"",fieldName:"value",chartTheme:dojox.charting.themes.PlotKit.blue,displayRange:0,stretchToFit:true,minWidth:200,minHeight:100,showing:true,label:"name",constructor:function(_9,_a){this.domNode=_1.byId(_9);_1.mixin(this,_a);this.xaxis=_1.mixin(_1.mixin({},_7),_a.xaxis);if(this.xaxis.labelFunc=="seriesLabels"){this.xaxis.labelFunc=_1.hitch(this,"seriesLabels");}this.yaxis=_1.mixin(_1.mixin({},_6),_a.yaxis);if(this.yaxis.labelFunc=="seriesLabels"){this.yaxis.labelFunc=_1.hitch(this,"seriesLabels");}this._events=[];this.convertLabels(this.yaxis);this.convertLabels(this.xaxis);this.onSetItems={};this.onSetInterval=0;this.dataLength=0;this.seriesData={};this.seriesDataBk={};this.firstRun=true;this.dataOffset=0;this.chartTheme.plotarea.stroke={color:"gray",width:3};this.setTheme(this.chartTheme);if(this.displayRange){this.stretchToFit=false;}if(!this.stretchToFit){this.xaxis.to=this.displayRange;}this.addAxis("x",this.xaxis);this.addAxis("y",this.yaxis);_8.type=_a.type||"Markers";this.addPlot("default",_1.mixin(_8,_a.chartPlot));this.addPlot("grid",_1.mixin(_a.grid||{},{type:"Grid",hMinorLines:true}));if(this.showing){this.render();}if(_a.store){this.setStore(_a.store,_a.query,_a.fieldName,_a.queryOptions);}},destroy:function(){_1.forEach(this._events,_1.disconnect);this.inherited(arguments);},setStore:function(_b,_c,_d,_e){this.firstRun=true;this.store=_b||this.store;this.query=_c||this.query;this.fieldName=_d||this.fieldName;this.label=this.store.getLabelAttributes();this.queryOptions=_e||_e;_1.forEach(this._events,_1.disconnect);this._events=[_1.connect(this.store,"onSet",this,"onSet"),_1.connect(this.store,"onError",this,"onError")];this.fetch();},show:function(){if(!this.showing){_1.style(this.domNode,"display","");this.showing=true;this.render();}},hide:function(){if(this.showing){_1.style(this.domNode,"display","none");this.showing=false;}},onSet:function(_f){var nm=this.getProperty(_f,this.label);if(nm in this.runs||this.comparative){clearTimeout(this.onSetInterval);if(!this.onSetItems[nm]){this.onSetItems[nm]=_f;}this.onSetInterval=setTimeout(_1.hitch(this,function(){clearTimeout(this.onSetInterval);var _10=[];for(var nm in this.onSetItems){_10.push(this.onSetItems[nm]);}this.onData(_10);this.onSetItems={};}),200);}},onError:function(err){console.error("DataChart Error:",err);},onDataReceived:function(_11){},getProperty:function(_12,_13){if(_13==this.label){return this.store.getLabel(_12);}if(_13=="id"){return this.store.getIdentity(_12);}var _14=this.store.getValues(_12,_13);if(_14.length<2){_14=this.store.getValue(_12,_13);}return _14;},onData:function(_15){if(!_15||!_15.length){return;}if(this.items&&this.items.length!=_15.length){_1.forEach(_15,function(m){var id=this.getProperty(m,"id");_1.forEach(this.items,function(m2,i){if(this.getProperty(m2,"id")==id){this.items[i]=m2;}},this);},this);_15=this.items;}if(this.stretchToFit){this.displayRange=_15.length;}this.onDataReceived(_15);this.items=_15;if(this.comparative){var nm="default";this.seriesData[nm]=[];this.seriesDataBk[nm]=[];_1.forEach(_15,function(m,i){var _16=this.getProperty(m,this.fieldName);this.seriesData[nm].push(_16);},this);}else{_1.forEach(_15,function(m,i){var nm=this.store.getLabel(m);if(!this.seriesData[nm]){this.seriesData[nm]=[];this.seriesDataBk[nm]=[];}var _17=this.getProperty(m,this.fieldName);if(_1.isArray(_17)){this.seriesData[nm]=_17;}else{if(!this.scroll){var ar=_1.map(new Array(i+1),function(){return 0;});ar.push(Number(_17));this.seriesData[nm]=ar;}else{if(this.seriesDataBk[nm].length>this.seriesData[nm].length){this.seriesData[nm]=this.seriesDataBk[nm];}this.seriesData[nm].push(Number(_17));}this.seriesDataBk[nm].push(Number(_17));}},this);}var _18;if(this.firstRun){this.firstRun=false;for(nm in this.seriesData){this.addSeries(nm,this.seriesData[nm]);_18=this.seriesData[nm];}}else{for(nm in this.seriesData){_18=this.seriesData[nm];if(this.scroll&&_18.length>this.displayRange){this.dataOffset=_18.length-this.displayRange-1;_18=_18.slice(_18.length-this.displayRange,_18.length);}this.updateSeries(nm,_18);}}this.dataLength=_18.length;if(this.showing){this.render();}},fetch:function(){if(!this.store){return;}this.store.fetch({query:this.query,queryOptions:this.queryOptions,start:this.start,count:this.count,sort:this.sort,onComplete:_1.hitch(this,function(_19){setTimeout(_1.hitch(this,function(){this.onData(_19);}),0);}),onError:_1.hitch(this,"onError")});},convertLabels:function(_1a){if(!_1a.labels||_1.isObject(_1a.labels[0])){return null;}_1a.labels=_1.map(_1a.labels,function(ele,i){return {value:i,text:ele};});return null;},seriesLabels:function(val){val--;if(this.series.length<1||(!this.comparative&&val>this.series.length)){return "-";}if(this.comparative){return this.store.getLabel(this.items[val]);}else{for(var i=0;i<this.series.length;i++){if(this.series[i].data[val]>0){return this.series[i].name;}}}return "-";},resizeChart:function(dim){var w=Math.max(dim.w,this.minWidth);var h=Math.max(dim.h,this.minHeight);this.resize(w,h);}});});