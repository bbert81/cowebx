/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/lang","dojo/_base/declare","./Base","./common","dojox/lang/functional","dojox/lang/functional/reversed","dojox/lang/utils","dojox/gfx/fx"],function(_1,_2,_3,dc,df,_4,du,fx){var _5=df.lambda("item.purgeGroup()");return _1.declare("dojox.charting.plot2d.OHLC",dojox.charting.plot2d.Base,{defaultParams:{hAxis:"x",vAxis:"y",gap:2,animate:null},optionalParams:{minBarSize:1,maxBarSize:1,stroke:{},outline:{},shadow:{},fill:{},font:"",fontColor:""},constructor:function(_6,_7){this.opt=_1.clone(this.defaultParams);du.updateWithObject(this.opt,_7);du.updateWithPattern(this.opt,_7,this.optionalParams);this.series=[];this.hAxis=this.opt.hAxis;this.vAxis=this.opt.vAxis;this.animate=this.opt.animate;},collectStats:function(_8){var _9=_1.delegate(dc.defaultStats);for(var i=0;i<_8.length;i++){var _a=_8[i];if(!_a.data.length){continue;}var _b=_9.vmin,_c=_9.vmax;if(!("ymin" in _a)||!("ymax" in _a)){_1.forEach(_a.data,function(_d,_e){if(_d!==null){var x=_d.x||_e+1;_9.hmin=Math.min(_9.hmin,x);_9.hmax=Math.max(_9.hmax,x);_9.vmin=Math.min(_9.vmin,_d.open,_d.close,_d.high,_d.low);_9.vmax=Math.max(_9.vmax,_d.open,_d.close,_d.high,_d.low);}});}if("ymin" in _a){_9.vmin=Math.min(_b,_a.ymin);}if("ymax" in _a){_9.vmax=Math.max(_c,_a.ymax);}}return _9;},getSeriesStats:function(){var _f=this.collectStats(this.series);_f.hmin-=0.5;_f.hmax+=0.5;return _f;},render:function(dim,_10){if(this.zoom&&!this.isDataDirty()){return this.performZoom(dim,_10);}this.resetEvents();this.dirty=this.isDirty();if(this.dirty){_1.forEach(this.series,_5);this._eventSeries={};this.cleanGroup();var s=this.group;df.forEachRev(this.series,function(_11){_11.cleanGroup(s);});}var t=this.chart.theme,f,gap,_12,ht=this._hScaler.scaler.getTransformerFromModel(this._hScaler),vt=this._vScaler.scaler.getTransformerFromModel(this._vScaler),_13=Math.max(0,this._vScaler.bounds.lower),_14=vt(_13),_15=this.events();f=dc.calculateBarSize(this._hScaler.bounds.scale,this.opt);gap=f.gap;_12=f.size;for(var i=this.series.length-1;i>=0;--i){var run=this.series[i];if(!this.dirty&&!run.dirty){t.skip();this._reconnectEvents(run.name);continue;}run.cleanGroup();var _16=t.next("candlestick",[this.opt,run]),s=run.group,_17=new Array(run.data.length);for(var j=0;j<run.data.length;++j){var v=run.data[j];if(v!==null){var _18=t.addMixin(_16,"candlestick",v,true);var x=ht(v.x||(j+0.5))+_10.l+gap,y=dim.height-_10.b,_19=vt(v.open),_1a=vt(v.close),_1b=vt(v.high),low=vt(v.low);if(low>_1b){var tmp=_1b;_1b=low;low=tmp;}if(_12>=1){var hl={x1:_12/2,x2:_12/2,y1:y-_1b,y2:y-low},op={x1:0,x2:((_12/2)+((_18.series.stroke.width||1)/2)),y1:y-_19,y2:y-_19},cl={x1:((_12/2)-((_18.series.stroke.width||1)/2)),x2:_12,y1:y-_1a,y2:y-_1a};var _1c=s.createGroup();_1c.setTransform({dx:x,dy:0});var _1d=_1c.createGroup();_1d.createLine(hl).setStroke(_18.series.stroke);_1d.createLine(op).setStroke(_18.series.stroke);_1d.createLine(cl).setStroke(_18.series.stroke);run.dyn.stroke=_18.series.stroke;if(_15){var o={element:"candlestick",index:j,run:run,shape:_1d,x:x,y:y-Math.max(_19,_1a),cx:_12/2,cy:(y-Math.max(_19,_1a))+(Math.max(_19>_1a?_19-_1a:_1a-_19,1)/2),width:_12,height:Math.max(_19>_1a?_19-_1a:_1a-_19,1),data:v};this._connectEvents(o);_17[j]=o;}}if(this.animate){this._animateOHLC(_1c,y-low,_1b-low);}}}this._eventSeries[run.name]=_17;run.dirty=false;}this.dirty=false;return this;},_animateOHLC:function(_1e,_1f,_20){fx.animateTransform(_1.delegate({shape:_1e,duration:1200,transform:[{name:"translate",start:[0,_1f-(_1f/_20)],end:[0,0]},{name:"scale",start:[1,1/_20],end:[1,1]},{name:"original"}]},this.animate)).play();}});});