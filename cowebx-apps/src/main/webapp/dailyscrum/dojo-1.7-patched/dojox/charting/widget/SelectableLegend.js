/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/array","dojo/_base/declare","dojo/query","dojo/_base/html","dojo/_base/connect","dojo/_base/Color","./Legend","dijit/form/CheckBox","../action2d/Highlight","dojox/lang/functional"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,df){_1.declare("dojox.charting.widget.SelectableLegend",dojox.charting.widget.Legend,{outline:false,transitionFill:null,transitionStroke:null,postCreate:function(){this.legends=[];this.legendAnim={};this.inherited(arguments);},refresh:function(){this.legends=[];this.inherited(arguments);this._applyEvents();new dojox.charting.widget._FocusManager(this);},_addLabel:function(_a,_b){this.inherited(arguments);var _c=_1.query("td",this.legendBody);var _d=_c[_c.length-1];this.legends.push(_d);var _e=new _8({checked:true});_1.place(_e.domNode,_d,"first");var _b=_1.query("label",_d)[0];_1.attr(_b,"for",_e.id);},_applyEvents:function(){if(this.chart.dirty){return;}_1.forEach(this.legends,function(_f,i){var _10,_11=[],_12,_13;if(this._isPie()){_10=this.chart.stack[0];_11.push(_10.group.children[i]);_12=_10.name;_13=this.chart.series[0].name;}else{_10=this.chart.series[i];_11=_10.group.children;_12=_10.plot;_13=_10.name;}var _14={fills:df.map(_11,"x.getFill()"),strokes:df.map(_11,"x.getStroke()")};var _15=_1.query(".dijitCheckBox",_f)[0];_1.connect(_15,"onclick",this,function(e){this._toggle(_11,i,_f.vanished,_14,_13,_12);_f.vanished=!_f.vanished;e.stopPropagation();});var _16=_1.query(".dojoxLegendIcon",_f)[0],_17=this._getFilledShape(this._surfaces[i].children);_1.forEach(["onmouseenter","onmouseleave"],function(_18){_1.connect(_16,_18,this,function(e){this._highlight(e,_17,_11,i,_f.vanished,_14,_13,_12);});},this);},this);},_toggle:function(_19,_1a,_1b,dyn,_1c,_1d){_1.forEach(_19,function(_1e,i){var _1f=dyn.fills[i],_20=this._getTransitionFill(_1d),_21=dyn.strokes[i],_22=this.transitionStroke;if(_1f){if(_20&&(typeof _1f=="string"||_1f instanceof _1.Color)){dojox.gfx.fx.animateFill({shape:_1e,color:{start:_1b?_20:_1f,end:_1b?_1f:_20}}).play();}else{_1e.setFill(_1b?_1f:_20);}}if(_21&&!this.outline){_1e.setStroke(_1b?_21:_22);}},this);},_highlight:function(e,_23,_24,_25,_26,dyn,_27,_28){if(!_26){var _29=this._getAnim(_28),_2a=this._isPie(),_2b=_2c(e.type);var _2d={shape:_23,index:_2a?"legend"+_25:"legend",run:{name:_27},type:_2b};_29.process(_2d);_1.forEach(_24,function(_2e,i){_2e.setFill(dyn.fills[i]);var o={shape:_2e,index:_2a?_25:i,run:{name:_27},type:_2b};_29.duration=100;_29.process(o);});}},_getAnim:function(_2f){if(!this.legendAnim[_2f]){this.legendAnim[_2f]=new _9(this.chart,_2f);}return this.legendAnim[_2f];},_getTransitionFill:function(_30){if(this.chart.stack[this.chart.plots[_30]].declaredClass.indexOf("dojox.charting.plot2d.Stacked")!=-1){return this.chart.theme.plotarea.fill;}return null;},_getFilledShape:function(_31){var i=0;while(_31[i]){if(_31[i].getFill()){return _31[i];}i++;}},_isPie:function(){return this.chart.stack[0].declaredClass=="dojox.charting.plot2d.Pie";}});function _2c(_32){if(_32=="mouseenter"){return "onmouseover";}if(_32=="mouseleave"){return "onmouseout";}return "on"+_32;};_1.declare("dojox.charting.widget._FocusManager",null,{constructor:function(_33){this.legend=_33;this.index=0;this.horizontalLength=this._getHrizontalLength();_1.forEach(_33.legends,function(_34,i){if(i>0){_1.query("input",_34).attr("tabindex",-1);}});this.firstLabel=_1.query("input",_33.legends[0])[0];_1.connect(this.firstLabel,"focus",this,function(){this.legend.active=true;});_1.connect(this.legend.domNode,"keydown",this,"_onKeyEvent");},_getHrizontalLength:function(){var _35=this.legend.horizontal;if(typeof _35=="number"){return Math.min(_35,this.legend.legends.length);}else{if(!_35){return 1;}else{return this.legend.legends.length;}}},_onKeyEvent:function(e){if(!this.legend.active){return;}if(e.keyCode==_1.keys.TAB){this.legend.active=false;return;}var max=this.legend.legends.length;switch(e.keyCode){case _1.keys.LEFT_ARROW:this.index--;if(this.index<0){this.index+=max;}break;case _1.keys.RIGHT_ARROW:this.index++;if(this.index>=max){this.index-=max;}break;case _1.keys.UP_ARROW:if(this.index-this.horizontalLength>=0){this.index-=this.horizontalLength;}break;case _1.keys.DOWN_ARROW:if(this.index+this.horizontalLength<max){this.index+=this.horizontalLength;}break;default:return;}this._moveToFocus();_1.stopEvent(e);},_moveToFocus:function(){_1.query("input",this.legend.legends[this.index])[0].focus();}});return dojox.charting.widget.SelectableLegend;});