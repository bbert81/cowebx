/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/lang","dojo/_base/declare","dojo/_base/connect","dojo/_base/window","dojo/_base/html"],function(_1,_2,_3,_4,_5){return _1.declare("dojox.geo.charting.MouseInteractionSupport",null,{_map:null,_mapClickLocation:null,_screenClickLocation:null,_mouseDragListener:null,_mouseUpListener:null,_mouseUpClickListener:null,_mouseDownListener:null,_mouseMoveListener:null,_mouseWheelListener:null,_currentFeature:null,_cancelMouseClick:null,_zoomEnabled:false,_panEnabled:false,_onDragStartListener:null,_onSelectStartListener:null,mouseClickThreshold:2,constructor:function(_6,_7){this._map=_6;this._mapClickLocation={x:0,y:0};this._screenClickLocation={x:0,y:0};this._cancelMouseClick=false;if(_7){this._zoomEnabled=_7.enableZoom;this._panEnabled=_7.enablePan;if(_7.mouseClickThreshold&&_7.mouseClickThreshold>0){this.mouseClickThreshold=_7.mouseClickThreshold;}}},setEnableZoom:function(_8){if(_8&&!this._mouseWheelListener){var _9=!_1.isMozilla?"onmousewheel":"DOMMouseScroll";this._mouseWheelListener=this._map.surface.connect(_9,this,this._mouseWheelHandler);}else{if(!_8&&this._mouseWheelListener){_1.disconnect(this._mouseWheelListener);this._mouseWheelListener=null;}}this._zoomEnabled=_8;},setEnablePan:function(_a){this._panEnabled=_a;},connect:function(){this._mouseMoveListener=this._map.surface.connect("onmousemove",this,this._mouseMoveHandler);this._mouseDownListener=this._map.surface.connect("onmousedown",this,this._mouseDownHandler);if(_1.isIE){_onDragStartListener=_1.connect(_1.doc,"ondragstart",this,_1.stopEvent);_onSelectStartListener=_1.connect(_1.doc,"onselectstart",this,_1.stopEvent);}this.setEnableZoom(this._zoomEnabled);this.setEnablePan(this._panEnabled);},disconnect:function(){var _b=this._zoomEnabled;this.setEnableZoom(false);this._zoomEnabled=_b;if(this._mouseMoveListener){_1.disconnect(this._mouseMoveListener);this._mouseMoveListener=null;_1.disconnect(this._mouseDownListener);this._mouseDownListener=null;}if(this._onDragStartListener){_1.disconnect(this._onDragStartListener);this._onDragStartListener=null;_1.disconnect(this._onSelectStartListener);this._onSelectStartListener=null;}},_mouseClickHandler:function(_c){var _d=this._getFeatureFromMouseEvent(_c);if(_d){_d._onclickHandler(_c);}else{for(var _e in this._map.mapObj.features){this._map.mapObj.features[_e].select(false);}this._map.onFeatureClick(null);}},_mouseDownHandler:function(_f){this._map.focused=true;this._cancelMouseClick=false;this._screenClickLocation.x=_f.pageX;this._screenClickLocation.y=_f.pageY;var _10=this._map._getContainerBounds();var _11=_f.pageX-_10.x,_12=_f.pageY-_10.y;var _13=this._map.screenCoordsToMapCoords(_11,_12);this._mapClickLocation.x=_13.x;this._mapClickLocation.y=_13.y;if(!_1.isIE){this._mouseDragListener=_1.connect(_1.doc,"onmousemove",this,this._mouseDragHandler);this._mouseUpClickListener=this._map.surface.connect("onmouseup",this,this._mouseUpClickHandler);this._mouseUpListener=_1.connect(_1.doc,"onmouseup",this,this._mouseUpHandler);}else{this._mouseDragListener=_1.connect(node,"onmousemove",this,this._mouseDragHandler);this._mouseUpClickListener=this._map.surface.connect("onmouseup",this,this._mouseUpClickHandler);this._mouseUpListener=this._map.surface.connect("onmouseup",this,this._mouseUpHandler);this._map.surface.rawNode.setCapture();}},_mouseUpClickHandler:function(_14){if(!this._cancelMouseClick){this._mouseClickHandler(_14);}this._cancelMouseClick=false;},_mouseUpHandler:function(_15){_1.stopEvent(_15);this._map.mapObj.marker._needTooltipRefresh=true;if(this._mouseDragListener){_1.disconnect(this._mouseDragListener);this._mouseDragListener=null;}if(this._mouseUpClickListener){_1.disconnect(this._mouseUpClickListener);this._mouseUpClickListener=null;}if(this._mouseUpListener){_1.disconnect(this._mouseUpListener);this._mouseUpListener=null;}if(_1.isIE){this._map.surface.rawNode.releaseCapture();}},_getFeatureFromMouseEvent:function(_16){var _17=null;if(_16.gfxTarget&&_16.gfxTarget.getParent){_17=this._map.mapObj.features[_16.gfxTarget.getParent().id];}return _17;},_mouseMoveHandler:function(_18){if(this._mouseDragListener&&this._panEnabled){return;}var _19=this._getFeatureFromMouseEvent(_18);if(_19!=this._currentFeature){if(this._currentFeature){this._currentFeature._onmouseoutHandler();}this._currentFeature=_19;if(_19){_19._onmouseoverHandler();}}if(_19){_19._onmousemoveHandler(_18);}},_mouseDragHandler:function(_1a){_1.stopEvent(_1a);var dx=Math.abs(_1a.pageX-this._screenClickLocation.x);var dy=Math.abs(_1a.pageY-this._screenClickLocation.y);if(!this._cancelMouseClick&&(dx>this.mouseClickThreshold||dy>this.mouseClickThreshold)){this._cancelMouseClick=true;if(this._panEnabled){this._map.mapObj.marker.hide();}}if(!this._panEnabled){return;}var _1b=this._map._getContainerBounds();var _1c=_1a.pageX-_1b.x,_1d=_1a.pageY-_1b.y;var _1e=this._map.screenCoordsToMapCoords(_1c,_1d);var _1f=_1e.x-this._mapClickLocation.x;var _20=_1e.y-this._mapClickLocation.y;var _21=this._map.getMapCenter();this._map.setMapCenter(_21.x-_1f,_21.y-_20);},_mouseWheelHandler:function(_22){_1.stopEvent(_22);this._map.mapObj.marker.hide();var _23=this._map._getContainerBounds();var _24=_22.pageX-_23.x,_25=_22.pageY-_23.y;var _26=this._map.screenCoordsToMapCoords(_24,_25);var _27=_22[(_1.isMozilla?"detail":"wheelDelta")]/(_1.isMozilla?-3:120);var _28=Math.pow(1.2,_27);this._map.setMapScaleAt(this._map.getMapScale()*_28,_26.x,_26.y,false);this._map.mapObj.marker._needTooltipRefresh=true;}});});