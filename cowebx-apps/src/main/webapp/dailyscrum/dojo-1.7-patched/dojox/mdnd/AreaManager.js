/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo","dijit","dojox","dojox/mdnd/Moveable"],function(_1,_2,_3){_1.getObject("dojox.mdnd.AreaManager",1);_1.declare("dojox.mdnd.AreaManager",null,{autoRefresh:true,areaClass:"dojoxDndArea",dragHandleClass:"dojoxDragHandle",constructor:function(){this._areaList=[];this.resizeHandler=_1.connect(_1.global,"onresize",this,function(){this._dropMode.updateAreas(this._areaList);});this._oldIndexArea=this._currentIndexArea=this._oldDropIndex=this._currentDropIndex=this._sourceIndexArea=this._sourceDropIndex=-1;},init:function(){this.registerByClass();},registerByNode:function(_4,_5){var _6=this._getIndexArea(_4);if(_4&&_6==-1){var _7=_4.getAttribute("accept");var _8=(_7)?_7.split(/\s*,\s*/):["text"];var _9={"node":_4,"items":[],"coords":{},"margin":null,"accept":_8,"initItems":false};_1.forEach(this._getChildren(_4),function(_a){this._setMarginArea(_9,_a);_9.items.push(this._addMoveableItem(_a));},this);this._areaList=this._dropMode.addArea(this._areaList,_9);if(!_5){this._dropMode.updateAreas(this._areaList);}_1.publish("/dojox/mdnd/manager/register",[_4]);}},registerByClass:function(){_1.query("."+this.areaClass).forEach(function(_b){this.registerByNode(_b,true);},this);this._dropMode.updateAreas(this._areaList);},unregister:function(_c){var _d=this._getIndexArea(_c);if(_d!=-1){_1.forEach(this._areaList[_d].items,function(_e){this._deleteMoveableItem(_e);},this);this._areaList.splice(_d,1);this._dropMode.updateAreas(this._areaList);return true;}return false;},_addMoveableItem:function(_f){_f.setAttribute("tabIndex","0");var _10=this._searchDragHandle(_f);var _11=new _3.mdnd.Moveable({"handle":_10,"skip":true},_f);_1.addClass(_10||_f,"dragHandle");var _12=_f.getAttribute("dndType");var _13={"item":_11,"type":_12?_12.split(/\s*,\s*/):["text"],"handlers":[_1.connect(_11,"onDragStart",this,"onDragStart")]};if(_2&&_2.byNode){var _14=_2.byNode(_f);if(_14){_13.type=_14.dndType?_14.dndType.split(/\s*,\s*/):["text"];_13.handlers.push(_1.connect(_14,"uninitialize",this,function(){this.removeDragItem(_f.parentNode,_11.node);}));}}return _13;},_deleteMoveableItem:function(_15){_1.forEach(_15.handlers,function(_16){_1.disconnect(_16);});var _17=_15.item.node,_18=this._searchDragHandle(_17);_1.removeClass(_18||_17,"dragHandle");_15.item.destroy();},_getIndexArea:function(_19){if(_19){for(var i=0;i<this._areaList.length;i++){if(this._areaList[i].node===_19){return i;}}}return -1;},_searchDragHandle:function(_1a){if(_1a){var _1b=this.dragHandleClass.split(" "),_1c=_1b.length,_1d="";_1.forEach(_1b,function(css,i){_1d+="."+css;if(i!=_1c-1){_1d+=", ";}});return _1.query(_1d,_1a)[0];}},addDragItem:function(_1e,_1f,_20,_21){var add=true;if(!_21){add=_1e&&_1f&&(_1f.parentNode===null||(_1f.parentNode&&_1f.parentNode.nodeType!==1));}if(add){var _22=this._getIndexArea(_1e);if(_22!==-1){var _23=this._addMoveableItem(_1f),_24=this._areaList[_22].items;if(0<=_20&&_20<_24.length){var _25=_24.slice(0,_20),_26=_24.slice(_20,_24.length);_25[_25.length]=_23;this._areaList[_22].items=_25.concat(_26);_1e.insertBefore(_1f,_24[_20].item.node);}else{this._areaList[_22].items.push(_23);_1e.appendChild(_1f);}this._setMarginArea(this._areaList[_22],_1f);this._areaList[_22].initItems=false;return true;}}return false;},removeDragItem:function(_27,_28){var _29=this._getIndexArea(_27);if(_27&&_29!==-1){var _2a=this._areaList[_29].items;for(var j=0;j<_2a.length;j++){if(_2a[j].item.node===_28){this._deleteMoveableItem(_2a[j]);_2a.splice(j,1);return _27.removeChild(_28);}}}return null;},_getChildren:function(_2b){var _2c=[];_1.forEach(_2b.childNodes,function(_2d){if(_2d.nodeType==1){if(_2&&_2.byNode){var _2e=_2.byNode(_2d);if(_2e){if(!_2e.dragRestriction){_2c.push(_2d);}}else{_2c.push(_2d);}}else{_2c.push(_2d);}}});return _2c;},_setMarginArea:function(_2f,_30){if(_2f&&_2f.margin===null&&_30){_2f.margin=_1._getMarginExtents(_30);}},findCurrentIndexArea:function(_31,_32){this._oldIndexArea=this._currentIndexArea;this._currentIndexArea=this._dropMode.getTargetArea(this._areaList,_31,this._currentIndexArea);if(this._currentIndexArea!=this._oldIndexArea){if(this._oldIndexArea!=-1){this.onDragExit(_31,_32);}if(this._currentIndexArea!=-1){this.onDragEnter(_31,_32);}}return this._currentIndexArea;},_isAccepted:function(_33,_34){this._accept=false;for(var i=0;i<_34.length;++i){for(var j=0;j<_33.length;++j){if(_33[j]==_34[i]){this._accept=true;break;}}}},onDragStart:function(_35,_36,_37){if(this.autoRefresh){this._dropMode.updateAreas(this._areaList);}var _38=(_1.isWebKit)?_1.body():_1.body().parentNode;if(!this._cover){this._cover=_1.create("div",{"class":"dndCover"});this._cover2=_1.clone(this._cover);_1.addClass(this._cover2,"dndCover2");}var h=_38.scrollHeight+"px";this._cover.style.height=this._cover2.style.height=h;_1.body().appendChild(this._cover);_1.body().appendChild(this._cover2);this._dragStartHandler=_1.connect(_35.ownerDocument,"ondragstart",_1,"stopEvent");this._sourceIndexArea=this._lastValidIndexArea=this._currentIndexArea=this._getIndexArea(_35.parentNode);var _39=this._areaList[this._sourceIndexArea];var _3a=_39.items;for(var i=0;i<_3a.length;i++){if(_3a[i].item.node==_35){this._dragItem=_3a[i];this._dragItem.handlers.push(_1.connect(this._dragItem.item,"onDrag",this,"onDrag"));this._dragItem.handlers.push(_1.connect(this._dragItem.item,"onDragEnd",this,"onDrop"));_3a.splice(i,1);this._currentDropIndex=this._sourceDropIndex=i;break;}}var _3b=null;if(this._sourceDropIndex!==_39.items.length){_3b=_39.items[this._sourceDropIndex].item.node;}if(_1.isIE>7){this._eventsIE7=[_1.connect(this._cover,"onmouseover",_1,"stopEvent"),_1.connect(this._cover,"onmouseout",_1,"stopEvent"),_1.connect(this._cover,"onmouseenter",_1,"stopEvent"),_1.connect(this._cover,"onmouseleave",_1,"stopEvent")];}var s=_35.style;s.left=_36.x+"px";s.top=_36.y+"px";if(s.position=="relative"||s.position==""){s.position="absolute";}this._cover.appendChild(_35);this._dropIndicator.place(_39.node,_3b,_37);_1.addClass(_35,"dragNode");this._accept=true;_1.publish("/dojox/mdnd/drag/start",[_35,_39,this._sourceDropIndex]);},onDragEnter:function(_3c,_3d){if(this._currentIndexArea===this._sourceIndexArea){this._accept=true;}else{this._isAccepted(this._dragItem.type,this._areaList[this._currentIndexArea].accept);}},onDragExit:function(_3e,_3f){this._accept=false;},onDrag:function(_40,_41,_42,_43){var _44=this._dropMode.getDragPoint(_41,_42,_43);this.findCurrentIndexArea(_44,_42);if(this._currentIndexArea!==-1&&this._accept){this.placeDropIndicator(_44,_42);}},placeDropIndicator:function(_45,_46){this._oldDropIndex=this._currentDropIndex;var _47=this._areaList[this._currentIndexArea];if(!_47.initItems){this._dropMode.initItems(_47);}this._currentDropIndex=this._dropMode.getDropIndex(_47,_45);if(!(this._currentIndexArea===this._oldIndexArea&&this._oldDropIndex===this._currentDropIndex)){this._placeDropIndicator(_46);}return this._currentDropIndex;},_placeDropIndicator:function(_48){var _49=this._areaList[this._lastValidIndexArea];var _4a=this._areaList[this._currentIndexArea];this._dropMode.refreshItems(_49,this._oldDropIndex,_48,false);var _4b=null;if(this._currentDropIndex!=-1){_4b=_4a.items[this._currentDropIndex].item.node;}this._dropIndicator.place(_4a.node,_4b);this._lastValidIndexArea=this._currentIndexArea;this._dropMode.refreshItems(_4a,this._currentDropIndex,_48,true);},onDropCancel:function(){if(!this._accept){var _4c=this._getIndexArea(this._dropIndicator.node.parentNode);if(_4c!=-1){this._currentIndexArea=_4c;}else{this._currentIndexArea=0;}}},onDrop:function(_4d){this.onDropCancel();var _4e=this._areaList[this._currentIndexArea];_1.removeClass(_4d,"dragNode");var _4f=_4d.style;_4f.position="relative";_4f.left="0";_4f.top="0";_4f.width="auto";if(_4e.node==this._dropIndicator.node.parentNode){_4e.node.insertBefore(_4d,this._dropIndicator.node);}else{_4e.node.appendChild(_4d);this._currentDropIndex=_4e.items.length;}var _50=this._currentDropIndex;if(_50==-1){_50=_4e.items.length;}var _51=_4e.items;var _52=_51.slice(0,_50);var _53=_51.slice(_50,_51.length);_52[_52.length]=this._dragItem;_4e.items=_52.concat(_53);this._setMarginArea(_4e,_4d);_1.forEach(this._areaList,function(obj){obj.initItems=false;});_1.disconnect(this._dragItem.handlers.pop());_1.disconnect(this._dragItem.handlers.pop());this._resetAfterDrop();if(this._cover){_1.body().removeChild(this._cover);_1.body().removeChild(this._cover2);}_1.publish("/dojox/mdnd/drop",[_4d,_4e,_50]);},_resetAfterDrop:function(){this._accept=false;this._dragItem=null;this._currentDropIndex=-1;this._currentIndexArea=-1;this._oldDropIndex=-1;this._sourceIndexArea=-1;this._sourceDropIndex=-1;this._dropIndicator.remove();if(this._dragStartHandler){_1.disconnect(this._dragStartHandler);}if(_1.isIE>7){_1.forEach(this._eventsIE7,_1.disconnect);}},destroy:function(){while(this._areaList.length>0){if(!this.unregister(this._areaList[0].node)){throw new Error("Error while destroying AreaManager");}}_1.disconnect(this.resizeHandler);this._dropIndicator.destroy();this._dropMode.destroy();if(_3.mdnd.autoScroll){_3.mdnd.autoScroll.destroy();}if(this.refreshListener){_1.unsubscribe(this.refreshListener);}if(this._cover){_1._destroyElement(this._cover);_1._destroyElement(this._cover2);delete this._cover;delete this._cover2;}}});if(_2&&_2._Widget){_1.extend(_2._Widget,{dndType:"text"});}_3.mdnd._areaManager=null;_3.mdnd.areaManager=function(){if(!_3.mdnd._areaManager){_3.mdnd._areaManager=new _3.mdnd.AreaManager();}return _3.mdnd._areaManager;};});require(["dojox/mdnd/AreaManager"]);