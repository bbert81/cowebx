/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo","dijit","dojox","dojo/dnd/Source","dojo/dnd/Manager","dijit/_TemplatedMixin","dijit/_Widget","dojox/html/metrics","./_Builder","./util"],function(_1,_2,_3){(function(){var _4=function(_5,_6){return _5.style.cssText==undefined?_5.getAttribute("style"):_5.style.cssText;};_1.declare("dojox.grid._View",[_2._Widget,_2._TemplatedMixin],{defaultWidth:"18em",viewWidth:"",templatePath:_1.moduleUrl("dojox.grid","resources/View.html"),themeable:false,classTag:"dojoxGrid",marginBottom:0,rowPad:2,_togglingColumn:-1,_headerBuilderClass:_3.grid._HeaderBuilder,_contentBuilderClass:_3.grid._ContentBuilder,postMixInProperties:function(){this.rowNodes={};},postCreate:function(){this.connect(this.scrollboxNode,"onscroll","doscroll");_3.grid.util.funnelEvents(this.contentNode,this,"doContentEvent",["mouseover","mouseout","click","dblclick","contextmenu","mousedown"]);_3.grid.util.funnelEvents(this.headerNode,this,"doHeaderEvent",["dblclick","mouseover","mouseout","mousemove","mousedown","click","contextmenu"]);this.content=new this._contentBuilderClass(this);this.header=new this._headerBuilderClass(this);if(!_1._isBodyLtr()){this.headerNodeContainer.style.width="";}},destroy:function(){_1.destroy(this.headerNode);delete this.headerNode;for(var i in this.rowNodes){_1.destroy(this.rowNodes[i]);}this.rowNodes={};if(this.source){this.source.destroy();}this.inherited(arguments);},focus:function(){if(_1.isIE||_1.isWebKit||_1.isOpera){this.hiddenFocusNode.focus();}else{this.scrollboxNode.focus();}},setStructure:function(_7){var vs=(this.structure=_7);if(vs.width&&!isNaN(vs.width)){this.viewWidth=vs.width+"em";}else{this.viewWidth=vs.width||(vs.noscroll?"auto":this.viewWidth);}this._onBeforeRow=vs.onBeforeRow||function(){};this._onAfterRow=vs.onAfterRow||function(){};this.noscroll=vs.noscroll;if(this.noscroll){this.scrollboxNode.style.overflow="hidden";}this.simpleStructure=Boolean(vs.cells.length==1);this.testFlexCells();this.updateStructure();},_cleanupRowWidgets:function(_8){if(_8){_1.forEach(_1.query("[widgetId]",_8).map(_2.byNode),function(w){if(w._destroyOnRemove){w.destroy();delete w;}else{if(w.domNode&&w.domNode.parentNode){w.domNode.parentNode.removeChild(w.domNode);}}});}},onBeforeRow:function(_9,_a){this._onBeforeRow(_9,_a);if(_9>=0){this._cleanupRowWidgets(this.getRowNode(_9));}},onAfterRow:function(_b,_c,_d){this._onAfterRow(_b,_c,_d);var g=this.grid;_1.forEach(_1.query(".dojoxGridStubNode",_d),function(n){if(n&&n.parentNode){var lw=n.getAttribute("linkWidget");var _e=window.parseInt(_1.attr(n,"cellIdx"),10);var _f=g.getCell(_e);var w=_2.byId(lw);if(w){n.parentNode.replaceChild(w.domNode,n);if(!w._started){w.startup();}}else{n.innerHTML="";}}},this);},testFlexCells:function(){this.flexCells=false;for(var j=0,row;(row=this.structure.cells[j]);j++){for(var i=0,_10;(_10=row[i]);i++){_10.view=this;this.flexCells=this.flexCells||_10.isFlex();}}return this.flexCells;},updateStructure:function(){this.header.update();this.content.update();},getScrollbarWidth:function(){var _11=this.hasVScrollbar();var _12=_1.style(this.scrollboxNode,"overflow");if(this.noscroll||!_12||_12=="hidden"){_11=false;}else{if(_12=="scroll"){_11=true;}}return (_11?_3.html.metrics.getScrollbar().w:0);},getColumnsWidth:function(){var h=this.headerContentNode;return h&&h.firstChild?h.firstChild.offsetWidth:0;},setColumnsWidth:function(_13){this.headerContentNode.firstChild.style.width=_13+"px";if(this.viewWidth){this.viewWidth=_13+"px";}},getWidth:function(){return this.viewWidth||(this.getColumnsWidth()+this.getScrollbarWidth())+"px";},getContentWidth:function(){return Math.max(0,_1._getContentBox(this.domNode).w-this.getScrollbarWidth())+"px";},render:function(){this.scrollboxNode.style.height="";this.renderHeader();if(this._togglingColumn>=0){this.setColumnsWidth(this.getColumnsWidth()-this._togglingColumn);this._togglingColumn=-1;}var _14=this.grid.layout.cells;var _15=_1.hitch(this,function(_16,_17){!_1._isBodyLtr()&&(_17=!_17);var inc=_17?-1:1;var idx=this.header.getCellNodeIndex(_16)+inc;var _18=_14[idx];while(_18&&_18.getHeaderNode()&&_18.getHeaderNode().style.display=="none"){idx+=inc;_18=_14[idx];}if(_18){return _18.getHeaderNode();}return null;});if(this.grid.columnReordering&&this.simpleStructure){if(this.source){this.source.destroy();}var _19="dojoxGrid_bottomMarker";var _1a="dojoxGrid_topMarker";if(this.bottomMarker){_1.destroy(this.bottomMarker);}this.bottomMarker=_1.byId(_19);if(this.topMarker){_1.destroy(this.topMarker);}this.topMarker=_1.byId(_1a);if(!this.bottomMarker){this.bottomMarker=_1.create("div",{"id":_19,"class":"dojoxGridColPlaceBottom"},_1.body());this._hide(this.bottomMarker);this.topMarker=_1.create("div",{"id":_1a,"class":"dojoxGridColPlaceTop"},_1.body());this._hide(this.topMarker);}this.arrowDim=_1.contentBox(this.bottomMarker);var _1b=_1.contentBox(this.headerContentNode.firstChild.rows[0]).h;this.source=new _1.dnd.Source(this.headerContentNode.firstChild.rows[0],{horizontal:true,accept:["gridColumn_"+this.grid.id],viewIndex:this.index,generateText:false,onMouseDown:_1.hitch(this,function(e){this.header.decorateEvent(e);if((this.header.overRightResizeArea(e)||this.header.overLeftResizeArea(e))&&this.header.canResize(e)&&!this.header.moveable){this.header.beginColumnResize(e);}else{if(this.grid.headerMenu){this.grid.headerMenu.onCancel(true);}if(e.button===(_1.isIE?1:0)){_1.dnd.Source.prototype.onMouseDown.call(this.source,e);}}}),onMouseOver:_1.hitch(this,function(e){var src=this.source;if(src._getChildByEvent(e)){_1.dnd.Source.prototype.onMouseOver.apply(src,arguments);}}),_markTargetAnchor:_1.hitch(this,function(_1c){var src=this.source;if(src.current==src.targetAnchor&&src.before==_1c){return;}if(src.targetAnchor&&_15(src.targetAnchor,src.before)){src._removeItemClass(_15(src.targetAnchor,src.before),src.before?"After":"Before");}_1.dnd.Source.prototype._markTargetAnchor.call(src,_1c);var _1d=_1c?src.targetAnchor:_15(src.targetAnchor,src.before);var _1e=0;if(!_1d){_1d=src.targetAnchor;_1e=_1.contentBox(_1d).w+this.arrowDim.w/2+2;}var pos=(_1.position||_1._abs)(_1d,true);var _1f=Math.floor(pos.x-this.arrowDim.w/2+_1e);_1.style(this.bottomMarker,"visibility","visible");_1.style(this.topMarker,"visibility","visible");_1.style(this.bottomMarker,{"left":_1f+"px","top":(_1b+pos.y)+"px"});_1.style(this.topMarker,{"left":_1f+"px","top":(pos.y-this.arrowDim.h)+"px"});if(src.targetAnchor&&_15(src.targetAnchor,src.before)){src._addItemClass(_15(src.targetAnchor,src.before),src.before?"After":"Before");}}),_unmarkTargetAnchor:_1.hitch(this,function(){var src=this.source;if(!src.targetAnchor){return;}if(src.targetAnchor&&_15(src.targetAnchor,src.before)){src._removeItemClass(_15(src.targetAnchor,src.before),src.before?"After":"Before");}this._hide(this.bottomMarker);this._hide(this.topMarker);_1.dnd.Source.prototype._unmarkTargetAnchor.call(src);}),destroy:_1.hitch(this,function(){_1.disconnect(this._source_conn);_1.unsubscribe(this._source_sub);_1.dnd.Source.prototype.destroy.call(this.source);if(this.bottomMarker){_1.destroy(this.bottomMarker);delete this.bottomMarker;}if(this.topMarker){_1.destroy(this.topMarker);delete this.topMarker;}}),onDndCancel:_1.hitch(this,function(){_1.dnd.Source.prototype.onDndCancel.call(this.source);this._hide(this.bottomMarker);this._hide(this.topMarker);})});this._source_conn=_1.connect(this.source,"onDndDrop",this,"_onDndDrop");this._source_sub=_1.subscribe("/dnd/drop/before",this,"_onDndDropBefore");this.source.startup();}},_hide:function(_20){_1.style(_20,{left:"-10000px",top:"-10000px","visibility":"hidden"});},_onDndDropBefore:function(_21,_22,_23){if(_1.dnd.manager().target!==this.source){return;}this.source._targetNode=this.source.targetAnchor;this.source._beforeTarget=this.source.before;var _24=this.grid.views.views;var _25=_24[_21.viewIndex];var _26=_24[this.index];if(_26!=_25){_25.convertColPctToFixed();_26.convertColPctToFixed();}},_onDndDrop:function(_27,_28,_29){if(_1.dnd.manager().target!==this.source){if(_1.dnd.manager().source===this.source){this._removingColumn=true;}return;}this._hide(this.bottomMarker);this._hide(this.topMarker);var _2a=function(n){return n?_1.attr(n,"idx"):null;};var w=_1.marginBox(_28[0]).w;if(_27.viewIndex!==this.index){var _2b=this.grid.views.views;var _2c=_2b[_27.viewIndex];var _2d=_2b[this.index];if(_2c.viewWidth&&_2c.viewWidth!="auto"){_2c.setColumnsWidth(_2c.getColumnsWidth()-w);}if(_2d.viewWidth&&_2d.viewWidth!="auto"){_2d.setColumnsWidth(_2d.getColumnsWidth());}}var stn=this.source._targetNode;var stb=this.source._beforeTarget;!_1._isBodyLtr()&&(stb=!stb);var _2e=this.grid.layout;var idx=this.index;delete this.source._targetNode;delete this.source._beforeTarget;_2e.moveColumn(_27.viewIndex,idx,_2a(_28[0]),_2a(stn),stb);},renderHeader:function(){this.headerContentNode.innerHTML=this.header.generateHtml(this._getHeaderContent);if(this.flexCells){this.contentWidth=this.getContentWidth();this.headerContentNode.firstChild.style.width=this.contentWidth;}_3.grid.util.fire(this,"onAfterRow",[-1,this.structure.cells,this.headerContentNode]);},_getHeaderContent:function(_2f){var n=_2f.name||_2f.grid.getCellName(_2f);var ret=["<div class=\"dojoxGridSortNode"];if(_2f.index!=_2f.grid.getSortIndex()){ret.push("\">");}else{ret=ret.concat([" ",_2f.grid.sortInfo>0?"dojoxGridSortUp":"dojoxGridSortDown","\"><div class=\"dojoxGridArrowButtonChar\">",_2f.grid.sortInfo>0?"&#9650;":"&#9660;","</div><div class=\"dojoxGridArrowButtonNode\" role=\"presentation\"></div>","<div class=\"dojoxGridColCaption\">"]);}ret=ret.concat([n,"</div></div>"]);return ret.join("");},resize:function(){this.adaptHeight();this.adaptWidth();},hasHScrollbar:function(_30){var _31=this._hasHScroll||false;if(this._hasHScroll==undefined||_30){if(this.noscroll){this._hasHScroll=false;}else{var _32=_1.style(this.scrollboxNode,"overflow");if(_32=="hidden"){this._hasHScroll=false;}else{if(_32=="scroll"){this._hasHScroll=true;}else{this._hasHScroll=(this.scrollboxNode.offsetWidth-this.getScrollbarWidth()<this.contentNode.offsetWidth);}}}}if(_31!==this._hasHScroll){this.grid.update();}return this._hasHScroll;},hasVScrollbar:function(_33){var _34=this._hasVScroll||false;if(this._hasVScroll==undefined||_33){if(this.noscroll){this._hasVScroll=false;}else{var _35=_1.style(this.scrollboxNode,"overflow");if(_35=="hidden"){this._hasVScroll=false;}else{if(_35=="scroll"){this._hasVScroll=true;}else{this._hasVScroll=(this.scrollboxNode.scrollHeight>this.scrollboxNode.clientHeight);}}}}if(_34!==this._hasVScroll){this.grid.update();}return this._hasVScroll;},convertColPctToFixed:function(){var _36=false;this.grid.initialWidth="";var _37=_1.query("th",this.headerContentNode);var _38=_1.map(_37,function(c,_39){var w=c.style.width;_1.attr(c,"vIdx",_39);if(w&&w.slice(-1)=="%"){_36=true;}else{if(w&&w.slice(-2)=="px"){return window.parseInt(w,10);}}return _1.contentBox(c).w;});if(_36){_1.forEach(this.grid.layout.cells,function(_3a,idx){if(_3a.view==this){var _3b=_3a.view.getHeaderCellNode(_3a.index);if(_3b&&_1.hasAttr(_3b,"vIdx")){var _3c=window.parseInt(_1.attr(_3b,"vIdx"));this.setColWidth(idx,_38[_3c]);_1.removeAttr(_3b,"vIdx");}}},this);return true;}return false;},adaptHeight:function(_3d){if(!this.grid._autoHeight){var h=(this.domNode.style.height&&parseInt(this.domNode.style.height.replace(/px/,""),10))||this.domNode.clientHeight;var _3e=this;var _3f=function(){var v;for(var i in _3e.grid.views.views){v=_3e.grid.views.views[i];if(v!==_3e&&v.hasHScrollbar()){return true;}}return false;};if(_3d||(this.noscroll&&_3f())){h-=_3.html.metrics.getScrollbar().h;}_3.grid.util.setStyleHeightPx(this.scrollboxNode,h);}this.hasVScrollbar(true);},adaptWidth:function(){if(this.flexCells){this.contentWidth=this.getContentWidth();this.headerContentNode.firstChild.style.width=this.contentWidth;}var w=this.scrollboxNode.offsetWidth-this.getScrollbarWidth();if(!this._removingColumn){w=Math.max(w,this.getColumnsWidth())+"px";}else{w=Math.min(w,this.getColumnsWidth())+"px";this._removingColumn=false;}var cn=this.contentNode;cn.style.width=w;this.hasHScrollbar(true);},setSize:function(w,h){var ds=this.domNode.style;var hs=this.headerNode.style;if(w){ds.width=w;hs.width=w;}ds.height=(h>=0?h+"px":"");},renderRow:function(_40){var _41=this.createRowNode(_40);this.buildRow(_40,_41);return _41;},createRowNode:function(_42){var _43=document.createElement("div");_43.className=this.classTag+"Row";if(this instanceof _3.grid._RowSelector){_1.attr(_43,"role","presentation");}else{_1.attr(_43,"role","row");if(this.grid.selectionMode!="none"){_1.attr(_43,"aria-selected","false");}}_43[_3.grid.util.gridViewTag]=this.id;_43[_3.grid.util.rowIndexTag]=_42;this.rowNodes[_42]=_43;return _43;},buildRow:function(_44,_45){this.buildRowContent(_44,_45);this.styleRow(_44,_45);},buildRowContent:function(_46,_47){_47.innerHTML=this.content.generateHtml(_46,_46);if(this.flexCells&&this.contentWidth){_47.firstChild.style.width=this.contentWidth;}_3.grid.util.fire(this,"onAfterRow",[_46,this.structure.cells,_47]);},rowRemoved:function(_48){if(_48>=0){this._cleanupRowWidgets(this.getRowNode(_48));}this.grid.edit.save(this,_48);delete this.rowNodes[_48];},getRowNode:function(_49){return this.rowNodes[_49];},getCellNode:function(_4a,_4b){var row=this.getRowNode(_4a);if(row){return this.content.getCellNode(row,_4b);}},getHeaderCellNode:function(_4c){if(this.headerContentNode){return this.header.getCellNode(this.headerContentNode,_4c);}},styleRow:function(_4d,_4e){_4e._style=_4(_4e);this.styleRowNode(_4d,_4e);},styleRowNode:function(_4f,_50){if(_50){this.doStyleRowNode(_4f,_50);}},doStyleRowNode:function(_51,_52){this.grid.styleRowNode(_51,_52);},updateRow:function(_53){var _54=this.getRowNode(_53);if(_54){_54.style.height="";this.buildRow(_53,_54);}return _54;},updateRowStyles:function(_55){this.styleRowNode(_55,this.getRowNode(_55));},lastTop:0,firstScroll:0,doscroll:function(_56){var _57=_1._isBodyLtr();if(this.firstScroll<2){if((!_57&&this.firstScroll==1)||(_57&&this.firstScroll===0)){var s=_1.marginBox(this.headerNodeContainer);if(_1.isIE){this.headerNodeContainer.style.width=s.w+this.getScrollbarWidth()+"px";}else{if(_1.isMoz){this.headerNodeContainer.style.width=s.w-this.getScrollbarWidth()+"px";this.scrollboxNode.scrollLeft=_57?this.scrollboxNode.clientWidth-this.scrollboxNode.scrollWidth:this.scrollboxNode.scrollWidth-this.scrollboxNode.clientWidth;}}}this.firstScroll++;}this.headerNode.scrollLeft=this.scrollboxNode.scrollLeft;var top=this.scrollboxNode.scrollTop;if(top!==this.lastTop){this.grid.scrollTo(top);}},setScrollTop:function(_58){this.lastTop=_58;this.scrollboxNode.scrollTop=_58;return this.scrollboxNode.scrollTop;},doContentEvent:function(e){if(this.content.decorateEvent(e)){this.grid.onContentEvent(e);}},doHeaderEvent:function(e){if(this.header.decorateEvent(e)){this.grid.onHeaderEvent(e);}},dispatchContentEvent:function(e){return this.content.dispatchEvent(e);},dispatchHeaderEvent:function(e){return this.header.dispatchEvent(e);},setColWidth:function(_59,_5a){this.grid.setCellWidth(_59,_5a+"px");},update:function(){if(!this.domNode){return;}this.content.update();this.grid.update();var _5b=this.scrollboxNode.scrollLeft;this.scrollboxNode.scrollLeft=_5b;this.headerNode.scrollLeft=_5b;}});_1.declare("dojox.grid._GridAvatar",_1.dnd.Avatar,{construct:function(){var dd=_1.doc;var a=dd.createElement("table");a.cellPadding=a.cellSpacing="0";a.className="dojoxGridDndAvatar";a.style.position="absolute";a.style.zIndex=1999;a.style.margin="0px";var b=dd.createElement("tbody");var tr=dd.createElement("tr");var td=dd.createElement("td");var img=dd.createElement("td");tr.className="dojoxGridDndAvatarItem";img.className="dojoxGridDndAvatarItemImage";img.style.width="16px";var _5c=this.manager.source,_5d;if(_5c.creator){_5d=_5c._normalizedCreator(_5c.getItem(this.manager.nodes[0].id).data,"avatar").node;}else{_5d=this.manager.nodes[0].cloneNode(true);var _5e,_5f;if(_5d.tagName.toLowerCase()=="tr"){_5e=dd.createElement("table");_5f=dd.createElement("tbody");_5f.appendChild(_5d);_5e.appendChild(_5f);_5d=_5e;}else{if(_5d.tagName.toLowerCase()=="th"){_5e=dd.createElement("table");_5f=dd.createElement("tbody");var r=dd.createElement("tr");_5e.cellPadding=_5e.cellSpacing="0";r.appendChild(_5d);_5f.appendChild(r);_5e.appendChild(_5f);_5d=_5e;}}}_5d.id="";td.appendChild(_5d);tr.appendChild(img);tr.appendChild(td);_1.style(tr,"opacity",0.9);b.appendChild(tr);a.appendChild(b);this.node=a;var m=_1.dnd.manager();this.oldOffsetY=m.OFFSET_Y;m.OFFSET_Y=1;},destroy:function(){_1.dnd.manager().OFFSET_Y=this.oldOffsetY;this.inherited(arguments);}});var _60=_1.dnd.manager().makeAvatar;_1.dnd.manager().makeAvatar=function(){var src=this.source;if(src.viewIndex!==undefined&&!_1.hasClass(_1.body(),"dijit_a11y")){return new _3.grid._GridAvatar(this);}return _60.call(_1.dnd.manager());};})();return _3.grid._View;});