/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo","dojox","./_Grid","./DataSelection"],function(_1,_2){_1.declare("dojox.grid.DataGrid",_2.grid._Grid,{store:null,query:null,queryOptions:null,fetchText:"...",sortFields:null,updateDelay:1,items:null,_store_connects:null,_by_idty:null,_by_idx:null,_cache:null,_pages:null,_pending_requests:null,_bop:-1,_eop:-1,_requests:0,rowCount:0,_isLoaded:false,_isLoading:false,postCreate:function(){this._pages=[];this._store_connects=[];this._by_idty={};this._by_idx=[];this._cache=[];this._pending_requests={};this._setStore(this.store);this.inherited(arguments);},createSelection:function(){this.selection=new _2.grid.DataSelection(this);},get:function(_3,_4){if(_4&&this.field=="_item"&&!this.fields){return _4;}else{if(_4&&this.fields){var _5=[];var s=this.grid.store;_1.forEach(this.fields,function(f){_5=_5.concat(s.getValues(_4,f));});return _5;}else{if(!_4&&typeof _3==="string"){return this.inherited(arguments);}}}return (!_4?this.defaultValue:(!this.field?this.value:(this.field=="_item"?_4:this.grid.store.getValue(_4,this.field))));},_checkUpdateStatus:function(){if(this.updateDelay>0){var _6=false;if(this._endUpdateDelay){clearTimeout(this._endUpdateDelay);delete this._endUpdateDelay;_6=true;}if(!this.updating){this.beginUpdate();_6=true;}if(_6){var _7=this;this._endUpdateDelay=setTimeout(function(){delete _7._endUpdateDelay;_7.endUpdate();},this.updateDelay);}}},_onSet:function(_8,_9,_a,_b){this._checkUpdateStatus();var _c=this.getItemIndex(_8);if(_c>-1){this.updateRow(_c);}},_createItem:function(_d,_e){var _f=this._hasIdentity?this.store.getIdentity(_d):_1.toJson(this.query)+":idx:"+_e+":sort:"+_1.toJson(this.getSortProps());var o=this._by_idty[_f]={idty:_f,item:_d};return o;},_addItem:function(_10,_11,_12){this._by_idx[_11]=this._createItem(_10,_11);if(!_12){this.updateRow(_11);}},_onNew:function(_13,_14){this._checkUpdateStatus();var _15=this.get("rowCount");this._addingItem=true;this.updateRowCount(_15+1);this._addingItem=false;this._addItem(_13,_15);this.showMessage();},_onDelete:function(_16){this._checkUpdateStatus();var idx=this._getItemIndex(_16,true);if(idx>=0){this._pages=[];this._bop=-1;this._eop=-1;var o=this._by_idx[idx];this._by_idx.splice(idx,1);delete this._by_idty[o.idty];this.updateRowCount(this.get("rowCount")-1);if(this.get("rowCount")===0){this.showMessage(this.noDataMessage);}}},_onRevert:function(){this._refresh();},setStore:function(_17,_18,_19){this._setQuery(_18,_19);this._setStore(_17);this._refresh(true);},setQuery:function(_1a,_1b){this._setQuery(_1a,_1b);this._refresh(true);},setItems:function(_1c){this.items=_1c;this._setStore(this.store);this._refresh(true);},_setQuery:function(_1d,_1e){this.query=_1d;this.queryOptions=_1e||this.queryOptions;},_setStore:function(_1f){if(this.store&&this._store_connects){_1.forEach(this._store_connects,this.disconnect,this);}this.store=_1f;if(this.store){var f=this.store.getFeatures();var h=[];this._canEdit=!!f["dojo.data.api.Write"]&&!!f["dojo.data.api.Identity"];this._hasIdentity=!!f["dojo.data.api.Identity"];if(!!f["dojo.data.api.Notification"]&&!this.items){h.push(this.connect(this.store,"onSet","_onSet"));h.push(this.connect(this.store,"onNew","_onNew"));h.push(this.connect(this.store,"onDelete","_onDelete"));}if(this._canEdit){h.push(this.connect(this.store,"revert","_onRevert"));}this._store_connects=h;}},_onFetchBegin:function(_20,req){if(!this.scroller){return;}if(this.rowCount!=_20){if(req.isRender){this.scroller.init(_20,this.keepRows,this.rowsPerPage);this.rowCount=_20;this._setAutoHeightAttr(this.autoHeight,true);this._skipRowRenormalize=true;this.prerender();this._skipRowRenormalize=false;}else{this.updateRowCount(_20);}}if(!_20){this.views.render();this._resize();this.showMessage(this.noDataMessage);this.focus.initFocusView();}else{this.showMessage();}},_onFetchComplete:function(_21,req){if(!this.scroller){return;}if(_21&&_21.length>0){_1.forEach(_21,function(_22,idx){this._addItem(_22,req.start+idx,true);},this);this.updateRows(req.start,_21.length);if(req.isRender){this.setScrollTop(0);this.postrender();}else{if(this._lastScrollTop){this.setScrollTop(this._lastScrollTop);}}}delete this._lastScrollTop;if(!this._isLoaded){this._isLoading=false;this._isLoaded=true;}this._pending_requests[req.start]=false;},_onFetchError:function(err,req){delete this._lastScrollTop;if(!this._isLoaded){this._isLoading=false;this._isLoaded=true;this.showMessage(this.errorMessage);}this._pending_requests[req.start]=false;this.onFetchError(err,req);},onFetchError:function(err,req){},_fetch:function(_23,_24){_23=_23||0;if(this.store&&!this._pending_requests[_23]){if(!this._isLoaded&&!this._isLoading){this._isLoading=true;this.showMessage(this.loadingMessage);}this._pending_requests[_23]=true;try{if(this.items){var _25=this.items;var _26=this.store;this.rowsPerPage=_25.length;var req={start:_23,count:this.rowsPerPage,isRender:_24};this._onFetchBegin(_25.length,req);var _27=0;_1.forEach(_25,function(i){if(!_26.isItemLoaded(i)){_27++;}});if(_27===0){this._onFetchComplete(_25,req);}else{var _28=function(_29){_27--;if(_27===0){this._onFetchComplete(_25,req);}};_1.forEach(_25,function(i){if(!_26.isItemLoaded(i)){_26.loadItem({item:i,onItem:_28,scope:this});}},this);}}else{this.store.fetch({start:_23,count:this.rowsPerPage,query:this.query,sort:this.getSortProps(),queryOptions:this.queryOptions,isRender:_24,onBegin:_1.hitch(this,"_onFetchBegin"),onComplete:_1.hitch(this,"_onFetchComplete"),onError:_1.hitch(this,"_onFetchError")});}}catch(e){this._onFetchError(e,{start:_23,count:this.rowsPerPage});}}},_clearData:function(){this.updateRowCount(0);this._by_idty={};this._by_idx=[];this._pages=[];this._bop=this._eop=-1;this._isLoaded=false;this._isLoading=false;},getItem:function(idx){var _2a=this._by_idx[idx];if(!_2a||(_2a&&!_2a.item)){this._preparePage(idx);return null;}return _2a.item;},getItemIndex:function(_2b){return this._getItemIndex(_2b,false);},_getItemIndex:function(_2c,_2d){if(!_2d&&!this.store.isItem(_2c)){return -1;}var _2e=this._hasIdentity?this.store.getIdentity(_2c):null;for(var i=0,l=this._by_idx.length;i<l;i++){var d=this._by_idx[i];if(d&&((_2e&&d.idty==_2e)||(d.item===_2c))){return i;}}return -1;},filter:function(_2f,_30){this.query=_2f;if(_30){this._clearData();}this._fetch();},_getItemAttr:function(idx,_31){var _32=this.getItem(idx);return (!_32?this.fetchText:this.store.getValue(_32,_31));},_render:function(){if(this.domNode.parentNode){this.scroller.init(this.get("rowCount"),this.keepRows,this.rowsPerPage);this.prerender();this._fetch(0,true);}},_requestsPending:function(_33){return this._pending_requests[_33];},_rowToPage:function(_34){return (this.rowsPerPage?Math.floor(_34/this.rowsPerPage):_34);},_pageToRow:function(_35){return (this.rowsPerPage?this.rowsPerPage*_35:_35);},_preparePage:function(_36){if((_36<this._bop||_36>=this._eop)&&!this._addingItem){var _37=this._rowToPage(_36);this._needPage(_37);this._bop=_37*this.rowsPerPage;this._eop=this._bop+(this.rowsPerPage||this.get("rowCount"));}},_needPage:function(_38){if(!this._pages[_38]){this._pages[_38]=true;this._requestPage(_38);}},_requestPage:function(_39){var row=this._pageToRow(_39);var _3a=Math.min(this.rowsPerPage,this.get("rowCount")-row);if(_3a>0){this._requests++;if(!this._requestsPending(row)){setTimeout(_1.hitch(this,"_fetch",row,false),1);}}},getCellName:function(_3b){return _3b.field;},_refresh:function(_3c){this._clearData();this._fetch(0,_3c);},sort:function(){this.edit.apply();this._lastScrollTop=this.scrollTop;this._refresh();},canSort:function(){return (!this._isLoading);},getSortProps:function(){var c=this.getCell(this.getSortIndex());if(!c){if(this.sortFields){return this.sortFields;}return null;}else{var _3d=c["sortDesc"];var si=!(this.sortInfo>0);if(typeof _3d=="undefined"){_3d=si;}else{_3d=si?!_3d:_3d;}return [{attribute:c.field,descending:_3d}];}},styleRowState:function(_3e){if(this.store&&this.store.getState){var _3f=this.store.getState(_3e.index),c="";for(var i=0,ss=["inflight","error","inserting"],s;s=ss[i];i++){if(_3f[s]){c=" dojoxGridRow-"+s;break;}}_3e.customClasses+=c;}},onStyleRow:function(_40){this.styleRowState(_40);this.inherited(arguments);},canEdit:function(_41,_42){return this._canEdit;},_copyAttr:function(idx,_43){var row={};var _44={};var src=this.getItem(idx);return this.store.getValue(src,_43);},doStartEdit:function(_45,_46){if(!this._cache[_46]){this._cache[_46]=this._copyAttr(_46,_45.field);}this.onStartEdit(_45,_46);},doApplyCellEdit:function(_47,_48,_49){this.store.fetchItemByIdentity({identity:this._by_idx[_48].idty,onItem:_1.hitch(this,function(_4a){var _4b=this.store.getValue(_4a,_49);if(typeof _4b=="number"){_47=isNaN(_47)?_47:parseFloat(_47);}else{if(typeof _4b=="boolean"){_47=_47=="true"?true:_47=="false"?false:_47;}else{if(_4b instanceof Date){var _4c=new Date(_47);_47=isNaN(_4c.getTime())?_47:_4c;}}}this.store.setValue(_4a,_49,_47);this.onApplyCellEdit(_47,_48,_49);})});},doCancelEdit:function(_4d){var _4e=this._cache[_4d];if(_4e){this.updateRow(_4d);delete this._cache[_4d];}this.onCancelEdit.apply(this,arguments);},doApplyEdit:function(_4f,_50){var _51=this._cache[_4f];this.onApplyEdit(_4f);},removeSelectedRows:function(){if(this._canEdit){this.edit.apply();var fx=_1.hitch(this,function(_52){if(_52.length){_1.forEach(_52,this.store.deleteItem,this.store);this.selection.clear();}});if(this.allItemsSelected){this.store.fetch({query:this.query,queryOptions:this.queryOptions,onComplete:fx});}else{fx(this.selection.getSelected());}}}});_2.grid.DataGrid.cell_markupFactory=function(_53,_54,_55){var _56=_1.trim(_1.attr(_54,"field")||"");if(_56){_55.field=_56;}_55.field=_55.field||_55.name;var _57=_1.trim(_1.attr(_54,"fields")||"");if(_57){_55.fields=_57.split(",");}if(_53){_53(_54,_55);}};_2.grid.DataGrid.markupFactory=function(_58,_59,_5a,_5b){return _2.grid._Grid.markupFactory(_58,_59,_5a,_1.partial(_2.grid.DataGrid.cell_markupFactory,_5b));};return _2.grid.DataGrid;});