/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo","dijit","dojox","dojo/window","dijit/Dialog","dojox/fx/_base"],function(_1,_2,_3){_1.getObject("dojox.image.Lightbox",1);_1.experimental("dojox.image.Lightbox");_1.declare("dojox.image.Lightbox",_2._Widget,{group:"",title:"",href:"",duration:500,modal:false,_allowPassthru:false,_attachedDialog:null,startup:function(){this.inherited(arguments);var _4=_2.byId("dojoxLightboxDialog");if(_4){this._attachedDialog=_4;}else{this._attachedDialog=new _3.image.LightboxDialog({id:"dojoxLightboxDialog"});this._attachedDialog.startup();}if(!this.store){this._addSelf();this.connect(this.domNode,"onclick","_handleClick");}},_addSelf:function(){this._attachedDialog.addImage({href:this.href,title:this.title},this.group||null);},_handleClick:function(e){if(!this._allowPassthru){e.preventDefault();}else{return;}this.show();},show:function(){this._attachedDialog.show(this);},hide:function(){this._attachedDialog.hide();},disable:function(){this._allowPassthru=true;},enable:function(){this._allowPassthru=false;},onClick:function(){},destroy:function(){this._attachedDialog.removeImage(this);this.inherited(arguments);}});_1.declare("dojox.image.LightboxDialog",_2.Dialog,{title:"",inGroup:null,imgUrl:_2._Widget.prototype._blankGif,errorMessage:"Image not found.",adjust:true,modal:false,errorImg:_1.moduleUrl("dojox.image","resources/images/warning.png"),templateString:_1.cache("dojox.image","resources/Lightbox.html"),constructor:function(_5){this._groups=this._groups||(_5&&_5._groups)||{XnoGroupX:[]};},startup:function(){this.inherited(arguments);this._animConnects=[];this.connect(this.nextButtonNode,"onclick","_nextImage");this.connect(this.prevButtonNode,"onclick","_prevImage");this.connect(this.closeButtonNode,"onclick","hide");this._makeAnims();this._vp=_1.window.getBox();return this;},show:function(_6){var _7=this;this._lastGroup=_6;if(!_7.open){_7.inherited(arguments);_7._modalconnects.push(_1.connect(_1.global,"onscroll",this,"_position"),_1.connect(_1.global,"onresize",this,"_position"),_1.connect(_1.body(),"onkeypress",this,"_handleKey"));if(!_6.modal){_7._modalconnects.push(_1.connect(_2._underlay.domNode,"onclick",this,"onCancel"));}}if(this._wasStyled){var _8=_1.create("img",null,_7.imgNode,"after");_1.destroy(_7.imgNode);_7.imgNode=_8;_7._makeAnims();_7._wasStyled=false;}_1.style(_7.imgNode,"opacity","0");_1.style(_7.titleNode,"opacity","0");var _9=_6.href;if((_6.group&&_6!=="XnoGroupX")||_7.inGroup){if(!_7.inGroup){_7.inGroup=_7._groups[(_6.group)];_1.forEach(_7.inGroup,function(g,i){if(g.href==_6.href){_7._index=i;}});}if(!_7._index){_7._index=0;var sr=_7.inGroup[_7._index];_9=(sr&&sr.href)||_7.errorImg;}_7.groupCount.innerHTML=" ("+(_7._index+1)+" of "+Math.max(1,_7.inGroup.length)+")";_7.prevButtonNode.style.visibility="visible";_7.nextButtonNode.style.visibility="visible";}else{_7.groupCount.innerHTML="";_7.prevButtonNode.style.visibility="hidden";_7.nextButtonNode.style.visibility="hidden";}if(!_6.leaveTitle){_7.textNode.innerHTML=_6.title;}_7._ready(_9);},_ready:function(_a){var _b=this;_b._imgError=_1.connect(_b.imgNode,"error",_b,function(){_1.disconnect(_b._imgError);_b.imgNode.src=_b.errorImg;_b.textNode.innerHTML=_b.errorMessage;});_b._imgConnect=_1.connect(_b.imgNode,"load",_b,function(e){_b.resizeTo({w:_b.imgNode.width,h:_b.imgNode.height,duration:_b.duration});_1.disconnect(_b._imgConnect);if(_b._imgError){_1.disconnect(_b._imgError);}});_b.imgNode.src=_a;},_nextImage:function(){if(!this.inGroup){return;}if(this._index+1<this.inGroup.length){this._index++;}else{this._index=0;}this._loadImage();},_prevImage:function(){if(this.inGroup){if(this._index==0){this._index=this.inGroup.length-1;}else{this._index--;}this._loadImage();}},_loadImage:function(){this._loadingAnim.play(1);},_prepNodes:function(){this._imageReady=false;if(this.inGroup&&this.inGroup[this._index]){this.show({href:this.inGroup[this._index].href,title:this.inGroup[this._index].title});}else{this.show({title:this.errorMessage,href:this.errorImg});}},_calcTitleSize:function(){var _c=_1.map(_1.query("> *",this.titleNode).position(),function(s){return s.h;});return {h:Math.max.apply(Math,_c)};},resizeTo:function(_d,_e){var _f=_1.boxModel=="border-box"?_1._getBorderExtents(this.domNode).w:0,_10=_e||this._calcTitleSize();this._lastTitleSize=_10;if(this.adjust&&(_d.h+_10.h+_f+80>this._vp.h||_d.w+_f+60>this._vp.w)){this._lastSize=_d;_d=this._scaleToFit(_d);}this._currentSize=_d;var _11=_3.fx.sizeTo({node:this.containerNode,duration:_d.duration||this.duration,width:_d.w+_f,height:_d.h+_10.h+_f});this.connect(_11,"onEnd","_showImage");_11.play(15);},_scaleToFit:function(_12){var ns={},nvp={w:this._vp.w-80,h:this._vp.h-60-this._lastTitleSize.h};var _13=nvp.w/nvp.h,_14=_12.w/_12.h;if(_14>=_13){ns.h=nvp.w/_14;ns.w=nvp.w;}else{ns.w=_14*nvp.h;ns.h=nvp.h;}this._wasStyled=true;this._setImageSize(ns);ns.duration=_12.duration;return ns;},_setImageSize:function(_15){var s=this.imgNode;s.height=_15.h;s.width=_15.w;},_size:function(){},_position:function(e){this._vp=_1.window.getBox();this.inherited(arguments);if(e&&e.type=="resize"){if(this._wasStyled){this._setImageSize(this._lastSize);this.resizeTo(this._lastSize);}else{if(this.imgNode.height+80>this._vp.h||this.imgNode.width+60>this._vp.h){this.resizeTo({w:this.imgNode.width,h:this.imgNode.height});}}}},_showImage:function(){this._showImageAnim.play(1);},_showNav:function(){var _16=_1.marginBox(this.titleNode);if(_16.h>this._lastTitleSize.h){this.resizeTo(this._wasStyled?this._lastSize:this._currentSize,_16);}else{this._showNavAnim.play(1);}},hide:function(){_1.fadeOut({node:this.titleNode,duration:200,onEnd:_1.hitch(this,function(){this.imgNode.src=this._blankGif;})}).play(5);this.inherited(arguments);this.inGroup=null;this._index=null;},addImage:function(_17,_18){var g=_18;if(!_17.href){return;}if(g){if(!this._groups[g]){this._groups[g]=[];}this._groups[g].push(_17);}else{this._groups["XnoGroupX"].push(_17);}},removeImage:function(_19){var g=_19.group||"XnoGroupX";_1.every(this._groups[g],function(_1a,i,ar){if(_1a.href==_19.href){ar.splice(i,1);return false;}return true;});},removeGroup:function(_1b){if(this._groups[_1b]){this._groups[_1b]=[];}},_handleKey:function(e){if(!this.open){return;}var dk=_1.keys;switch(e.charOrCode){case dk.ESCAPE:this.hide();break;case dk.DOWN_ARROW:case dk.RIGHT_ARROW:case 78:this._nextImage();break;case dk.UP_ARROW:case dk.LEFT_ARROW:case 80:this._prevImage();break;}},_makeAnims:function(){_1.forEach(this._animConnects,_1.disconnect);this._animConnects=[];this._showImageAnim=_1.fadeIn({node:this.imgNode,duration:this.duration});this._animConnects.push(_1.connect(this._showImageAnim,"onEnd",this,"_showNav"));this._loadingAnim=_1.fx.combine([_1.fadeOut({node:this.imgNode,duration:175}),_1.fadeOut({node:this.titleNode,duration:175})]);this._animConnects.push(_1.connect(this._loadingAnim,"onEnd",this,"_prepNodes"));this._showNavAnim=_1.fadeIn({node:this.titleNode,duration:225});},onClick:function(_1c){},_onImageClick:function(e){if(e&&e.target==this.imgNode){this.onClick(this._lastGroup);if(this._lastGroup.declaredClass){this._lastGroup.onClick(this._lastGroup);}}}});});require(["dojox/image/Lightbox"]);