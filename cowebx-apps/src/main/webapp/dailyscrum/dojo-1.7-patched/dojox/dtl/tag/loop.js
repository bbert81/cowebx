/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/lang","../_base","dojox/string/tokenize","dojo/_base/array"],function(_1,dd,_2){_1.getObject("dtl.tag.loop",true,dojox);var _3=dd.tag.loop;_3.CycleNode=_1.extend(function(_4,_5,_6,_7){this.cyclevars=_4;this.name=_5;this.contents=_6;this.shared=_7||{counter:-1,map:{}};},{render:function(_8,_9){if(_8.forloop&&!_8.forloop.counter0){this.shared.counter=-1;}++this.shared.counter;var _a=this.cyclevars[this.shared.counter%this.cyclevars.length];var _b=this.shared.map;if(!_b[_a]){_b[_a]=new dd._Filter(_a);}_a=_b[_a].resolve(_8,_9);if(this.name){_8[this.name]=_a;}this.contents.set(_a);return this.contents.render(_8,_9);},unrender:function(_c,_d){return this.contents.unrender(_c,_d);},clone:function(_e){return new this.constructor(this.cyclevars,this.name,this.contents.clone(_e),this.shared);}});_3.IfChangedNode=_1.extend(function(_f,_10,_11){this.nodes=_f;this._vars=_10;this.shared=_11||{last:null,counter:0};this.vars=_1.map(_10,function(_12){return new dojox.dtl._Filter(_12);});},{render:function(_13,_14){if(_13.forloop){if(_13.forloop.counter<=this.shared.counter){this.shared.last=null;}this.shared.counter=_13.forloop.counter;}var _15;if(this.vars.length){_15=_1.toJson(_1.map(this.vars,function(_16){return _16.resolve(_13);}));}else{_15=this.nodes.dummyRender(_13,_14);}if(_15!=this.shared.last){var _17=(this.shared.last===null);this.shared.last=_15;_13=_13.push();_13.ifchanged={firstloop:_17};_14=this.nodes.render(_13,_14);_13=_13.pop();}else{_14=this.nodes.unrender(_13,_14);}return _14;},unrender:function(_18,_19){return this.nodes.unrender(_18,_19);},clone:function(_1a){return new this.constructor(this.nodes.clone(_1a),this._vars,this.shared);}});_3.RegroupNode=_1.extend(function(_1b,key,_1c){this._expression=_1b;this.expression=new dd._Filter(_1b);this.key=key;this.alias=_1c;},{_push:function(_1d,_1e,_1f){if(_1f.length){_1d.push({grouper:_1e,list:_1f});}},render:function(_20,_21){_20[this.alias]=[];var _22=this.expression.resolve(_20);if(_22){var _23=null;var _24=[];for(var i=0;i<_22.length;i++){var id=_22[i][this.key];if(_23!==id){this._push(_20[this.alias],_23,_24);_23=id;_24=[_22[i]];}else{_24.push(_22[i]);}}this._push(_20[this.alias],_23,_24);}return _21;},unrender:function(_25,_26){return _26;},clone:function(_27,_28){return this;}});_1.mixin(_3,{cycle:function(_29,_2a){var _2b=_2a.split_contents();if(_2b.length<2){throw new Error("'cycle' tag requires at least two arguments");}if(_2b[1].indexOf(",")!=-1){var _2c=_2b[1].split(",");_2b=[_2b[0]];for(var i=0;i<_2c.length;i++){_2b.push("\""+_2c[i]+"\"");}}if(_2b.length==2){var _2d=_2b[_2b.length-1];if(!_29._namedCycleNodes){throw new Error("No named cycles in template: '"+_2d+"' is not defined");}if(!_29._namedCycleNodes[_2d]){throw new Error("Named cycle '"+_2d+"' does not exist");}return _29._namedCycleNodes[_2d];}if(_2b.length>4&&_2b[_2b.length-2]=="as"){var _2d=_2b[_2b.length-1];var _2e=new _3.CycleNode(_2b.slice(1,_2b.length-2),_2d,_29.create_text_node());if(!_29._namedCycleNodes){_29._namedCycleNodes={};}_29._namedCycleNodes[_2d]=_2e;}else{_2e=new _3.CycleNode(_2b.slice(1),null,_29.create_text_node());}return _2e;},ifchanged:function(_2f,_30){var _31=_30.contents.split();var _32=_2f.parse(["endifchanged"]);_2f.delete_first_token();return new _3.IfChangedNode(_32,_31.slice(1));},regroup:function(_33,_34){var _35=_2(_34.contents,/(\s+)/g,function(_36){return _36;});if(_35.length<11||_35[_35.length-3]!="as"||_35[_35.length-7]!="by"){throw new Error("Expected the format: regroup list by key as newList");}var _37=_35.slice(2,-8).join("");var key=_35[_35.length-5];var _38=_35[_35.length-1];return new _3.RegroupNode(_37,key,_38);}});return dojox.dtl.tag.loop;});