/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/lang","../_base","dojo/_base/array","dojo/_base/connect"],function(_1,dd){_1.getObject("dtl.tag.misc",true,dojox);var _2=dd.tag.misc;_2.DebugNode=_1.extend(function(_3){this.text=_3;},{render:function(_4,_5){var _6=_4.getKeys();var _7=[];var _8={};for(var i=0,_9;_9=_6[i];i++){_8[_9]=_4[_9];_7+="["+_9+": "+typeof _4[_9]+"]\n";}return this.text.set(_7).render(_4,_5,this);},unrender:function(_a,_b){return _b;},clone:function(_c){return new this.constructor(this.text.clone(_c));},toString:function(){return "ddtm.DebugNode";}});_2.FilterNode=_1.extend(function(_d,_e){this._varnode=_d;this._nodelist=_e;},{render:function(_f,_10){var _11=this._nodelist.render(_f,new dojox.string.Builder());_f=_f.update({"var":_11.toString()});var _12=this._varnode.render(_f,_10);_f=_f.pop();return _10;},unrender:function(_13,_14){return _14;},clone:function(_15){return new this.constructor(this._expression,this._nodelist.clone(_15));}});_2.FirstOfNode=_1.extend(function(_16,_17){this._vars=_16;this.vars=_1.map(_16,function(_18){return new dojox.dtl._Filter(_18);});this.contents=_17;},{render:function(_19,_1a){for(var i=0,_1b;_1b=this.vars[i];i++){var _1c=_1b.resolve(_19);if(typeof _1c!="undefined"){if(_1c===null){_1c="null";}this.contents.set(_1c);return this.contents.render(_19,_1a);}}return this.contents.unrender(_19,_1a);},unrender:function(_1d,_1e){return this.contents.unrender(_1d,_1e);},clone:function(_1f){return new this.constructor(this._vars,this.contents.clone(_1f));}});_2.SpacelessNode=_1.extend(function(_20,_21){this.nodelist=_20;this.contents=_21;},{render:function(_22,_23){if(_23.getParent){var _24=[_1.connect(_23,"onAddNodeComplete",this,"_watch"),_1.connect(_23,"onSetParent",this,"_watchParent")];_23=this.nodelist.render(_22,_23);_1.disconnect(_24[0]);_1.disconnect(_24[1]);}else{var _25=this.nodelist.dummyRender(_22);this.contents.set(_25.replace(/>\s+</g,"><"));_23=this.contents.render(_22,_23);}return _23;},unrender:function(_26,_27){return this.nodelist.unrender(_26,_27);},clone:function(_28){return new this.constructor(this.nodelist.clone(_28),this.contents.clone(_28));},_isEmpty:function(_29){return (_29.nodeType==3&&!_29.data.match(/[^\s\n]/));},_watch:function(_2a){if(this._isEmpty(_2a)){var _2b=false;if(_2a.parentNode.firstChild==_2a){_2a.parentNode.removeChild(_2a);}}else{var _2c=_2a.parentNode.childNodes;if(_2a.nodeType==1&&_2c.length>2){for(var i=2,_2d;_2d=_2c[i];i++){if(_2c[i-2].nodeType==1&&this._isEmpty(_2c[i-1])){_2a.parentNode.removeChild(_2c[i-1]);return;}}}}},_watchParent:function(_2e){var _2f=_2e.childNodes;if(_2f.length){while(_2e.childNodes.length){var _30=_2e.childNodes[_2e.childNodes.length-1];if(!this._isEmpty(_30)){return;}_2e.removeChild(_30);}}}});_2.TemplateTagNode=_1.extend(function(tag,_31){this.tag=tag;this.contents=_31;},{mapping:{openblock:"{%",closeblock:"%}",openvariable:"{{",closevariable:"}}",openbrace:"{",closebrace:"}",opencomment:"{#",closecomment:"#}"},render:function(_32,_33){this.contents.set(this.mapping[this.tag]);return this.contents.render(_32,_33);},unrender:function(_34,_35){return this.contents.unrender(_34,_35);},clone:function(_36){return new this.constructor(this.tag,this.contents.clone(_36));}});_2.WidthRatioNode=_1.extend(function(_37,max,_38,_39){this.current=new dd._Filter(_37);this.max=new dd._Filter(max);this.width=_38;this.contents=_39;},{render:function(_3a,_3b){var _3c=+this.current.resolve(_3a);var max=+this.max.resolve(_3a);if(typeof _3c!="number"||typeof max!="number"||!max){this.contents.set("");}else{this.contents.set(""+Math.round((_3c/max)*this.width));}return this.contents.render(_3a,_3b);},unrender:function(_3d,_3e){return this.contents.unrender(_3d,_3e);},clone:function(_3f){return new this.constructor(this.current.getExpression(),this.max.getExpression(),this.width,this.contents.clone(_3f));}});_2.WithNode=_1.extend(function(_40,_41,_42){this.target=new dd._Filter(_40);this.alias=_41;this.nodelist=_42;},{render:function(_43,_44){var _45=this.target.resolve(_43);_43=_43.push();_43[this.alias]=_45;_44=this.nodelist.render(_43,_44);_43=_43.pop();return _44;},unrender:function(_46,_47){return _47;},clone:function(_48){return new this.constructor(this.target.getExpression(),this.alias,this.nodelist.clone(_48));}});_1.mixin(_2,{comment:function(_49,_4a){_49.skip_past("endcomment");return dd._noOpNode;},debug:function(_4b,_4c){return new _2.DebugNode(_4b.create_text_node());},filter:function(_4d,_4e){var _4f=_4e.contents.split(null,1)[1];var _50=_4d.create_variable_node("var|"+_4f);var _51=_4d.parse(["endfilter"]);_4d.next_token();return new _2.FilterNode(_50,_51);},firstof:function(_52,_53){var _54=_53.split_contents().slice(1);if(!_54.length){throw new Error("'firstof' statement requires at least one argument");}return new _2.FirstOfNode(_54,_52.create_text_node());},spaceless:function(_55,_56){var _57=_55.parse(["endspaceless"]);_55.delete_first_token();return new _2.SpacelessNode(_57,_55.create_text_node());},templatetag:function(_58,_59){var _5a=_59.contents.split();if(_5a.length!=2){throw new Error("'templatetag' statement takes one argument");}var tag=_5a[1];var _5b=_2.TemplateTagNode.prototype.mapping;if(!_5b[tag]){var _5c=[];for(var key in _5b){_5c.push(key);}throw new Error("Invalid templatetag argument: '"+tag+"'. Must be one of: "+_5c.join(", "));}return new _2.TemplateTagNode(tag,_58.create_text_node());},widthratio:function(_5d,_5e){var _5f=_5e.contents.split();if(_5f.length!=4){throw new Error("widthratio takes three arguments");}var _60=+_5f[3];if(typeof _60!="number"){throw new Error("widthratio final argument must be an integer");}return new _2.WidthRatioNode(_5f[1],_5f[2],_60,_5d.create_text_node());},with_:function(_61,_62){var _63=_62.split_contents();if(_63.length!=4||_63[2]!="as"){throw new Error("do_width expected format as 'with value as name'");}var _64=_61.parse(["endwith"]);_61.next_token();return new _2.WithNode(_63[1],_63[3],_64);}});return dojox.dtl.tag.misc;});