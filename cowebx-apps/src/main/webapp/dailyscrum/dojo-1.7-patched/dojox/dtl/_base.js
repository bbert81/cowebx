/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/lang","dojox/string/tokenize","dojo/_base/json","dojo/_base/html","dojox/string/Builder"],function(_1,_2){_1.experimental("dojox.dtl");_1.getObject("dtl",true,dojox);(dojox.dtl._base=function(){var dd=dojox.dtl;dd.TOKEN_BLOCK=-1;dd.TOKEN_VAR=-2;dd.TOKEN_COMMENT=-3;dd.TOKEN_TEXT=3;dd._Context=_1.extend(function(_3){if(_3){_1._mixin(this,_3);if(_3.get){this._getter=_3.get;delete this.get;}}},{push:function(){var _4=this;var _5=_1.delegate(this);_5.pop=function(){return _4;};return _5;},pop:function(){throw new Error("pop() called on empty Context");},get:function(_6,_7){var n=this._normalize;if(this._getter){var _8=this._getter(_6);if(typeof _8!="undefined"){return n(_8);}}if(typeof this[_6]!="undefined"){return n(this[_6]);}return _7;},_normalize:function(_9){if(_9 instanceof Date){_9.year=_9.getFullYear();_9.month=_9.getMonth()+1;_9.day=_9.getDate();_9.date=_9.year+"-"+("0"+_9.month).slice(-2)+"-"+("0"+_9.day).slice(-2);_9.hour=_9.getHours();_9.minute=_9.getMinutes();_9.second=_9.getSeconds();_9.microsecond=_9.getMilliseconds();}return _9;},update:function(_a){var _b=this.push();if(_a){_1._mixin(this,_a);}return _b;}});var _c=/("(?:[^"\\]*(?:\\.[^"\\]*)*)"|'(?:[^'\\]*(?:\\.[^'\\]*)*)'|[^\s]+)/g;var _d=/\s+/g;var _e=function(_f,_10){_f=_f||_d;if(!(_f instanceof RegExp)){_f=new RegExp(_f,"g");}if(!_f.global){throw new Error("You must use a globally flagged RegExp with split "+_f);}_f.exec("");var _11,_12=[],_13=0,i=0;while(_11=_f.exec(this)){_12.push(this.slice(_13,_f.lastIndex-_11[0].length));_13=_f.lastIndex;if(_10&&(++i>_10-1)){break;}}_12.push(this.slice(_13));return _12;};dd.Token=function(_14,_15){this.token_type=_14;this.contents=new String(_1.trim(_15));this.contents.split=_e;this.split=function(){return String.prototype.split.apply(this.contents,arguments);};};dd.Token.prototype.split_contents=function(_16){var bit,_17=[],i=0;_16=_16||999;while(i++<_16&&(bit=_c.exec(this.contents))){bit=bit[0];if(bit.charAt(0)=="\""&&bit.slice(-1)=="\""){_17.push("\""+bit.slice(1,-1).replace("\\\"","\"").replace("\\\\","\\")+"\"");}else{if(bit.charAt(0)=="'"&&bit.slice(-1)=="'"){_17.push("'"+bit.slice(1,-1).replace("\\'","'").replace("\\\\","\\")+"'");}else{_17.push(bit);}}}return _17;};var ddt=dd.text={_get:function(_18,_19,_1a){var _1b=dd.register.get(_18,_19.toLowerCase(),_1a);if(!_1b){if(!_1a){throw new Error("No tag found for "+_19);}return null;}var fn=_1b[1];var _1c=_1b[2];var _1d;if(fn.indexOf(":")!=-1){_1d=fn.split(":");fn=_1d.pop();}_1["require"](_1c);var _1e=_1.getObject(_1c);return _1e[fn||_19]||_1e[_19+"_"]||_1e[fn+"_"];},getTag:function(_1f,_20){return ddt._get("tag",_1f,_20);},getFilter:function(_21,_22){return ddt._get("filter",_21,_22);},getTemplate:function(_23){return new dd.Template(ddt.getTemplateString(_23));},getTemplateString:function(_24){return _1._getText(_24.toString())||"";},_resolveLazy:function(_25,_26,_27){if(_26){if(_27){return _1.fromJson(_1._getText(_25))||{};}else{return dd.text.getTemplateString(_25);}}else{return _1.xhrGet({handleAs:(_27)?"json":"text",url:_25});}},_resolveTemplateArg:function(arg,_28){if(ddt._isTemplate(arg)){if(!_28){var d=new _1.Deferred();d.callback(arg);return d;}return arg;}return ddt._resolveLazy(arg,_28);},_isTemplate:function(arg){return (typeof arg=="undefined")||(typeof arg=="string"&&(arg.match(/^\s*[<{]/)||arg.indexOf(" ")!=-1));},_resolveContextArg:function(arg,_29){if(arg.constructor==Object){if(!_29){var d=new _1.Deferred;d.callback(arg);return d;}return arg;}return ddt._resolveLazy(arg,_29,true);},_re:/(?:\{\{\s*(.+?)\s*\}\}|\{%\s*(load\s*)?(.+?)\s*%\})/g,tokenize:function(str){return _2(str,ddt._re,ddt._parseDelims);},_parseDelims:function(_2a,_2b,tag){if(_2a){return [dd.TOKEN_VAR,_2a];}else{if(_2b){var _2c=_1.trim(tag).split(/\s+/g);for(var i=0,_2d;_2d=_2c[i];i++){_1["require"](_2d);}}else{return [dd.TOKEN_BLOCK,tag];}}}};dd.Template=_1.extend(function(_2e,_2f){var str=_2f?_2e:ddt._resolveTemplateArg(_2e,true)||"";var _30=ddt.tokenize(str);var _31=new dd._Parser(_30);this.nodelist=_31.parse();},{update:function(_32,_33){return ddt._resolveContextArg(_33).addCallback(this,function(_34){var _35=this.render(new dd._Context(_34));if(_32.forEach){_32.forEach(function(_36){_36.innerHTML=_35;});}else{_1.byId(_32).innerHTML=_35;}return this;});},render:function(_37,_38){_38=_38||this.getBuffer();_37=_37||new dd._Context({});return this.nodelist.render(_37,_38)+"";},getBuffer:function(){return new dojox.string.Builder();}});var _39=/\{\{\s*(.+?)\s*\}\}/g;dd.quickFilter=function(str){if(!str){return new dd._NodeList();}if(str.indexOf("{%")==-1){return new dd._QuickNodeList(_2(str,_39,function(_3a){return new dd._Filter(_3a);}));}};dd._QuickNodeList=_1.extend(function(_3b){this.contents=_3b;},{render:function(_3c,_3d){for(var i=0,l=this.contents.length;i<l;i++){if(this.contents[i].resolve){_3d=_3d.concat(this.contents[i].resolve(_3c));}else{_3d=_3d.concat(this.contents[i]);}}return _3d;},dummyRender:function(_3e){return this.render(_3e,dd.Template.prototype.getBuffer()).toString();},clone:function(_3f){return this;}});dd._Filter=_1.extend(function(_40){if(!_40){throw new Error("Filter must be called with variable name");}this.contents=_40;var _41=this._cache[_40];if(_41){this.key=_41[0];this.filters=_41[1];}else{this.filters=[];_2(_40,this._re,this._tokenize,this);this._cache[_40]=[this.key,this.filters];}},{_cache:{},_re:/(?:^_\("([^\\"]*(?:\\.[^\\"])*)"\)|^"([^\\"]*(?:\\.[^\\"]*)*)"|^([a-zA-Z0-9_.]+)|\|(\w+)(?::(?:_\("([^\\"]*(?:\\.[^\\"])*)"\)|"([^\\"]*(?:\\.[^\\"]*)*)"|([a-zA-Z0-9_.]+)|'([^\\']*(?:\\.[^\\']*)*)'))?|^'([^\\']*(?:\\.[^\\']*)*)')/g,_values:{0:"\"",1:"\"",2:"",8:"\""},_args:{4:"\"",5:"\"",6:"",7:"'"},_tokenize:function(){var pos,arg;for(var i=0,has=[];i<arguments.length;i++){has[i]=(typeof arguments[i]!="undefined"&&typeof arguments[i]=="string"&&arguments[i]);}if(!this.key){for(pos in this._values){if(has[pos]){this.key=this._values[pos]+arguments[pos]+this._values[pos];break;}}}else{for(pos in this._args){if(has[pos]){var _42=arguments[pos];if(this._args[pos]=="'"){_42=_42.replace(/\\'/g,"'");}else{if(this._args[pos]=="\""){_42=_42.replace(/\\"/g,"\"");}}arg=[!this._args[pos],_42];break;}}var fn=ddt.getFilter(arguments[3]);if(!_1.isFunction(fn)){throw new Error(arguments[3]+" is not registered as a filter");}this.filters.push([fn,arg]);}},getExpression:function(){return this.contents;},resolve:function(_43){if(typeof this.key=="undefined"){return "";}var str=this.resolvePath(this.key,_43);for(var i=0,_44;_44=this.filters[i];i++){if(_44[1]){if(_44[1][0]){str=_44[0](str,this.resolvePath(_44[1][1],_43));}else{str=_44[0](str,_44[1][1]);}}else{str=_44[0](str);}}return str;},resolvePath:function(_45,_46){var _47,_48;var _49=_45.charAt(0);var _4a=_45.slice(-1);if(!isNaN(parseInt(_49))){_47=(_45.indexOf(".")==-1)?parseInt(_45):parseFloat(_45);}else{if(_49=="\""&&_49==_4a){_47=_45.slice(1,-1);}else{if(_45=="true"){return true;}if(_45=="false"){return false;}if(_45=="null"||_45=="None"){return null;}_48=_45.split(".");_47=_46.get(_48[0]);if(_1.isFunction(_47)){var _4b=_46.getThis&&_46.getThis();if(_47.alters_data){_47="";}else{if(_4b){_47=_47.call(_4b);}else{_47="";}}}for(var i=1;i<_48.length;i++){var _4c=_48[i];if(_47){var _4d=_47;if(_1.isObject(_47)&&_4c=="items"&&typeof _47[_4c]=="undefined"){var _4e=[];for(var key in _47){_4e.push([key,_47[key]]);}_47=_4e;continue;}if(_47.get&&_1.isFunction(_47.get)&&_47.get.safe){_47=_47.get(_4c);}else{if(typeof _47[_4c]=="undefined"){_47=_47[_4c];break;}else{_47=_47[_4c];}}if(_1.isFunction(_47)){if(_47.alters_data){_47="";}else{_47=_47.call(_4d);}}else{if(_47 instanceof Date){_47=dd._Context.prototype._normalize(_47);}}}else{return "";}}}}return _47;}});dd._TextNode=dd._Node=_1.extend(function(obj){this.contents=obj;},{set:function(_4f){this.contents=_4f;return this;},render:function(_50,_51){return _51.concat(this.contents);},isEmpty:function(){return !_1.trim(this.contents);},clone:function(){return this;}});dd._NodeList=_1.extend(function(_52){this.contents=_52||[];this.last="";},{push:function(_53){this.contents.push(_53);return this;},concat:function(_54){this.contents=this.contents.concat(_54);return this;},render:function(_55,_56){for(var i=0;i<this.contents.length;i++){_56=this.contents[i].render(_55,_56);if(!_56){throw new Error("Template must return buffer");}}return _56;},dummyRender:function(_57){return this.render(_57,dd.Template.prototype.getBuffer()).toString();},unrender:function(){return arguments[1];},clone:function(){return this;},rtrim:function(){while(1){i=this.contents.length-1;if(this.contents[i] instanceof dd._TextNode&&this.contents[i].isEmpty()){this.contents.pop();}else{break;}}return this;}});dd._VarNode=_1.extend(function(str){this.contents=new dd._Filter(str);},{render:function(_58,_59){var str=this.contents.resolve(_58);if(!str.safe){str=dd._base.escape(""+str);}return _59.concat(str);}});dd._noOpNode=new function(){this.render=this.unrender=function(){return arguments[1];};this.clone=function(){return this;};};dd._Parser=_1.extend(function(_5a){this.contents=_5a;},{i:0,parse:function(_5b){var _5c={},_5d;_5b=_5b||[];for(var i=0;i<_5b.length;i++){_5c[_5b[i]]=true;}var _5e=new dd._NodeList();while(this.i<this.contents.length){_5d=this.contents[this.i++];if(typeof _5d=="string"){_5e.push(new dd._TextNode(_5d));}else{var _5f=_5d[0];var _60=_5d[1];if(_5f==dd.TOKEN_VAR){_5e.push(new dd._VarNode(_60));}else{if(_5f==dd.TOKEN_BLOCK){if(_5c[_60]){--this.i;return _5e;}var cmd=_60.split(/\s+/g);if(cmd.length){cmd=cmd[0];var fn=ddt.getTag(cmd);if(fn){_5e.push(fn(this,new dd.Token(_5f,_60)));}}}}}}if(_5b.length){throw new Error("Could not find closing tag(s): "+_5b.toString());}this.contents.length=0;return _5e;},next_token:function(){var _61=this.contents[this.i++];return new dd.Token(_61[0],_61[1]);},delete_first_token:function(){this.i++;},skip_past:function(_62){while(this.i<this.contents.length){var _63=this.contents[this.i++];if(_63[0]==dd.TOKEN_BLOCK&&_63[1]==_62){return;}}throw new Error("Unclosed tag found when looking for "+_62);},create_variable_node:function(_64){return new dd._VarNode(_64);},create_text_node:function(_65){return new dd._TextNode(_65||"");},getTemplate:function(_66){return new dd.Template(_66);}});dd.register={_registry:{attributes:[],tags:[],filters:[]},get:function(_67,_68){var _69=dd.register._registry[_67+"s"];for(var i=0,_6a;_6a=_69[i];i++){if(typeof _6a[0]=="string"){if(_6a[0]==_68){return _6a;}}else{if(_68.match(_6a[0])){return _6a;}}}},getAttributeTags:function(){var _6b=[];var _6c=dd.register._registry.attributes;for(var i=0,_6d;_6d=_6c[i];i++){if(_6d.length==3){_6b.push(_6d);}else{var fn=_1.getObject(_6d[1]);if(fn&&_1.isFunction(fn)){_6d.push(fn);_6b.push(_6d);}}}return _6b;},_any:function(_6e,_6f,_70){for(var _71 in _70){for(var i=0,fn;fn=_70[_71][i];i++){var key=fn;if(_1.isArray(fn)){key=fn[0];fn=fn[1];}if(typeof key=="string"){if(key.substr(0,5)=="attr:"){var _72=fn;if(_72.substr(0,5)=="attr:"){_72=_72.slice(5);}dd.register._registry.attributes.push([_72.toLowerCase(),_6f+"."+_71+"."+_72]);}key=key.toLowerCase();}dd.register._registry[_6e].push([key,fn,_6f+"."+_71]);}}},tags:function(_73,_74){dd.register._any("tags",_73,_74);},filters:function(_75,_76){dd.register._any("filters",_75,_76);}};var _77=/&/g;var _78=/</g;var _79=/>/g;var _7a=/'/g;var _7b=/"/g;dd._base.escape=function(_7c){return dd.mark_safe(_7c.replace(_77,"&amp;").replace(_78,"&lt;").replace(_79,"&gt;").replace(_7b,"&quot;").replace(_7a,"&#39;"));};dd._base.safe=function(_7d){if(typeof _7d=="string"){_7d=new String(_7d);}if(typeof _7d=="object"){_7d.safe=true;}return _7d;};dd.mark_safe=dd._base.safe;dd.register.tags("dojox.dtl.tag",{"date":["now"],"logic":["if","for","ifequal","ifnotequal"],"loader":["extends","block","include","load","ssi"],"misc":["comment","debug","filter","firstof","spaceless","templatetag","widthratio","with"],"loop":["cycle","ifchanged","regroup"]});dd.register.filters("dojox.dtl.filter",{"dates":["date","time","timesince","timeuntil"],"htmlstrings":["linebreaks","linebreaksbr","removetags","striptags"],"integers":["add","get_digit"],"lists":["dictsort","dictsortreversed","first","join","length","length_is","random","slice","unordered_list"],"logic":["default","default_if_none","divisibleby","yesno"],"misc":["filesizeformat","pluralize","phone2numeric","pprint"],"strings":["addslashes","capfirst","center","cut","fix_ampersands","floatformat","iriencode","linenumbers","ljust","lower","make_list","rjust","slugify","stringformat","title","truncatewords","truncatewords_html","upper","urlencode","urlize","urlizetrunc","wordcount","wordwrap"]});dd.register.filters("dojox.dtl",{"_base":["escape","safe"]});})();return dojox.dtl;});