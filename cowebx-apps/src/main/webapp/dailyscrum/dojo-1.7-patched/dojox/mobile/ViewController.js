/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/declare","dojo/on","dojo/_base/array","dojo/DeferredList","./TransitionEvent","./ProgressIndicator"],function(_1,on,_2,_3,_4,_5){var _6=dojo.declare(null,{constructor:function(){this.viewMap={};this.currentView=null;this.defaultView=null;dojo.ready(dojo.hitch(this,function(){on(dojo.body(),"startTransition",dojo.hitch(this,"onStartTransition"));}));},findCurrentView:function(_7,_8){if(_7){w=dijit.byId(_7);if(w&&w.getShowingView){return w.getShowingView();}}if(dojox.mobile.currentView){return dojox.mobile.currentView;}w=_8;while(true){w=w.getParent();if(!w){return null;}if(w instanceof dojox.mobile.View){break;}}return w;},onStartTransition:function(_9){_9.preventDefault();if(!_9.detail||(_9.detail&&!_9.detail.moveTo&&!_9.detail.href&&!_9.detail.url&&!_9.detail.scene)){return;}var w=this.findCurrentView(_9.detail.moveTo,(_9.target&&_9.target.id)?dijit.byId(_9.target.id):dijit.byId(_9.target));if(!w||(_9.detail&&_9.detail.moveTo&&w===dijit.byId(_9.detail.moveTo))){return;}if(_9.detail.href){var t=dijit.byId(_9.target.id).hrefTarget;if(t){dojox.mobile.openWindow(_9.detail.href,t);}else{w.performTransition(null,_9.detail.transitionDir,_9.detail.transition,_9.target,function(){location.href=_9.detail.href;});}return;}else{if(_9.detail.scene){dojo.publish("/dojox/mobile/app/pushScene",[_9.detail.scene]);return;}}var _a=_9.detail.moveTo;if(_9.detail.url){var id;if(dojox.mobile._viewMap&&dojox.mobile._viewMap[_9.detail.url]){id=dojox.mobile._viewMap[_9.detail.url];}else{var _b=this._text;if(!_b){if(dijit.byId(_9.target.id).sync){_b=dojo.trim(dojo._getText(_9.detail.url));}else{require(["dojo/_base/xhr"],dojo.hitch(this,function(_c){var _d=_5.getInstance();dojo.body().appendChild(_d.domNode);_d.start();var _c=dojo.xhrGet({url:_9.detail.url,handleAs:"text"});_c.addCallback(dojo.hitch(this,function(_e,_f){_d.stop();if(_e){this._text=_e;new _4(_9.target,{transition:_9.detail.transition,transitionDir:_9.detail.transitionDir,moveTo:_a,href:_9.detail.href,url:_9.detail.url,scene:_9.detail.scene},_9.detail).dispatch();}}));_c.addErrback(function(_10){_d.stop();});}));return;}}this._text=null;id=this._parse(_b);if(!dojox.mobile._viewMap){dojox.mobile._viewMap=[];}dojox.mobile._viewMap[_9.detail.url]=id;}_a=id;w=this.findCurrentView(_a,dijit.byId(_9.target.id))||w;}w.performTransition(_a,_9.detail.transitionDir,_9.detail.transition,null,null);},_parse:function(_11,id){var _12=dojo.create("DIV");var _13;var _14=this.findCurrentView();var _15=dijit.byId(id)&&dijit.byId(id).containerNode||dojo.byId(id)||_14&&_14.domNode.parentNode||dojo.body();if(_11.charAt(0)=="<"){var _12=dojo.create("DIV",{innerHTML:_11});_13=_12.firstChild;if(!_13&&_13.nodeType!=1){return;}_13.style.visibility="hidden";_15.appendChild(_12);var ws=dojo.parser.parse(_12);dojo.forEach(ws,function(w){if(w&&!w._started&&w.startup){w.startup();}});_15.appendChild(_15.removeChild(_12).firstChild);dijit.byNode(_13)._visible=true;}else{if(_11.charAt(0)=="{"){_15.appendChild(_12);this._ws=[];_13=this._instantiate(eval("("+_11+")"),_12);for(var i=0;i<this._ws.length;i++){var w=this._ws[i];w.startup&&!w._started&&(!w.getParent||!w.getParent())&&w.startup();}this._ws=null;}}_13.style.display="none";_13.style.visibility="visible";var id=_13.id;return dojo.hash?"#"+id:id;},_instantiate:function(obj,_16,_17){var _18;for(var key in obj){if(key.charAt(0)=="@"){continue;}var cls=dojo.getObject(key);if(!cls){continue;}var _19={};var _1a=cls.prototype;var _1b=dojo.isArray(obj[key])?obj[key]:[obj[key]];for(var i=0;i<_1b.length;i++){for(var _1c in _1b[i]){if(_1c.charAt(0)=="@"){var val=_1b[i][_1c];_1c=_1c.substring(1);if(typeof _1a[_1c]=="string"){_19[_1c]=val;}else{if(typeof _1a[_1c]=="number"){_19[_1c]=val-0;}else{if(typeof _1a[_1c]=="boolean"){_19[_1c]=(val!="false");}else{if(typeof _1a[_1c]=="object"){_19[_1c]=eval("("+val+")");}}}}}}_18=new cls(_19,_16);if(_16){_18._visible=true;this._ws.push(_18);}if(_17&&_17.addChild){_17.addChild(_18);}this._instantiate(_1b[i],null,_18);}}return _18&&_18.domNode;}});new _6();return _6;});