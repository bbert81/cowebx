/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/html","dojo/_base/connect","dojo/fx","dojo/dnd/move","dijit/form/_FormWidget","dojox/color","dojo/i18n","dojo/i18n!./nls/ColorPicker","dojo/i18n!dojo/cldr/nls/number","dojo/text!./ColorPicker/ColorPicker.html"],function(d,_1,fx,_2,_3,_4,_5,_6,_7,_8){d.experimental("dojox.widget.ColorPicker");var _9=function(_a){return _a;};return d.declare("dojox.widget.ColorPicker",dijit.form._FormWidget,{showRgb:true,showHsv:true,showHex:true,webSafe:true,animatePoint:true,slideDuration:250,liveUpdate:false,PICKER_HUE_H:150,PICKER_SAT_VAL_H:150,PICKER_SAT_VAL_W:150,PICKER_HUE_SELECTOR_H:8,PICKER_SAT_SELECTOR_H:10,PICKER_SAT_SELECTOR_W:10,value:"#ffffff",_underlay:d.moduleUrl("dojox.widget","ColorPicker/images/underlay.png"),_hueUnderlay:d.moduleUrl("dojox.widget","ColorPicker/images/hue.png"),_pickerPointer:d.moduleUrl("dojox.widget","ColorPicker/images/pickerPointer.png"),_huePickerPointer:d.moduleUrl("dojox.widget","ColorPicker/images/hueHandle.png"),_huePickerPointerAlly:d.moduleUrl("dojox.widget","ColorPicker/images/hueHandleA11y.png"),templateString:_8,postMixInProperties:function(){if(d.hasClass(d.body(),"dijit_a11y")){this._huePickerPointer=this._huePickerPointerAlly;}this._uId=dijit.getUniqueId(this.id);d.mixin(this,_5.getLocalization("dojox.widget","ColorPicker"));d.mixin(this,_5.getLocalization("dojo.cldr","number"));this.inherited(arguments);},postCreate:function(){this.inherited(arguments);if(d.isIE<7){this.colorUnderlay.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+this._underlay+"', sizingMethod='scale')";this.colorUnderlay.src=this._blankGif.toString();}if(!this.showRgb){this.rgbNode.style.visibility="hidden";}if(!this.showHsv){this.hsvNode.style.visibility="hidden";}if(!this.showHex){this.hexNode.style.visibility="hidden";}if(!this.webSafe){this.safePreviewNode.style.visibility="hidden";}},startup:function(){if(this._started){return;}this._started=true;this.set("value",this.value);this._mover=new d.dnd.move.boxConstrainedMoveable(this.cursorNode,{box:{t:-(this.PICKER_SAT_SELECTOR_H/2),l:-(this.PICKER_SAT_SELECTOR_W/2),w:this.PICKER_SAT_VAL_W,h:this.PICKER_SAT_VAL_H}});this._hueMover=new d.dnd.move.boxConstrainedMoveable(this.hueCursorNode,{box:{t:-(this.PICKER_HUE_SELECTOR_H/2),l:0,w:0,h:this.PICKER_HUE_H}});this._subs=[];this._subs.push(d.subscribe("/dnd/move/stop",d.hitch(this,"_clearTimer")));this._subs.push(d.subscribe("/dnd/move/start",d.hitch(this,"_setTimer")));this._keyListeners=[];this._connects.push(dijit.typematic.addKeyListener(this.hueCursorNode,{charOrCode:d.keys.UP_ARROW,shiftKey:false,metaKey:false,ctrlKey:false,altKey:false},this,d.hitch(this,this._updateHueCursorNode),25,25));this._connects.push(dijit.typematic.addKeyListener(this.hueCursorNode,{charOrCode:d.keys.DOWN_ARROW,shiftKey:false,metaKey:false,ctrlKey:false,altKey:false},this,d.hitch(this,this._updateHueCursorNode),25,25));this._connects.push(dijit.typematic.addKeyListener(this.cursorNode,{charOrCode:d.keys.UP_ARROW,shiftKey:false,metaKey:false,ctrlKey:false,altKey:false},this,d.hitch(this,this._updateCursorNode),25,25));this._connects.push(dijit.typematic.addKeyListener(this.cursorNode,{charOrCode:d.keys.DOWN_ARROW,shiftKey:false,metaKey:false,ctrlKey:false,altKey:false},this,d.hitch(this,this._updateCursorNode),25,25));this._connects.push(dijit.typematic.addKeyListener(this.cursorNode,{charOrCode:d.keys.LEFT_ARROW,shiftKey:false,metaKey:false,ctrlKey:false,altKey:false},this,d.hitch(this,this._updateCursorNode),25,25));this._connects.push(dijit.typematic.addKeyListener(this.cursorNode,{charOrCode:d.keys.RIGHT_ARROW,shiftKey:false,metaKey:false,ctrlKey:false,altKey:false},this,d.hitch(this,this._updateCursorNode),25,25));},_setValueAttr:function(_b){if(!this._started){return;}this.setColor(_b,true);},setColor:function(_c,_d){var _e=dojox.color.fromString(_c);this._updatePickerLocations(_e);this._updateColorInputs(_e);this._updateValue(_e,_d);},_setTimer:function(_f){dijit.focus(_f.node);d.setSelectable(this.domNode,false);this._timer=setInterval(d.hitch(this,"_updateColor"),45);},_clearTimer:function(_10){clearInterval(this._timer);this._timer=null;this.onChange(this.value);d.setSelectable(this.domNode,true);},_setHue:function(h){d.style(this.colorUnderlay,"backgroundColor",dojox.color.fromHsv(h,100,100).toHex());},_updateHueCursorNode:function(_11,_12,e){if(_11!==-1){var y=d.style(this.hueCursorNode,"top");var _13=(this.PICKER_HUE_SELECTOR_H/2);y+=_13;var _14=false;if(e.charOrCode==d.keys.UP_ARROW){if(y>0){y-=1;_14=true;}}else{if(e.charOrCode==d.keys.DOWN_ARROW){if(y<this.PICKER_HUE_H){y+=1;_14=true;}}}y-=_13;if(_14){d.style(this.hueCursorNode,"top",y+"px");}}else{this._updateColor(true);}},_updateCursorNode:function(_15,_16,e){var _17=this.PICKER_SAT_SELECTOR_H/2;var _18=this.PICKER_SAT_SELECTOR_W/2;if(_15!==-1){var y=d.style(this.cursorNode,"top");var x=d.style(this.cursorNode,"left");y+=_17;x+=_18;var _19=false;if(e.charOrCode==d.keys.UP_ARROW){if(y>0){y-=1;_19=true;}}else{if(e.charOrCode==d.keys.DOWN_ARROW){if(y<this.PICKER_SAT_VAL_H){y+=1;_19=true;}}else{if(e.charOrCode==d.keys.LEFT_ARROW){if(x>0){x-=1;_19=true;}}else{if(e.charOrCode==d.keys.RIGHT_ARROW){if(x<this.PICKER_SAT_VAL_W){x+=1;_19=true;}}}}}if(_19){y-=_17;x-=_18;d.style(this.cursorNode,"top",y+"px");d.style(this.cursorNode,"left",x+"px");}}else{this._updateColor(true);}},_updateColor:function(){var _1a=this.PICKER_HUE_SELECTOR_H/2,_1b=this.PICKER_SAT_SELECTOR_H/2,_1c=this.PICKER_SAT_SELECTOR_W/2;var _1d=d.style(this.hueCursorNode,"top")+_1a,_1e=d.style(this.cursorNode,"top")+_1b,_1f=d.style(this.cursorNode,"left")+_1c,h=Math.round(360-(_1d/this.PICKER_HUE_H*360)),col=dojox.color.fromHsv(h,_1f/this.PICKER_SAT_VAL_W*100,100-(_1e/this.PICKER_SAT_VAL_H*100));this._updateColorInputs(col);this._updateValue(col,true);if(h!=this._hue){this._setHue(h);}},_colorInputChange:function(e){var col,_20=false;switch(e.target){case this.hexCode:col=dojox.color.fromString(e.target.value);_20=true;break;case this.Rval:case this.Gval:case this.Bval:col=dojox.color.fromArray([this.Rval.value,this.Gval.value,this.Bval.value]);_20=true;break;case this.Hval:case this.Sval:case this.Vval:col=dojox.color.fromHsv(this.Hval.value,this.Sval.value,this.Vval.value);_20=true;break;}if(_20){this._updatePickerLocations(col);this._updateColorInputs(col);this._updateValue(col,true);}},_updateValue:function(col,_21){var hex=col.toHex();this.value=this.valueNode.value=hex;if(_21&&(!this._timer||this.liveUpdate)){this.onChange(hex);}},_updatePickerLocations:function(col){var _22=this.PICKER_HUE_SELECTOR_H/2,_23=this.PICKER_SAT_SELECTOR_H/2,_24=this.PICKER_SAT_SELECTOR_W/2;var hsv=col.toHsv(),_25=Math.round(this.PICKER_HUE_H-hsv.h/360*this.PICKER_HUE_H)-_22,_26=Math.round(hsv.s/100*this.PICKER_SAT_VAL_W)-_24,_27=Math.round(this.PICKER_SAT_VAL_H-hsv.v/100*this.PICKER_SAT_VAL_H)-_23;if(this.animatePoint){d.fx.slideTo({node:this.hueCursorNode,duration:this.slideDuration,top:_25,left:0}).play();d.fx.slideTo({node:this.cursorNode,duration:this.slideDuration,top:_27,left:_26}).play();}else{d.style(this.hueCursorNode,"top",_25+"px");d.style(this.cursorNode,{left:_26+"px",top:_27+"px"});}if(hsv.h!=this._hue){this._setHue(hsv.h);}},_updateColorInputs:function(col){var hex=col.toHex();if(this.showRgb){this.Rval.value=col.r;this.Gval.value=col.g;this.Bval.value=col.b;}if(this.showHsv){var hsv=col.toHsv();this.Hval.value=Math.round((hsv.h));this.Sval.value=Math.round(hsv.s);this.Vval.value=Math.round(hsv.v);}if(this.showHex){this.hexCode.value=hex;}this.previewNode.style.backgroundColor=hex;if(this.webSafe){this.safePreviewNode.style.backgroundColor=_9(hex);}},_setHuePoint:function(evt){var _28=(this.PICKER_HUE_SELECTOR_H/2);var _29=evt.layerY-_28;if(this.animatePoint){d.fx.slideTo({node:this.hueCursorNode,duration:this.slideDuration,top:_29,left:0,onEnd:d.hitch(this,function(){this._updateColor(true);dijit.focus(this.hueCursorNode);})}).play();}else{d.style(this.hueCursorNode,"top",_29+"px");this._updateColor(false);}},_setPoint:function(evt){var _2a=this.PICKER_SAT_SELECTOR_H/2;var _2b=this.PICKER_SAT_SELECTOR_W/2;var _2c=evt.layerY-_2a;var _2d=evt.layerX-_2b;if(evt){dijit.focus(evt.target);}if(this.animatePoint){d.fx.slideTo({node:this.cursorNode,duration:this.slideDuration,top:_2c,left:_2d,onEnd:d.hitch(this,function(){this._updateColor(true);dijit.focus(this.cursorNode);})}).play();}else{d.style(this.cursorNode,{left:_2d+"px",top:_2c+"px"});this._updateColor(false);}},_handleKey:function(e){},focus:function(){if(!this.focused){dijit.focus(this.focusNode);}},_stopDrag:function(e){d.stopEvent(e);},destroy:function(){this.inherited(arguments);d.forEach(this._subs,function(sub){d.unsubscribe(sub);});delete this._subs;}});});