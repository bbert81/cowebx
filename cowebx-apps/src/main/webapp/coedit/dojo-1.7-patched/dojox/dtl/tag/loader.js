/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/lang","../_base","dojo/_base/array","dojo/_base/connect"],function(_1,dd){_1.getObject("dtl.tag.loader",true,dojox);var _2=dd.tag.loader;_2.BlockNode=_1.extend(function(_3,_4){this.name=_3;this.nodelist=_4;},{"super":function(){if(this.parent){var _5=this.parent.nodelist.dummyRender(this.context,null,true);if(typeof _5=="string"){_5=new String(_5);}_5.safe=true;return _5;}return "";},render:function(_6,_7){var _8=this.name;var _9=this.nodelist;var _a;if(_7.blocks){var _b=_7.blocks[_8];if(_b){_a=_b.parent;_9=_b.nodelist;_b.used=true;}}this.rendered=_9;_6=_6.push();this.context=_6;this.parent=null;if(_9!=this.nodelist){this.parent=this;}_6.block=this;if(_7.getParent){var _c=_7.getParent();var _d=_1.connect(_7,"onSetParent",function(_e,up,_f){if(up&&_f){_7.setParent(_c);}});}_7=_9.render(_6,_7,this);_d&&_1.disconnect(_d);_6=_6.pop();return _7;},unrender:function(_10,_11){return this.rendered.unrender(_10,_11);},clone:function(_12){return new this.constructor(this.name,this.nodelist.clone(_12));},toString:function(){return "dojox.dtl.tag.loader.BlockNode";}});_2.ExtendsNode=_1.extend(function(_13,_14,_15,_16,key){this.getTemplate=_13;this.nodelist=_14;this.shared=_15;this.parent=_16;this.key=key;},{parents:{},getParent:function(_17){var _18=this.parent;if(!_18){var _19;_18=this.parent=_17.get(this.key,false);if(!_18){throw new Error("extends tag used a variable that did not resolve");}if(typeof _18=="object"){var url=_18.url||_18.templatePath;if(_18.shared){this.shared=true;}if(url){_18=this.parent=url.toString();}else{if(_18.templateString){_19=_18.templateString;_18=this.parent=" ";}else{_18=this.parent=this.parent.toString();}}}if(_18&&_18.indexOf("shared:")===0){this.shared=true;_18=this.parent=_18.substring(7,_18.length);}}if(!_18){throw new Error("Invalid template name in 'extends' tag.");}if(_18.render){return _18;}if(this.parents[_18]){return this.parents[_18];}this.parent=this.getTemplate(_19||dojox.dtl.text.getTemplateString(_18));if(this.shared){this.parents[_18]=this.parent;}return this.parent;},render:function(_1a,_1b){var _1c=this.getParent(_1a);_1c.blocks=_1c.blocks||{};_1b.blocks=_1b.blocks||{};for(var i=0,_1d;_1d=this.nodelist.contents[i];i++){if(_1d instanceof dojox.dtl.tag.loader.BlockNode){var old=_1c.blocks[_1d.name];if(old&&old.nodelist!=_1d.nodelist){_1b=old.nodelist.unrender(_1a,_1b);}_1c.blocks[_1d.name]=_1b.blocks[_1d.name]={shared:this.shared,nodelist:_1d.nodelist,used:false};}}this.rendered=_1c;return _1c.nodelist.render(_1a,_1b,this);},unrender:function(_1e,_1f){return this.rendered.unrender(_1e,_1f,this);},toString:function(){return "dojox.dtl.block.ExtendsNode";}});_2.IncludeNode=_1.extend(function(_20,_21,_22,_23,_24){this._path=_20;this.constant=_21;this.path=(_21)?_20:new dd._Filter(_20);this.getTemplate=_22;this.text=_23;this.parsed=(arguments.length==5)?_24:true;},{_cache:[{},{}],render:function(_25,_26){var _27=((this.constant)?this.path:this.path.resolve(_25)).toString();var _28=Number(this.parsed);var _29=false;if(_27!=this.last){_29=true;if(this.last){_26=this.unrender(_25,_26);}this.last=_27;}var _2a=this._cache[_28];if(_28){if(!_2a[_27]){_2a[_27]=dd.text._resolveTemplateArg(_27,true);}if(_29){var _2b=this.getTemplate(_2a[_27]);this.rendered=_2b.nodelist;}return this.rendered.render(_25,_26,this);}else{if(this.text instanceof dd._TextNode){if(_29){this.rendered=this.text;this.rendered.set(dd.text._resolveTemplateArg(_27,true));}return this.rendered.render(_25,_26);}else{if(!_2a[_27]){var _2c=[];var div=document.createElement("div");div.innerHTML=dd.text._resolveTemplateArg(_27,true);var _2d=div.childNodes;while(_2d.length){var _2e=div.removeChild(_2d[0]);_2c.push(_2e);}_2a[_27]=_2c;}if(_29){this.nodelist=[];var _2f=true;for(var i=0,_30;_30=_2a[_27][i];i++){this.nodelist.push(_30.cloneNode(true));}}for(var i=0,_31;_31=this.nodelist[i];i++){_26=_26.concat(_31);}}}return _26;},unrender:function(_32,_33){if(this.rendered){_33=this.rendered.unrender(_32,_33);}if(this.nodelist){for(var i=0,_34;_34=this.nodelist[i];i++){_33=_33.remove(_34);}}return _33;},clone:function(_35){return new this.constructor(this._path,this.constant,this.getTemplate,this.text.clone(_35),this.parsed);}});_1.mixin(_2,{block:function(_36,_37){var _38=_37.contents.split();var _39=_38[1];_36._blocks=_36._blocks||{};_36._blocks[_39]=_36._blocks[_39]||[];_36._blocks[_39].push(_39);var _3a=_36.parse(["endblock","endblock "+_39]).rtrim();_36.next_token();return new dojox.dtl.tag.loader.BlockNode(_39,_3a);},extends_:function(_3b,_3c){var _3d=_3c.contents.split();var _3e=false;var _3f=null;var key=null;if(_3d[1].charAt(0)=="\""||_3d[1].charAt(0)=="'"){_3f=_3d[1].substring(1,_3d[1].length-1);}else{key=_3d[1];}if(_3f&&_3f.indexOf("shared:")==0){_3e=true;_3f=_3f.substring(7,_3f.length);}var _40=_3b.parse();return new dojox.dtl.tag.loader.ExtendsNode(_3b.getTemplate,_40,_3e,_3f,key);},include:function(_41,_42){var _43=_42.contents.split();if(_43.length!=2){throw new Error(_43[0]+" tag takes one argument: the name of the template to be included");}var _44=_43[1];var _45=false;if((_44.charAt(0)=="\""||_44.slice(-1)=="'")&&_44.charAt(0)==_44.slice(-1)){_44=_44.slice(1,-1);_45=true;}return new _2.IncludeNode(_44,_45,_41.getTemplate,_41.create_text_node());},ssi:function(_46,_47){var _48=_47.contents.split();var _49=false;if(_48.length==3){_49=(_48.pop()=="parsed");if(!_49){throw new Error("Second (optional) argument to ssi tag must be 'parsed'");}}var _4a=_2.include(_46,new dd.Token(_47.token_type,_48.join(" ")));_4a.parsed=_49;return _4a;}});return dojox.dtl.tag.loader;});