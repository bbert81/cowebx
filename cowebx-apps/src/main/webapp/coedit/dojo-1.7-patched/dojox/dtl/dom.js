/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/lang","./_base","dojox/string/tokenize","./Context","dojo/_base/html"],function(_1,dd,_2){dd.BOOLS={checked:1,disabled:1,readonly:1};dd.TOKEN_CHANGE=-11;dd.TOKEN_ATTR=-12;dd.TOKEN_CUSTOM=-13;dd.TOKEN_NODE=1;var _3=dd.text;var _4=dd.dom={_attributes:{},_uppers:{},_re4:/^function anonymous\(\)\s*{\s*(.*)\s*}$/,_reTrim:/(?:^[\n\s]*(\{%)?\s*|\s*(%\})?[\n\s]*$)/g,_reSplit:/\s*%\}[\n\s]*\{%\s*/g,getTemplate:function(_5){if(typeof this._commentable=="undefined"){this._commentable=false;var _6=document.createElement("div"),_7="Test comment handling, and long comments, using comments whenever possible.";_6.innerHTML="<!--"+_7+"-->";if(_6.childNodes.length&&_6.firstChild.nodeType==8&&_6.firstChild.data==_7){this._commentable=true;}}if(!this._commentable){_5=_5.replace(/<!--({({|%).*?(%|})})-->/g,"$1");}if(_1.isIE){_5=_5.replace(/\b(checked|disabled|readonly|style)="/g,"t$1=\"");}_5=_5.replace(/\bstyle="/g,"tstyle=\"");var _8;var _9=_1.isWebKit;var _a=[[true,"select","option"],[_9,"tr","td|th"],[_9,"thead","tr","th"],[_9,"tbody","tr","td"],[_9,"table","tbody|thead|tr","tr","td"]];var _b=[];for(var i=0,_c;_c=_a[i];i++){if(!_c[0]){continue;}if(_5.indexOf("<"+_c[1])!=-1){var _d=new RegExp("<"+_c[1]+"(?:.|\n)*?>((?:.|\n)+?)</"+_c[1]+">","ig");tagLoop:while(_8=_d.exec(_5)){var _e=_c[2].split("|");var _f=[];for(var j=0,_10;_10=_e[j];j++){_f.push("<"+_10+"(?:.|\n)*?>(?:.|\n)*?</"+_10+">");}var _11=[];var _12=_2(_8[1],new RegExp("("+_f.join("|")+")","ig"),function(_13){var tag=/<(\w+)/.exec(_13)[1];if(!_11[tag]){_11[tag]=true;_11.push(tag);}return {data:_13};});if(_11.length){var tag=(_11.length==1)?_11[0]:_c[2].split("|")[0];var _14=[];for(var j=0,jl=_12.length;j<jl;j++){var _15=_12[j];if(_1.isObject(_15)){_14.push(_15.data);}else{var _16=_15.replace(this._reTrim,"");if(!_16){continue;}_15=_16.split(this._reSplit);for(var k=0,kl=_15.length;k<kl;k++){var _17="";for(var p=2,pl=_c.length;p<pl;p++){if(p==2){_17+="<"+tag+" dtlinstruction=\"{% "+_15[k].replace("\"","\\\"")+" %}\">";}else{if(tag==_c[p]){continue;}else{_17+="<"+_c[p]+">";}}}_17+="DTL";for(var p=_c.length-1;p>1;p--){if(p==2){_17+="</"+tag+">";}else{if(tag==_c[p]){continue;}else{_17+="</"+_c[p]+">";}}}_14.push("?"+_b.length);_b.push(_17);}}}_5=_5.replace(_8[1],_14.join(""));}}}}for(var i=_b.length;i--;){_5=_5.replace("?"+i,_b[i]);}var re=/\b([a-zA-Z_:][a-zA-Z0-9_\-\.:]*)=['"]/g;while(_8=re.exec(_5)){var _18=_8[1].toLowerCase();if(_18=="dtlinstruction"){continue;}if(_18!=_8[1]){this._uppers[_18]=_8[1];}this._attributes[_18]=true;}var _6=document.createElement("div");_6.innerHTML=_5;var _19={nodes:[]};while(_6.childNodes.length){_19.nodes.push(_6.removeChild(_6.childNodes[0]));}return _19;},tokenize:function(_1a){var _1b=[];for(var i=0,_1c;_1c=_1a[i++];){if(_1c.nodeType!=1){this.__tokenize(_1c,_1b);}else{this._tokenize(_1c,_1b);}}return _1b;},_swallowed:[],_tokenize:function(_1d,_1e){var _1f=false;var _20=this._swallowed;var i,j,tag,_21;if(!_1e.first){_1f=_1e.first=true;var _22=dd.register.getAttributeTags();for(i=0;tag=_22[i];i++){try{(tag[2])({swallowNode:function(){throw 1;}},new dd.Token(dd.TOKEN_ATTR,""));}catch(e){_20.push(tag);}}}for(i=0;tag=_20[i];i++){var _23=_1d.getAttribute(tag[0]);if(_23){var _20=false;var _24=(tag[2])({swallowNode:function(){_20=true;return _1d;}},new dd.Token(dd.TOKEN_ATTR,tag[0]+" "+_23));if(_20){if(_1d.parentNode&&_1d.parentNode.removeChild){_1d.parentNode.removeChild(_1d);}_1e.push([dd.TOKEN_CUSTOM,_24]);return;}}}var _25=[];if(_1.isIE&&_1d.tagName=="SCRIPT"){_25.push({nodeType:3,data:_1d.text});_1d.text="";}else{for(i=0;_21=_1d.childNodes[i];i++){_25.push(_21);}}_1e.push([dd.TOKEN_NODE,_1d]);var _26=false;if(_25.length){_1e.push([dd.TOKEN_CHANGE,_1d]);_26=true;}for(var key in this._attributes){var _27=false;var _28="";if(key=="class"){_28=_1d.className||_28;}else{if(key=="for"){_28=_1d.htmlFor||_28;}else{if(key=="value"&&_1d.value==_1d.innerHTML){continue;}else{if(_1d.getAttribute){_28=_1d.getAttribute(key,2)||_28;if(key=="href"||key=="src"){if(_1.isIE){var _29=location.href.lastIndexOf(location.hash);var _2a=location.href.substring(0,_29).split("/");_2a.pop();_2a=_2a.join("/")+"/";if(_28.indexOf(_2a)==0){_28=_28.replace(_2a,"");}_28=decodeURIComponent(_28);}}else{if(key=="tstyle"){_27=key;key="style";}else{if(dd.BOOLS[key.slice(1)]&&_1.trim(_28)){key=key.slice(1);}else{if(this._uppers[key]&&_1.trim(_28)){_27=this._uppers[key];}}}}}}}}if(_27){_1d.setAttribute(_27,"");_1d.removeAttribute(_27);}if(typeof _28=="function"){_28=_28.toString().replace(this._re4,"$1");}if(!_26){_1e.push([dd.TOKEN_CHANGE,_1d]);_26=true;}_1e.push([dd.TOKEN_ATTR,_1d,key,_28]);}for(i=0,_21;_21=_25[i];i++){if(_21.nodeType==1){var _2b=_21.getAttribute("dtlinstruction");if(_2b){_21.parentNode.removeChild(_21);_21={nodeType:8,data:_2b};}}this.__tokenize(_21,_1e);}if(!_1f&&_1d.parentNode&&_1d.parentNode.tagName){if(_26){_1e.push([dd.TOKEN_CHANGE,_1d,true]);}_1e.push([dd.TOKEN_CHANGE,_1d.parentNode]);_1d.parentNode.removeChild(_1d);}else{_1e.push([dd.TOKEN_CHANGE,_1d,true,true]);}},__tokenize:function(_2c,_2d){var _2e=_2c.data;switch(_2c.nodeType){case 1:this._tokenize(_2c,_2d);return;case 3:if(_2e.match(/[^\s\n]/)&&(_2e.indexOf("{{")!=-1||_2e.indexOf("{%")!=-1)){var _2f=_3.tokenize(_2e);for(var j=0,_30;_30=_2f[j];j++){if(typeof _30=="string"){_2d.push([dd.TOKEN_TEXT,_30]);}else{_2d.push(_30);}}}else{_2d.push([_2c.nodeType,_2c]);}if(_2c.parentNode){_2c.parentNode.removeChild(_2c);}return;case 8:if(_2e.indexOf("{%")==0){var _30=_1.trim(_2e.slice(2,-2));if(_30.substr(0,5)=="load "){var _31=_1.trim(_30).split(/\s+/g);for(var i=1,_32;_32=_31[i];i++){_1["require"](_32);}}_2d.push([dd.TOKEN_BLOCK,_30]);}if(_2e.indexOf("{{")==0){_2d.push([dd.TOKEN_VAR,_1.trim(_2e.slice(2,-2))]);}if(_2c.parentNode){_2c.parentNode.removeChild(_2c);}return;}}};dd.DomTemplate=_1.extend(function(obj){if(!obj.nodes){var _33=_1.byId(obj);if(_33&&_33.nodeType==1){_1.forEach(["class","src","href","name","value"],function(_34){_4._attributes[_34]=true;});obj={nodes:[_33]};}else{if(typeof obj=="object"){obj=_3.getTemplateString(obj);}obj=_4.getTemplate(obj);}}var _35=_4.tokenize(obj.nodes);if(dd.tests){this.tokens=_35.slice(0);}var _36=new dd._DomParser(_35);this.nodelist=_36.parse();},{_count:0,_re:/\bdojo:([a-zA-Z0-9_]+)\b/g,setClass:function(str){this.getRootNode().className=str;},getRootNode:function(){return this.buffer.rootNode;},getBuffer:function(){return new dd.DomBuffer();},render:function(_37,_38){_38=this.buffer=_38||this.getBuffer();this.rootNode=null;var _39=this.nodelist.render(_37||new dd.Context({}),_38);for(var i=0,_3a;_3a=_38._cache[i];i++){if(_3a._cache){_3a._cache.length=0;}}return _39;},unrender:function(_3b,_3c){return this.nodelist.unrender(_3b,_3c);}});dd.DomBuffer=_1.extend(function(_3d){this._parent=_3d;this._cache=[];},{concat:function(_3e){var _3f=this._parent;if(_3f&&_3e.parentNode&&_3e.parentNode===_3f&&!_3f._dirty){return this;}if(_3e.nodeType==1&&!this.rootNode){this.rootNode=_3e||true;return this;}if(!_3f){if(_3e.nodeType==3&&_1.trim(_3e.data)){throw new Error("Text should not exist outside of the root node in template");}return this;}if(this._closed){if(_3e.nodeType==3&&!_1.trim(_3e.data)){return this;}else{throw new Error("Content should not exist outside of the root node in template");}}if(_3f._dirty){if(_3e._drawn&&_3e.parentNode==_3f){var _40=_3f._cache;if(_40){for(var i=0,_41;_41=_40[i];i++){this.onAddNode&&this.onAddNode(_41);_3f.insertBefore(_41,_3e);this.onAddNodeComplete&&this.onAddNodeComplete(_41);}_40.length=0;}}_3f._dirty=false;}if(!_3f._cache){_3f._cache=[];this._cache.push(_3f);}_3f._dirty=true;_3f._cache.push(_3e);return this;},remove:function(obj){if(typeof obj=="string"){if(this._parent){this._parent.removeAttribute(obj);}}else{if(obj.nodeType==1&&!this.getRootNode()&&!this._removed){this._removed=true;return this;}if(obj.parentNode){this.onRemoveNode&&this.onRemoveNode(obj);if(obj.parentNode){obj.parentNode.removeChild(obj);}}}return this;},setAttribute:function(key,_42){var old=_1.attr(this._parent,key);if(this.onChangeAttribute&&old!=_42){this.onChangeAttribute(this._parent,key,old,_42);}if(key=="style"){this._parent.style.cssText=_42;}else{_1.attr(this._parent,key,_42);}return this;},addEvent:function(_43,_44,fn,_45){if(!_43.getThis()){throw new Error("You must use Context.setObject(instance)");}this.onAddEvent&&this.onAddEvent(this.getParent(),_44,fn);var _46=fn;if(_1.isArray(_45)){_46=function(e){this[fn].apply(this,[e].concat(_45));};}return _1.connect(this.getParent(),_44,_43.getThis(),_46);},setParent:function(_47,up,_48){if(!this._parent){this._parent=this._first=_47;}if(up&&_48&&_47===this._first){this._closed=true;}if(up){var _49=this._parent;var _4a="";var ie=_1.isIE&&_49.tagName=="SCRIPT";if(ie){_49.text="";}if(_49._dirty){var _4b=_49._cache;var _4c=(_49.tagName=="SELECT"&&!_49.options.length);for(var i=0,_4d;_4d=_4b[i];i++){if(_4d!==_49){this.onAddNode&&this.onAddNode(_4d);if(ie){_4a+=_4d.data;}else{_49.appendChild(_4d);if(_4c&&_4d.defaultSelected&&i){_4c=i;}}this.onAddNodeComplete&&this.onAddNodeComplete(_4d);}}if(_4c){_49.options.selectedIndex=(typeof _4c=="number")?_4c:0;}_4b.length=0;_49._dirty=false;}if(ie){_49.text=_4a;}}this._parent=_47;this.onSetParent&&this.onSetParent(_47,up,_48);return this;},getParent:function(){return this._parent;},getRootNode:function(){return this.rootNode;}});dd._DomNode=_1.extend(function(_4e){this.contents=_4e;},{render:function(_4f,_50){this._rendered=true;return _50.concat(this.contents);},unrender:function(_51,_52){if(!this._rendered){return _52;}this._rendered=false;return _52.remove(this.contents);},clone:function(_53){return new this.constructor(this.contents);}});dd._DomNodeList=_1.extend(function(_54){this.contents=_54||[];},{push:function(_55){this.contents.push(_55);},unshift:function(_56){this.contents.unshift(_56);},render:function(_57,_58,_59){_58=_58||dd.DomTemplate.prototype.getBuffer();if(_59){var _5a=_58.getParent();}for(var i=0;i<this.contents.length;i++){_58=this.contents[i].render(_57,_58);if(!_58){throw new Error("Template node render functions must return their buffer");}}if(_5a){_58.setParent(_5a);}return _58;},dummyRender:function(_5b,_5c,_5d){var div=document.createElement("div");var _5e=_5c.getParent();var old=_5e._clone;_5e._clone=div;var _5f=this.clone(_5c,div);if(old){_5e._clone=old;}else{_5e._clone=null;}_5c=dd.DomTemplate.prototype.getBuffer();_5f.unshift(new dd.ChangeNode(div));_5f.unshift(new dd._DomNode(div));_5f.push(new dd.ChangeNode(div,true));_5f.render(_5b,_5c);if(_5d){return _5c.getRootNode();}var _60=div.innerHTML;return (_1.isIE)?_60.replace(/\s*_(dirty|clone)="[^"]*"/g,""):_60;},unrender:function(_61,_62,_63){if(_63){var _64=_62.getParent();}for(var i=0;i<this.contents.length;i++){_62=this.contents[i].unrender(_61,_62);if(!_62){throw new Error("Template node render functions must return their buffer");}}if(_64){_62.setParent(_64);}return _62;},clone:function(_65){var _66=_65.getParent();var _67=this.contents;var _68=new dd._DomNodeList();var _69=[];for(var i=0;i<_67.length;i++){var _6a=_67[i].clone(_65);if(_6a instanceof dd.ChangeNode||_6a instanceof dd._DomNode){var _6b=_6a.contents._clone;if(_6b){_6a.contents=_6b;}else{if(_66!=_6a.contents&&_6a instanceof dd._DomNode){var _6c=_6a.contents;_6a.contents=_6a.contents.cloneNode(false);_65.onClone&&_65.onClone(_6c,_6a.contents);_69.push(_6c);_6c._clone=_6a.contents;}}}_68.push(_6a);}for(var i=0,_6a;_6a=_69[i];i++){_6a._clone=null;}return _68;},rtrim:function(){while(1){var i=this.contents.length-1;if(this.contents[i] instanceof dd._DomTextNode&&this.contents[i].isEmpty()){this.contents.pop();}else{break;}}return this;}});dd._DomVarNode=_1.extend(function(str){this.contents=new dd._Filter(str);},{render:function(_6d,_6e){var str=this.contents.resolve(_6d);var _6f="text";if(str){if(str.render&&str.getRootNode){_6f="injection";}else{if(str.safe){if(str.nodeType){_6f="node";}else{if(str.toString){str=str.toString();_6f="html";}}}}}if(this._type&&_6f!=this._type){this.unrender(_6d,_6e);}this._type=_6f;switch(_6f){case "text":this._rendered=true;this._txt=this._txt||document.createTextNode(str);if(this._txt.data!=str){var old=this._txt.data;this._txt.data=str;_6e.onChangeData&&_6e.onChangeData(this._txt,old,this._txt.data);}return _6e.concat(this._txt);case "injection":var _70=str.getRootNode();if(this._rendered&&_70!=this._root){_6e=this.unrender(_6d,_6e);}this._root=_70;var _71=this._injected=new dd._DomNodeList();_71.push(new dd.ChangeNode(_6e.getParent()));_71.push(new dd._DomNode(_70));_71.push(str);_71.push(new dd.ChangeNode(_6e.getParent()));this._rendered=true;return _71.render(_6d,_6e);case "node":this._rendered=true;if(this._node&&this._node!=str&&this._node.parentNode&&this._node.parentNode===_6e.getParent()){this._node.parentNode.removeChild(this._node);}this._node=str;return _6e.concat(str);case "html":if(this._rendered&&this._src!=str){_6e=this.unrender(_6d,_6e);}this._src=str;if(!this._rendered){this._rendered=true;this._html=this._html||[];var div=(this._div=this._div||document.createElement("div"));div.innerHTML=str;var _72=div.childNodes;while(_72.length){var _73=div.removeChild(_72[0]);this._html.push(_73);_6e=_6e.concat(_73);}}return _6e;default:return _6e;}},unrender:function(_74,_75){if(!this._rendered){return _75;}this._rendered=false;switch(this._type){case "text":return _75.remove(this._txt);case "injection":return this._injection.unrender(_74,_75);case "node":if(this._node.parentNode===_75.getParent()){return _75.remove(this._node);}return _75;case "html":for(var i=0,l=this._html.length;i<l;i++){_75=_75.remove(this._html[i]);}return _75;default:return _75;}},clone:function(){return new this.constructor(this.contents.getExpression());}});dd.ChangeNode=_1.extend(function(_76,up,_77){this.contents=_76;this.up=up;this.root=_77;},{render:function(_78,_79){return _79.setParent(this.contents,this.up,this.root);},unrender:function(_7a,_7b){if(!_7b.getParent()){return _7b;}return _7b.setParent(this.contents);},clone:function(){return new this.constructor(this.contents,this.up,this.root);}});dd.AttributeNode=_1.extend(function(key,_7c){this.key=key;this.value=_7c;this.contents=_7c;if(this._pool[_7c]){this.nodelist=this._pool[_7c];}else{if(!(this.nodelist=dd.quickFilter(_7c))){this.nodelist=(new dd.Template(_7c,true)).nodelist;}this._pool[_7c]=this.nodelist;}this.contents="";},{_pool:{},render:function(_7d,_7e){var key=this.key;var _7f=this.nodelist.dummyRender(_7d);if(dd.BOOLS[key]){_7f=!(_7f=="false"||_7f=="undefined"||!_7f);}if(_7f!==this.contents){this.contents=_7f;return _7e.setAttribute(key,_7f);}return _7e;},unrender:function(_80,_81){this.contents="";return _81.remove(this.key);},clone:function(_82){return new this.constructor(this.key,this.value);}});dd._DomTextNode=_1.extend(function(str){this.contents=document.createTextNode(str);this.upcoming=str;},{set:function(_83){this.upcoming=_83;return this;},render:function(_84,_85){if(this.contents.data!=this.upcoming){var old=this.contents.data;this.contents.data=this.upcoming;_85.onChangeData&&_85.onChangeData(this.contents,old,this.upcoming);}return _85.concat(this.contents);},unrender:function(_86,_87){return _87.remove(this.contents);},isEmpty:function(){return !_1.trim(this.contents.data);},clone:function(){return new this.constructor(this.contents.data);}});dd._DomParser=_1.extend(function(_88){this.contents=_88;},{i:0,parse:function(_89){var _8a={};var _8b=this.contents;if(!_89){_89=[];}for(var i=0;i<_89.length;i++){_8a[_89[i]]=true;}var _8c=new dd._DomNodeList();while(this.i<_8b.length){var _8d=_8b[this.i++];var _8e=_8d[0];var _8f=_8d[1];if(_8e==dd.TOKEN_CUSTOM){_8c.push(_8f);}else{if(_8e==dd.TOKEN_CHANGE){var _90=new dd.ChangeNode(_8f,_8d[2],_8d[3]);_8f[_90.attr]=_90;_8c.push(_90);}else{if(_8e==dd.TOKEN_ATTR){var fn=_3.getTag("attr:"+_8d[2],true);if(fn&&_8d[3]){if(_8d[3].indexOf("{%")!=-1||_8d[3].indexOf("{{")!=-1){_8f.setAttribute(_8d[2],"");}_8c.push(fn(null,new dd.Token(_8e,_8d[2]+" "+_8d[3])));}else{if(_1.isString(_8d[3])){if(_8d[2]=="style"||_8d[3].indexOf("{%")!=-1||_8d[3].indexOf("{{")!=-1){_8c.push(new dd.AttributeNode(_8d[2],_8d[3]));}else{if(_1.trim(_8d[3])){try{_1.attr(_8f,_8d[2],_8d[3]);}catch(e){}}}}}}else{if(_8e==dd.TOKEN_NODE){var fn=_3.getTag("node:"+_8f.tagName.toLowerCase(),true);if(fn){_8c.push(fn(null,new dd.Token(_8e,_8f),_8f.tagName.toLowerCase()));}_8c.push(new dd._DomNode(_8f));}else{if(_8e==dd.TOKEN_VAR){_8c.push(new dd._DomVarNode(_8f));}else{if(_8e==dd.TOKEN_TEXT){_8c.push(new dd._DomTextNode(_8f.data||_8f));}else{if(_8e==dd.TOKEN_BLOCK){if(_8a[_8f]){--this.i;return _8c;}var cmd=_8f.split(/\s+/g);if(cmd.length){cmd=cmd[0];var fn=_3.getTag(cmd);if(typeof fn!="function"){throw new Error("Function not found for "+cmd);}var tpl=fn(this,new dd.Token(_8e,_8f));if(tpl){_8c.push(tpl);}}}}}}}}}}if(_89.length){throw new Error("Could not find closing tag(s): "+_89.toString());}return _8c;},next_token:function(){var _91=this.contents[this.i++];return new dd.Token(_91[0],_91[1]);},delete_first_token:function(){this.i++;},skip_past:function(_92){return dd._Parser.prototype.skip_past.call(this,_92);},create_variable_node:function(_93){return new dd._DomVarNode(_93);},create_text_node:function(_94){return new dd._DomTextNode(_94||"");},getTemplate:function(loc){return new dd.DomTemplate(_4.getTemplate(loc));}});return dojox.dtl.dom;});