/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo","dojox","./_FilterExpr","../_StoreLayer"],function(_1,_2){(function(){var ns=_1.getObject("grid.enhanced.plugins",true,_2);cmdSetFilter="filter",cmdClearFilter="clear",hitchIfCan=function(_3,_4){return _4?_1.hitch(_3||_1.global,_4):function(){};},shallowClone=function(_5){var _6={};if(_5&&_1.isObject(_5)){for(var _7 in _5){_6[_7]=_5[_7];}}return _6;};_1.declare("dojox.grid.enhanced.plugins.filter._FilterLayerMixin",null,{tags:["sizeChange"],name:function(){return "filter";},onFilterDefined:function(_8){},onFiltered:function(_9,_a){}});_1.declare("dojox.grid.enhanced.plugins.filter.ServerSideFilterLayer",[ns._ServerSideLayer,ns.filter._FilterLayerMixin],{constructor:function(_b){this._onUserCommandLoad=_b.setupFilterQuery||this._onUserCommandLoad;this.filterDef(null);},filterDef:function(_c){if(_c){this._filter=_c;var _d=_c.toObject();this.command(cmdSetFilter,this._isStateful?_1.toJson(_d):_d);this.command(cmdClearFilter,null);this.useCommands(true);this.onFilterDefined(_c);}else{if(_c===null){this._filter=null;this.command(cmdSetFilter,null);this.command(cmdClearFilter,true);this.useCommands(true);this.onFilterDefined(null);}}return this._filter;},onCommandLoad:function(_e,_f){this.inherited(arguments);var _10=_f.onBegin;if(this._isStateful){var _11;if(_e){this.command(cmdSetFilter,null);this.command(cmdClearFilter,null);this.useCommands(false);var _12=_e.split(",");if(_12.length>=2){_11=this._filteredSize=parseInt(_12[0],10);this.onFiltered(_11,parseInt(_12[1],10));}else{return;}}else{_11=this._filteredSize;}if(this.enabled()){_f.onBegin=function(_13,req){hitchIfCan(_f.scope,_10)(_11,req);};}}else{var _14=this;_f.onBegin=function(_15,req){if(!_14._filter){_14._storeSize=_15;}_14.onFiltered(_15,_14._storeSize||_15);req.onBegin=_10;hitchIfCan(_f.scope,_10)(_15,req);};}}});_1.declare("dojox.grid.enhanced.plugins.filter.ClientSideFilterLayer",[ns._StoreLayer,ns.filter._FilterLayerMixin],{_storeSize:-1,_fetchAll:true,constructor:function(_16){this.filterDef(null);_16=_1.isObject(_16)?_16:{};this.fetchAllOnFirstFilter(_16.fetchAll);this._getter=_1.isFunction(_16.getter)?_16.getter:this._defaultGetter;},_defaultGetter:function(_17,_18,_19,_1a){return _1a.getValue(_17,_18);},filterDef:function(_1b){if(_1b!==undefined){this._filter=_1b;this.invalidate();this.onFilterDefined(_1b);}return this._filter;},setGetter:function(_1c){if(_1.isFunction(_1c)){this._getter=_1c;}},fetchAllOnFirstFilter:function(_1d){if(_1d!==undefined){this._fetchAll=!!_1d;}return this._fetchAll;},invalidate:function(){this._items=[];this._nextUnfetchedIdx=0;this._result=[];this._indexMap=[];this._resultStartIdx=0;},_fetch:function(_1e,_1f){if(!this._filter){var _20=_1e.onBegin,_21=this;_1e.onBegin=function(_22,r){hitchIfCan(_1e.scope,_20)(_22,r);_21.onFiltered(_22,_22);};this.originFetch(_1e);return _1e;}try{var _23=_1f?_1f._nextResultItemIdx:_1e.start;_23=_23||0;if(!_1f){this._result=[];this._resultStartIdx=_23;var _24;if(_1.isArray(_1e.sort)&&_1e.sort.length>0&&(_24=_1.toJson(_1e.sort))!=this._lastSortInfo){this.invalidate();this._lastSortInfo=_24;}}var end=typeof _1e.count=="number"?_23+_1e.count-this._result.length:this._items.length;if(this._result.length){this._result=this._result.concat(this._items.slice(_23,end));}else{this._result=this._items.slice(_1e.start,typeof _1e.count=="number"?_1e.start+_1e.count:this._items.length);}if(this._result.length>=_1e.count||this._hasReachedStoreEnd()){this._completeQuery(_1e);}else{if(!_1f){_1f=shallowClone(_1e);_1f.onBegin=_1.hitch(this,this._onFetchBegin);_1f.onComplete=_1.hitch(this,function(_25,req){this._nextUnfetchedIdx+=_25.length;this._doFilter(_25,req.start,_1e);this._fetch(_1e,req);});}_1f.start=this._nextUnfetchedIdx;if(this._fetchAll){delete _1f.count;}_1f._nextResultItemIdx=end<this._items.length?end:this._items.length;this.originFetch(_1f);}}catch(e){if(_1e.onError){hitchIfCan(_1e.scope,_1e.onError)(e,_1e);}else{throw e;}}return _1e;},_hasReachedStoreEnd:function(){return this._storeSize>=0&&this._nextUnfetchedIdx>=this._storeSize;},_applyFilter:function(_26,_27){var g=this._getter,s=this._store;try{return !!(this._filter.applyRow(_26,function(_28,arg){return g(_28,arg,_27,s);}).getValue());}catch(e){console.warn("FilterLayer._applyFilter() error: ",e);return false;}},_doFilter:function(_29,_2a,_2b){for(var i=0,cnt=0;i<_29.length;++i){if(this._applyFilter(_29[i],_2a+i)){hitchIfCan(_2b.scope,_2b.onItem)(_29[i],_2b);cnt+=this._addCachedItems(_29[i],this._items.length);this._indexMap.push(_2a+i);}}},_onFetchBegin:function(_2c,req){this._storeSize=_2c;},_completeQuery:function(_2d){var _2e=this._items.length;if(this._nextUnfetchedIdx<this._storeSize){_2e++;}hitchIfCan(_2d.scope,_2d.onBegin)(_2e,_2d);this.onFiltered(this._items.length,this._storeSize);hitchIfCan(_2d.scope,_2d.onComplete)(this._result,_2d);},_addCachedItems:function(_2f,_30){if(!_1.isArray(_2f)){_2f=[_2f];}for(var k=0;k<_2f.length;++k){this._items[_30+k]=_2f[k];}return _2f.length;},onRowMappingChange:function(_31){if(this._filter){var m=_1.clone(_31),_32={};for(var r in m){r=parseInt(r,10);_31[this._indexMap[r]]=this._indexMap[m[r]];if(!_32[this._indexMap[r]]){_32[this._indexMap[r]]=true;}if(!_32[r]){_32[r]=true;delete _31[r];}}}}});})();return _2.grid.enhanced.plugins.filter.FilterLayer;});