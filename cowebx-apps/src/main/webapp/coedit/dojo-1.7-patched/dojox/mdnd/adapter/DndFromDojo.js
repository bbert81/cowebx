/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo","dijit","dojox","dojox/mdnd/AreaManager","dojo/dnd/Manager"],function(_1,_2,_3){_1.getObject("dojox.mdnd.adapter.DndFromDojo",1);_1.declare("dojox.mdnd.adapter.DndFromDojo",null,{dropIndicatorSize:{"w":0,"h":50},dropIndicatorSize:{"w":0,"h":50},_areaManager:null,_dojoManager:null,_currentArea:null,_oldArea:null,_moveHandler:null,_subscribeHandler:null,constructor:function(){this._areaManager=_3.mdnd.areaManager();this._dojoManager=_1.dnd.manager();this._currentArea=null;this._moveHandler=null;this.subscribeDnd();},subscribeDnd:function(){this._subscribeHandler=[_1.subscribe("/dnd/start",this,"onDragStart"),_1.subscribe("/dnd/drop/before",this,"onDrop"),_1.subscribe("/dnd/cancel",this,"onDropCancel"),_1.subscribe("/dnd/source/over",this,"onDndSource")];},unsubscribeDnd:function(){_1.forEach(this._subscribeHandler,_1.unsubscribe);},_getHoverArea:function(_4){var x=_4.x;var y=_4.y;this._oldArea=this._currentArea;this._currentArea=null;var _5=this._areaManager._areaList;for(var i=0;i<_5.length;i++){var _6=_5[i];var _7=_6.coords.x;var _8=_7+_6.node.offsetWidth;var _9=_6.coords.y;var _a=_9+_6.node.offsetHeight;if(_7<=x&&x<=_8&&_9<=y&&y<=_a){this._areaManager._oldIndexArea=this._areaManager._currentIndexArea;this._areaManager._currentIndexArea=i;this._currentArea=_6.node;break;}}if(this._currentArea!=this._oldArea){if(this._currentArea==null){this.onDragExit();}else{if(this._oldArea==null){this.onDragEnter();}else{this.onDragExit();this.onDragEnter();}}}},onDragStart:function(_b,_c,_d){this._dragNode=_c[0];this._copy=_d;this._source=_b;this._outSourceHandler=_1.connect(this._dojoManager,"outSource",this,function(){if(this._moveHandler==null){this._moveHandler=_1.connect(_1.doc,"mousemove",this,"onMouseMove");}});},onMouseMove:function(e){var _e={"x":e.pageX,"y":e.pageY};this._getHoverArea(_e);if(this._currentArea&&this._areaManager._accept){if(this._areaManager._dropIndicator.node.style.visibility=="hidden"){this._areaManager._dropIndicator.node.style.visibility="";_1.addClass(this._dojoManager.avatar.node,"dojoDndAvatarCanDrop");}this._areaManager.placeDropIndicator(_e,this.dropIndicatorSize);}},onDragEnter:function(){var _f=this._dragNode.getAttribute("dndType");var _10=(_f)?_f.split(/\s*,\s*/):["text"];this._areaManager._isAccepted(_10,this._areaManager._areaList[this._areaManager._currentIndexArea].accept);if(this._dojoManager.avatar){if(this._areaManager._accept){_1.addClass(this._dojoManager.avatar.node,"dojoDndAvatarCanDrop");}else{_1.removeClass(this._dojoManager.avatar.node,"dojoDndAvatarCanDrop");}}},onDragExit:function(){this._areaManager._accept=false;if(this._dojoManager.avatar){_1.removeClass(this._dojoManager.avatar.node,"dojoDndAvatarCanDrop");}if(this._currentArea==null){this._areaManager._dropMode.refreshItems(this._areaManager._areaList[this._areaManager._oldIndexArea],this._areaManager._oldDropIndex,this.dropIndicatorSize,false);this._areaManager._resetAfterDrop();}else{this._areaManager._dropIndicator.remove();}},isAccepted:function(_11,_12){var _13=(_11.getAttribute("dndType"))?_11.getAttribute("dndType"):"text";if(_13&&_13 in _12){return true;}else{return false;}},onDndSource:function(_14){if(this._currentArea==null){return;}if(_14){var _15=false;if(this._dojoManager.target==_14){_15=true;}else{_15=this.isAccepted(this._dragNode,_14.accept);}if(_15){_1.disconnect(this._moveHandler);this._currentArea=this._moveHandler=null;var _16=this._areaManager._dropIndicator.node;if(_16&&_16.parentNode!==null&&_16.parentNode.nodeType==1){_16.style.visibility="hidden";}}else{this._resetAvatar();}}else{if(!this._moveHandler){this._moveHandler=_1.connect(_1.doc,"mousemove",this,"onMouseMove");}this._resetAvatar();}},_resetAvatar:function(){if(this._dojoManager.avatar){if(this._areaManager._accept){_1.addClass(this._dojoManager.avatar.node,"dojoDndAvatarCanDrop");}else{_1.removeClass(this._dojoManager.avatar.node,"dojoDndAvatarCanDrop");}}},onDropCancel:function(){if(this._currentArea==null){this._areaManager._resetAfterDrop();_1.disconnect(this._moveHandler);_1.disconnect(this._outSourceHandler);this._currentArea=this._moveHandler=this._outSourceHandler=null;}else{if(this._areaManager._accept){this.onDrop(this._source,[this._dragNode],this._copy,this._currentArea);}else{this._currentArea=null;_1.disconnect(this._outSourceHandler);_1.disconnect(this._moveHandler);this._moveHandler=this._outSourceHandler=null;}}},onDrop:function(_17,_18,_19){_1.disconnect(this._moveHandler);_1.disconnect(this._outSourceHandler);this._moveHandler=this._outSourceHandler=null;if(this._currentArea){var _1a=this._areaManager._currentDropIndex;_1.publish("/dnd/drop/after",[_17,_18,_19,this._currentArea,_1a]);this._currentArea=null;}if(this._areaManager._dropIndicator.node.style.visibility=="hidden"){this._areaManager._dropIndicator.node.style.visibility="";}this._areaManager._resetAfterDrop();}});_3.mdnd.adapter._dndFromDojo=null;(function(){_3.mdnd.adapter._dndFromDojo=new _3.mdnd.adapter.DndFromDojo();}());});require(["dojox/mdnd/adapter/DndFromDojo"]);