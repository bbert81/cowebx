/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/lang","dojo/_base/declare","./Default","./common","dojox/lang/functional","dojox/lang/functional/reversed","dojox/lang/functional/sequence"],function(_1,_2,_3,dc,df,_4,_5){var _6=df.lambda("item.purgeGroup()");return _1.declare("dojox.charting.plot2d.Stacked",dojox.charting.plot2d.Default,{getSeriesStats:function(){var _7=dc.collectStackedStats(this.series);this._maxRunLength=_7.hmax;return _7;},render:function(_8,_9){if(this._maxRunLength<=0){return this;}var _a=df.repeat(this._maxRunLength,"-> 0",0);for(var i=0;i<this.series.length;++i){var _b=this.series[i];for(var j=0;j<_b.data.length;++j){var v=_b.data[j];if(v!==null){if(isNaN(v)){v=0;}_a[j]+=v;}}}if(this.zoom&&!this.isDataDirty()){return this.performZoom(_8,_9);}this.resetEvents();this.dirty=this.isDirty();if(this.dirty){_1.forEach(this.series,_6);this._eventSeries={};this.cleanGroup();var s=this.group;df.forEachRev(this.series,function(_c){_c.cleanGroup(s);});}var t=this.chart.theme,_d=this.events(),ht=this._hScaler.scaler.getTransformerFromModel(this._hScaler),vt=this._vScaler.scaler.getTransformerFromModel(this._vScaler);for(var i=this.series.length-1;i>=0;--i){var _b=this.series[i];if(!this.dirty&&!_b.dirty){t.skip();this._reconnectEvents(_b.name);continue;}_b.cleanGroup();var _e=t.next(this.opt.areas?"area":"line",[this.opt,_b],true),s=_b.group,_f,_10=_1.map(_a,function(v,i){return {x:ht(i+1)+_9.l,y:_8.height-_9.b-vt(v)};},this);var _11=this.opt.tension?dc.curve(_10,this.opt.tension):"";if(this.opt.areas){var _12=_1.clone(_10);if(this.opt.tension){var p=dc.curve(_12,this.opt.tension);p+=" L"+_10[_10.length-1].x+","+(_8.height-_9.b)+" L"+_10[0].x+","+(_8.height-_9.b)+" L"+_10[0].x+","+_10[0].y;_b.dyn.fill=s.createPath(p).setFill(_e.series.fill).getFill();}else{_12.push({x:_10[_10.length-1].x,y:_8.height-_9.b});_12.push({x:_10[0].x,y:_8.height-_9.b});_12.push(_10[0]);_b.dyn.fill=s.createPolyline(_12).setFill(_e.series.fill).getFill();}}if(this.opt.lines||this.opt.markers){if(_e.series.outline){_f=dc.makeStroke(_e.series.outline);_f.width=2*_f.width+_e.series.stroke.width;}}if(this.opt.markers){_b.dyn.marker=_e.symbol;}var _13,_14,_15;if(_e.series.shadow&&_e.series.stroke){var _16=_e.series.shadow,_17=_1.map(_10,function(c){return {x:c.x+_16.dx,y:c.y+_16.dy};});if(this.opt.lines){if(this.opt.tension){_b.dyn.shadow=s.createPath(dc.curve(_17,this.opt.tension)).setStroke(_16).getStroke();}else{_b.dyn.shadow=s.createPolyline(_17).setStroke(_16).getStroke();}}if(this.opt.markers){_16=_e.marker.shadow;_15=_1.map(_17,function(c){return s.createPath("M"+c.x+" "+c.y+" "+_e.symbol).setStroke(_16).setFill(_16.color);},this);}}if(this.opt.lines){if(_f){if(this.opt.tension){_b.dyn.outline=s.createPath(_11).setStroke(_f).getStroke();}else{_b.dyn.outline=s.createPolyline(_10).setStroke(_f).getStroke();}}if(this.opt.tension){_b.dyn.stroke=s.createPath(_11).setStroke(_e.series.stroke).getStroke();}else{_b.dyn.stroke=s.createPolyline(_10).setStroke(_e.series.stroke).getStroke();}}if(this.opt.markers){_13=new Array(_10.length);_14=new Array(_10.length);_f=null;if(_e.marker.outline){_f=dc.makeStroke(_e.marker.outline);_f.width=2*_f.width+(_e.marker.stroke?_e.marker.stroke.width:0);}_1.forEach(_10,function(c,i){var _18="M"+c.x+" "+c.y+" "+_e.symbol;if(_f){_14[i]=s.createPath(_18).setStroke(_f);}_13[i]=s.createPath(_18).setStroke(_e.marker.stroke).setFill(_e.marker.fill);},this);if(_d){var _19=new Array(_13.length);_1.forEach(_13,function(s,i){var o={element:"marker",index:i,run:_b,shape:s,outline:_14[i]||null,shadow:_15&&_15[i]||null,cx:_10[i].x,cy:_10[i].y,x:i+1,y:_b.data[i]};this._connectEvents(o);_19[i]=o;},this);this._eventSeries[_b.name]=_19;}else{delete this._eventSeries[_b.name];}}_b.dirty=false;for(var j=0;j<_b.data.length;++j){var v=_b.data[j];if(v!==null){if(isNaN(v)){v=0;}_a[j]-=v;}}}this.dirty=false;return this;}});});