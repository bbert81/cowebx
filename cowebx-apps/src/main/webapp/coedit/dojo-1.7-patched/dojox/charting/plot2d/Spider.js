/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/lang","dojo/_base/declare","dojo/_base/connect","dojo/_base/html","../Element","./_PlotEvents","dojo/_base/Color","dojox/color/_base","./common","../axis2d/common","../scaler/primitive","dojox/gfx","dojox/gfx/matrix","dojox/gfx/fx","dojox/lang/functional","dojox/lang/utils","dojo/fx","dojo/fx/easing"],function(_1,_2,_3,_4,_5,_6,_7,_8,dc,da,_9,g,m,_a,df,du,fx,_b){var _c=0.2;_1.declare("dojox.charting.plot2d.Spider",[dojox.charting.Element,dojox.charting.plot2d._PlotEvents],{defaultParams:{labels:true,ticks:false,fixed:true,precision:1,labelOffset:-10,labelStyle:"default",htmlLabels:true,startAngle:-90,divisions:3,axisColor:"",axisWidth:0,spiderColor:"",spiderWidth:0,seriesWidth:0,seriesFillAlpha:0.2,spiderOrigin:0.16,markerSize:3,spiderType:"polygon",animationType:_b.backOut,axisTickFont:"",axisTickFontColor:"",axisFont:"",axisFontColor:""},optionalParams:{radius:0,font:"",fontColor:""},constructor:function(_d,_e){this.opt=_1.clone(this.defaultParams);du.updateWithObject(this.opt,_e);du.updateWithPattern(this.opt,_e,this.optionalParams);this.series=[];this.dyn=[];this.datas={};this.labelKey=[];this.oldSeriePoints={};this.animations={};},clear:function(){this.dirty=true;this.dyn=[];this.series=[];this.datas={};this.labelKey=[];this.oldSeriePoints={};this.animations={};return this;},setAxis:function(_f){return this;},addSeries:function(run){var _10=false;this.series.push(run);for(var key in run.data){var val=run.data[key],_11=this.datas[key];if(_11){_11.vlist.push(val);_11.min=Math.min(_11.min,val);_11.max=Math.max(_11.max,val);}else{this.datas[key]={min:val,max:val,vlist:[val]};}}if(this.labelKey.length<=0){for(var key in run.data){this.labelKey.push(key);}}return this;},getSeriesStats:function(){return dc.collectSimpleStats(this.series);},calculateAxes:function(dim){this.initializeScalers(dim,this.getSeriesStats());return this;},getRequiredColors:function(){return this.series.length;},initializeScalers:function(dim,_12){if(this._hAxis){if(!this._hAxis.initialized()){this._hAxis.calculate(_12.hmin,_12.hmax,dim.width);}this._hScaler=this._hAxis.getScaler();}else{this._hScaler=_9.buildScaler(_12.hmin,_12.hmax,dim.width);}if(this._vAxis){if(!this._vAxis.initialized()){this._vAxis.calculate(_12.vmin,_12.vmax,dim.height);}this._vScaler=this._vAxis.getScaler();}else{this._vScaler=_9.buildScaler(_12.vmin,_12.vmax,dim.height);}return this;},render:function(dim,_13){if(!this.dirty){return this;}this.dirty=false;this.cleanGroup();var s=this.group,t=this.chart.theme;this.resetEvents();if(!this.series||!this.series.length){return this;}var o=this.opt,ta=t.axis,rx=(dim.width-_13.l-_13.r)/2,ry=(dim.height-_13.t-_13.b)/2,r=Math.min(rx,ry),_14=o.font||(ta.majorTick&&ta.majorTick.font)||(ta.tick&&ta.tick.font)||"normal normal normal 7pt Tahoma",_15=o.axisFont||(ta.tick&&ta.tick.titleFont)||"normal normal normal 11pt Tahoma",_16=o.axisTickFontColor||(ta.majorTick&&ta.majorTick.fontColor)||(ta.tick&&ta.tick.fontColor)||"silver",_17=o.axisFontColor||(ta.tick&&ta.tick.titleFontColor)||"black",_18=o.axisColor||(ta.tick&&ta.tick.axisColor)||"silver",_19=o.spiderColor||(ta.tick&&ta.tick.spiderColor)||"silver",_1a=o.axisWidth||(ta.stroke&&ta.stroke.width)||2,_1b=o.spiderWidth||(ta.stroke&&ta.stroke.width)||2,_1c=o.seriesWidth||(ta.stroke&&ta.stroke.width)||2,_1d=g.normalizedLength(g.splitFontString(_15).size),_1e=m._degToRad(o.startAngle),_1f=_1e,_20,_21,_22,_23,_24,_25,_26,_27,_28,_29,_2a,ro=o.spiderOrigin,dv=o.divisions>=3?o.divisions:3,ms=o.markerSize,spt=o.spiderType,at=o.animationType,_2b=o.labelOffset<-10?o.labelOffset:-10,_2c=0.2;if(o.labels){_23=_1.map(this.series,function(s){return s.name;},this);_24=df.foldl1(df.map(_23,function(_2d,i){var _2e=t.series.font;return g._base._getTextBox(_2d,{font:_2e}).w;},this),"Math.max(a, b)")/2;r=Math.min(rx-2*_24,ry-_1d)+_2b;_25=r-_2b;}if("radius" in o){r=o.radius;_25=r-_2b;}r/=(1+_2c);var _2f={cx:_13.l+rx,cy:_13.t+ry,r:r};for(var i=this.series.length-1;i>=0;i--){var _30=this.series[i];if(!this.dirty&&!_30.dirty){t.skip();continue;}_30.cleanGroup();var run=_30.data;if(run!==null){var len=this._getObjectLength(run);if(!_26||_26.length<=0){_26=[],_27=[],_2a=[];this._buildPoints(_26,len,_2f,r,_1f,true);this._buildPoints(_27,len,_2f,r*ro,_1f,true);this._buildPoints(_2a,len,_2f,_25,_1f);if(dv>2){_28=[],_29=[];for(var j=0;j<dv-2;j++){_28[j]=[];this._buildPoints(_28[j],len,_2f,r*(ro+(1-ro)*(j+1)/(dv-1)),_1f,true);_29[j]=r*(ro+(1-ro)*(j+1)/(dv-1));}}}}}var _31=s.createGroup(),_32={color:_18,width:_1a},_33={color:_19,width:_1b};for(var j=_26.length-1;j>=0;--j){var _34=_26[j],st={x:_34.x+(_34.x-_2f.cx)*_2c,y:_34.y+(_34.y-_2f.cy)*_2c},nd={x:_34.x+(_34.x-_2f.cx)*_2c/2,y:_34.y+(_34.y-_2f.cy)*_2c/2};_31.createLine({x1:_2f.cx,y1:_2f.cy,x2:st.x,y2:st.y}).setStroke(_32);this._drawArrow(_31,st,nd,_32);}var _35=s.createGroup();for(var j=_2a.length-1;j>=0;--j){var _34=_2a[j],_36=g._base._getTextBox(this.labelKey[j],{font:_15}).w||0,_37=this.opt.htmlLabels&&g.renderer!="vml"?"html":"gfx",_38=da.createText[_37](this.chart,_35,(!_1._isBodyLtr()&&_37=="html")?(_34.x+_36-dim.width):_34.x,_34.y,"middle",this.labelKey[j],_15,_17);if(this.opt.htmlLabels){this.htmlElements.push(_38);}}var _39=s.createGroup();if(spt=="polygon"){_39.createPolyline(_26).setStroke(_33);_39.createPolyline(_27).setStroke(_33);if(_28.length>0){for(var j=_28.length-1;j>=0;--j){_39.createPolyline(_28[j]).setStroke(_33);}}}else{var _3a=this._getObjectLength(this.datas);_39.createCircle({cx:_2f.cx,cy:_2f.cy,r:r}).setStroke(_33);_39.createCircle({cx:_2f.cx,cy:_2f.cy,r:r*ro}).setStroke(_33);if(_29.length>0){for(var j=_29.length-1;j>=0;--j){_39.createCircle({cx:_2f.cx,cy:_2f.cy,r:_29[j]}).setStroke(_33);}}}var _3b=s.createGroup(),len=this._getObjectLength(this.datas),k=0;for(var key in this.datas){var _3c=this.datas[key],min=_3c.min,max=_3c.max,_3d=max-min,end=_1f+2*Math.PI*k/len;for(var i=0;i<dv;i++){var _3e=min+_3d*i/(dv-1),_34=this._getCoordinate(_2f,r*(ro+(1-ro)*i/(dv-1)),end);_3e=this._getLabel(_3e);var _36=g._base._getTextBox(_3e,{font:_14}).w||0,_37=this.opt.htmlLabels&&g.renderer!="vml"?"html":"gfx";if(this.opt.htmlLabels){this.htmlElements.push(da.createText[_37](this.chart,_3b,(!_1._isBodyLtr()&&_37=="html")?(_34.x+_36-dim.width):_34.x,_34.y,"start",_3e,_14,_16));}}k++;}this.chart.seriesShapes={};var _3f=[];for(var i=this.series.length-1;i>=0;i--){var _30=this.series[i],run=_30.data;if(run!==null){var _40=[],k=0,_41=[];for(var key in run){var _3c=this.datas[key],min=_3c.min,max=_3c.max,_3d=max-min,_42=run[key],end=_1f+2*Math.PI*k/len,_34=this._getCoordinate(_2f,r*(ro+(1-ro)*(_42-min)/_3d),end);_40.push(_34);_41.push({sname:_30.name,key:key,data:_42});k++;}_40[_40.length]=_40[0];_41[_41.length]=_41[0];var _43=this._getBoundary(_40),_44=t.next("spider",[o,_30]),ts=_30.group,f=g.normalizeColor(_44.series.fill),sk={color:_44.series.fill,width:_1c};f.a=o.seriesFillAlpha;_30.dyn={fill:f,stroke:sk};var _45=this.oldSeriePoints[_30.name];var cs=this._createSeriesEntry(ts,(_45||_27),_40,f,sk,r,ro,ms,at);this.chart.seriesShapes[_30.name]=cs;this.oldSeriePoints[_30.name]=_40;var po={element:"spider_poly",index:i,id:"spider_poly_"+_30.name,run:_30,plot:this,shape:cs.poly,parent:ts,brect:_43,cx:_2f.cx,cy:_2f.cy,cr:r,f:f,s:s};this._connectEvents(po);var so={element:"spider_plot",index:i,id:"spider_plot_"+_30.name,run:_30,plot:this,shape:_30.group};this._connectEvents(so);_1.forEach(cs.circles,function(c,i){var _46=c.getShape(),co={element:"spider_circle",index:i,id:"spider_circle_"+_30.name+i,run:_30,plot:this,shape:c,parent:ts,tdata:_41[i],cx:_40[i].x,cy:_40[i].y,f:f,s:s};this._connectEvents(co);},this);}}return this;},_createSeriesEntry:function(ts,_47,sps,f,sk,r,ro,ms,at){var _48=ts.createPolyline(_47).setFill(f).setStroke(sk),_49=[];for(var j=0;j<_47.length;j++){var _4a=_47[j],cr=ms;var _4b=ts.createCircle({cx:_4a.x,cy:_4a.y,r:cr}).setFill(f).setStroke(sk);_49.push(_4b);}var _4c=_1.map(sps,function(np,j){var sp=_47[j],_4d=new _1._Animation({duration:1000,easing:at,curve:[sp.y,np.y]});var spl=_48,sc=_49[j];_1.connect(_4d,"onAnimate",function(y){var _4e=spl.getShape();_4e.points[j].y=y;spl.setShape(_4e);var _4f=sc.getShape();_4f.cy=y;sc.setShape(_4f);});return _4d;});var _50=_1.map(sps,function(np,j){var sp=_47[j],_51=new _1._Animation({duration:1000,easing:at,curve:[sp.x,np.x]});var spl=_48,sc=_49[j];_1.connect(_51,"onAnimate",function(x){var _52=spl.getShape();_52.points[j].x=x;spl.setShape(_52);var _53=sc.getShape();_53.cx=x;sc.setShape(_53);});return _51;});var _54=fx.combine(_4c.concat(_50));_54.play();return {group:ts,poly:_48,circles:_49};},plotEvent:function(o){var _55=o.id?o.id:"default",a;if(_55 in this.animations){a=this.animations[_55];a.anim&&a.anim.stop(true);}else{a=this.animations[_55]={};}if(o.element=="spider_poly"){if(!a.color){var _56=o.shape.getFill();if(!_56||!(_56 instanceof _1.Color)){return;}a.color={start:_56,end:_57(_56)};}var _58=a.color.start,end=a.color.end;if(o.type=="onmouseout"){var t=_58;_58=end;end=t;}a.anim=_a.animateFill({shape:o.shape,duration:800,easing:fx.easing.backOut,color:{start:_58,end:end}});a.anim.play();}else{if(o.element=="spider_circle"){var _59,_5a,_5b=1.5;if(o.type=="onmouseover"){_59=m.identity;_5a=_5b;var _5c={type:"rect"};_5c.x=o.cx;_5c.y=o.cy;_5c.width=_5c.height=1;var lt=_1.coords(this.chart.node,true);_5c.x+=lt.x;_5c.y+=lt.y;_5c.x=Math.round(_5c.x);_5c.y=Math.round(_5c.y);_5c.width=Math.ceil(_5c.width);_5c.height=Math.ceil(_5c.height);this.aroundRect=_5c;var _5d=["after","before"];if(dijit&&dijit.Tooltip){dijit.showTooltip(o.tdata.sname+"<br/>"+o.tdata.key+"<br/>"+o.tdata.data,this.aroundRect,_5d);}}else{_59=m.scaleAt(_5b,o.cx,o.cy);_5a=1/_5b;if(dijit&&dijit.Tooltip){this.aroundRect&&dijit.hideTooltip(this.aroundRect);}}var cs=o.shape.getShape(),_59=m.scaleAt(_5b,cs.cx,cs.cy),_5e={shape:o.shape,duration:200,easing:_b.backOut,transform:[{name:"scaleAt",start:[1,cs.cx,cs.cy],end:[_5a,cs.cx,cs.cy]},_59]};a.anim=_a.animateTransform(_5e);a.anim.play();}else{if(o.element=="spider_plot"){if(o.type=="onmouseover"&&!_1.isIE){o.shape.moveToFront();}}}}},_getBoundary:function(_5f){var _60=_5f[0].x,_61=_5f[0].x,_62=_5f[0].y,_63=_5f[0].y;for(var i=0;i<_5f.length;i++){var _64=_5f[i];_60=Math.max(_64.x,_60);_62=Math.max(_64.y,_62);_61=Math.min(_64.x,_61);_63=Math.min(_64.y,_63);}return {x:_61,y:_63,width:_60-_61,height:_62-_63};},_drawArrow:function(s,_65,end,_66){var len=Math.sqrt(Math.pow(end.x-_65.x,2)+Math.pow(end.y-_65.y,2)),sin=(end.y-_65.y)/len,cos=(end.x-_65.x)/len,_67={x:end.x+(len/3)*(-sin),y:end.y+(len/3)*cos},_68={x:end.x+(len/3)*sin,y:end.y+(len/3)*(-cos)};s.createPolyline([_65,_67,_68]).setFill(_66.color).setStroke(_66);},_buildPoints:function(_69,_6a,_6b,_6c,_6d,_6e){for(var i=0;i<_6a;i++){var end=_6d+2*Math.PI*i/_6a;_69.push(this._getCoordinate(_6b,_6c,end));}if(_6e){_69.push(this._getCoordinate(_6b,_6c,_6d+2*Math.PI));}},_getCoordinate:function(_6f,_70,_71){return {x:_6f.cx+_70*Math.cos(_71),y:_6f.cy+_70*Math.sin(_71)};},_getObjectLength:function(obj){var _72=0;if(_1.isObject(obj)){for(var key in obj){_72++;}}return _72;},_getLabel:function(_73){return dc.getLabel(_73,this.opt.fixed,this.opt.precision);}});function _57(_74){var a=new _8.Color(_74),x=a.toHsl();if(x.s==0){x.l=x.l<50?100:0;}else{x.s=100;if(x.l<50){x.l=75;}else{if(x.l>75){x.l=50;}else{x.l=x.l-50>75-x.l?50:75;}}}var _74=_8.fromHsl(x);_74.a=0.7;return _74;};return dojox.charting.plot2d.Spider;});