/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/lang","dojo/_base/declare","dojo/_base/connect","dojo/_base/html","./Invisible","../scaler/common","../scaler/linear","./common","dojox/gfx","dojox/lang/utils"],function(_1,_2,_3,_4,_5,_6,_7,_8,g,du){var _9=4,_a=45;return _1.declare("dojox.charting.axis2d.Default",dojox.charting.axis2d.Invisible,{defaultParams:{vertical:false,fixUpper:"none",fixLower:"none",natural:false,leftBottom:true,includeZero:false,fixed:true,majorLabels:true,minorTicks:true,minorLabels:true,microTicks:false,rotation:0,htmlLabels:true,enableCache:false},optionalParams:{min:0,max:1,from:0,to:1,majorTickStep:4,minorTickStep:2,microTickStep:1,labels:[],labelFunc:null,maxLabelSize:0,maxLabelCharCount:0,trailingSymbol:null,stroke:{},majorTick:{},minorTick:{},microTick:{},tick:{},font:"",fontColor:"",title:"",titleGap:0,titleFont:"",titleFontColor:"",titleOrientation:""},constructor:function(_b,_c){this.opt=_1.clone(this.defaultParams);du.updateWithObject(this.opt,_c);du.updateWithPattern(this.opt,_c,this.optionalParams);if(this.opt.enableCache){this._textFreePool=[];this._lineFreePool=[];this._textUsePool=[];this._lineUsePool=[];}},getOffsets:function(){var s=this.scaler,_d={l:0,r:0,t:0,b:0};if(!s){return _d;}var o=this.opt,_e=0,a,b,c,d,gl=_6.getNumericLabel,_f=0,ma=s.major,mi=s.minor,ta=this.chart.theme.axis,_10=o.font||(ta.majorTick&&ta.majorTick.font)||(ta.tick&&ta.tick.font),_11=o.titleFont||(ta.tick&&ta.tick.titleFont),_12=(o.titleGap==0)?0:o.titleGap||(ta.tick&&ta.tick.titleGap)||15,_13=this.chart.theme.getTick("major",o),_14=this.chart.theme.getTick("minor",o),_15=_10?g.normalizedLength(g.splitFontString(_10).size):0,_16=_11?g.normalizedLength(g.splitFontString(_11).size):0,_17=o.rotation%360,_18=o.leftBottom,_19=Math.abs(Math.cos(_17*Math.PI/180)),_1a=Math.abs(Math.sin(_17*Math.PI/180));this.trailingSymbol=(o.trailingSymbol===undefined||o.trailingSymbol===null)?this.trailingSymbol:o.trailingSymbol;if(_17<0){_17+=360;}if(_15){if(this.labels){_e=this._groupLabelWidth(this.labels,_10,o.maxLabelCharCount);}else{_e=this._groupLabelWidth([gl(ma.start,ma.prec,o),gl(ma.start+ma.count*ma.tick,ma.prec,o),gl(mi.start,mi.prec,o),gl(mi.start+mi.count*mi.tick,mi.prec,o)],_10,o.maxLabelCharCount);}_e=o.maxLabelSize?Math.min(o.maxLabelSize,_e):_e;if(this.vertical){var _1b=_18?"l":"r";switch(_17){case 0:case 180:_d[_1b]=_e;_d.t=_d.b=_15/2;break;case 90:case 270:_d[_1b]=_15;_d.t=_d.b=_e/2;break;default:if(_17<=_a||(180<_17&&_17<=(180+_a))){_d[_1b]=_15*_1a/2+_e*_19;_d[_18?"t":"b"]=_15*_19/2+_e*_1a;_d[_18?"b":"t"]=_15*_19/2;}else{if(_17>(360-_a)||(180>_17&&_17>(180-_a))){_d[_1b]=_15*_1a/2+_e*_19;_d[_18?"b":"t"]=_15*_19/2+_e*_1a;_d[_18?"t":"b"]=_15*_19/2;}else{if(_17<90||(180<_17&&_17<270)){_d[_1b]=_15*_1a+_e*_19;_d[_18?"t":"b"]=_15*_19+_e*_1a;}else{_d[_1b]=_15*_1a+_e*_19;_d[_18?"b":"t"]=_15*_19+_e*_1a;}}}break;}_d[_1b]+=_9+Math.max(_13.length,_14.length)+(o.title?(_16+_12):0);}else{var _1b=_18?"b":"t";switch(_17){case 0:case 180:_d[_1b]=_15;_d.l=_d.r=_e/2;break;case 90:case 270:_d[_1b]=_e;_d.l=_d.r=_15/2;break;default:if((90-_a)<=_17&&_17<=90||(270-_a)<=_17&&_17<=270){_d[_1b]=_15*_1a/2+_e*_19;_d[_18?"r":"l"]=_15*_19/2+_e*_1a;_d[_18?"l":"r"]=_15*_19/2;}else{if(90<=_17&&_17<=(90+_a)||270<=_17&&_17<=(270+_a)){_d[_1b]=_15*_1a/2+_e*_19;_d[_18?"l":"r"]=_15*_19/2+_e*_1a;_d[_18?"r":"l"]=_15*_19/2;}else{if(_17<_a||(180<_17&&_17<(180-_a))){_d[_1b]=_15*_1a+_e*_19;_d[_18?"r":"l"]=_15*_19+_e*_1a;}else{_d[_1b]=_15*_1a+_e*_19;_d[_18?"l":"r"]=_15*_19+_e*_1a;}}}break;}_d[_1b]+=_9+Math.max(_13.length,_14.length)+(o.title?(_16+_12):0);}}if(_e){this._cachedLabelWidth=_e;}return _d;},cleanGroup:function(_1c){if(this.opt.enableCache&&this.group){this._lineFreePool=this._lineFreePool.concat(this._lineUsePool);this._lineUsePool=[];this._textFreePool=this._textFreePool.concat(this._textUsePool);this._textUsePool=[];}this.inherited(arguments);},createText:function(_1d,_1e,x,y,_1f,_20,_21,_22,_23){if(!this.opt.enableCache||_1d=="html"){return _8.createText[_1d](this.chart,_1e,x,y,_1f,_20,_21,_22,_23);}var _24;if(this._textFreePool.length>0){_24=this._textFreePool.pop();_24.setShape({x:x,y:y,text:_20,align:_1f});_1e.add(_24);}else{_24=_8.createText[_1d](this.chart,_1e,x,y,_1f,_20,_21,_22,_23);}this._textUsePool.push(_24);return _24;},createLine:function(_25,_26){var _27;if(this.opt.enableCache&&this._lineFreePool.length>0){_27=this._lineFreePool.pop();_27.setShape(_26);_25.add(_27);}else{_27=_25.createLine(_26);}if(this.opt.enableCache){this._lineUsePool.push(_27);}return _27;},render:function(dim,_28){if(!this.dirty){return this;}var o=this.opt,ta=this.chart.theme.axis,_29=o.leftBottom,_2a=o.rotation%360,_2b,_2c,_2d,_2e=0,_2f,_30,_31,_32,_33,_34,_35=o.font||(ta.majorTick&&ta.majorTick.font)||(ta.tick&&ta.tick.font),_36=o.titleFont||(ta.tick&&ta.tick.titleFont),_37=o.fontColor||(ta.majorTick&&ta.majorTick.fontColor)||(ta.tick&&ta.tick.fontColor)||"black",_38=o.titleFontColor||(ta.tick&&ta.tick.titleFontColor)||"black",_39=(o.titleGap==0)?0:o.titleGap||(ta.tick&&ta.tick.titleGap)||15,_3a=o.titleOrientation||(ta.tick&&ta.tick.titleOrientation)||"axis",_3b=this.chart.theme.getTick("major",o),_3c=this.chart.theme.getTick("minor",o),_3d=this.chart.theme.getTick("micro",o),_3e=Math.max(_3b.length,_3c.length,_3d.length),_3f="stroke" in o?o.stroke:ta.stroke,_40=_35?g.normalizedLength(g.splitFontString(_35).size):0,_41=Math.abs(Math.cos(_2a*Math.PI/180)),_42=Math.abs(Math.sin(_2a*Math.PI/180)),_43=_36?g.normalizedLength(g.splitFontString(_36).size):0;if(_2a<0){_2a+=360;}if(this.vertical){_2b={y:dim.height-_28.b};_2c={y:_28.t};_2d={y:(dim.height-_28.b+_28.t)/2};_2f=_40*_42+(this._cachedLabelWidth||0)*_41+_9+Math.max(_3b.length,_3c.length)+_43+_39;_30={x:0,y:-1};_33={x:0,y:0};_31={x:1,y:0};_32={x:_9,y:0};switch(_2a){case 0:_34="end";_33.y=_40*0.4;break;case 90:_34="middle";_33.x=-_40;break;case 180:_34="start";_33.y=-_40*0.4;break;case 270:_34="middle";break;default:if(_2a<_a){_34="end";_33.y=_40*0.4;}else{if(_2a<90){_34="end";_33.y=_40*0.4;}else{if(_2a<(180-_a)){_34="start";}else{if(_2a<(180+_a)){_34="start";_33.y=-_40*0.4;}else{if(_2a<270){_34="start";_33.x=_29?0:_40*0.4;}else{if(_2a<(360-_a)){_34="end";_33.x=_29?0:_40*0.4;}else{_34="end";_33.y=_40*0.4;}}}}}}}if(_29){_2b.x=_2c.x=_28.l;_2e=(_3a&&_3a=="away")?90:270;_2d.x=_28.l-_2f+(_2e==270?_43:0);_31.x=-1;_32.x=-_32.x;}else{_2b.x=_2c.x=dim.width-_28.r;_2e=(_3a&&_3a=="axis")?90:270;_2d.x=dim.width-_28.r+_2f-(_2e==270?0:_43);switch(_34){case "start":_34="end";break;case "end":_34="start";break;case "middle":_33.x+=_40;break;}}}else{_2b={x:_28.l};_2c={x:dim.width-_28.r};_2d={x:(dim.width-_28.r+_28.l)/2};_2f=_40*_41+(this._cachedLabelWidth||0)*_42+_9+Math.max(_3b.length,_3c.length)+_43+_39;_30={x:1,y:0};_33={x:0,y:0};_31={x:0,y:1};_32={x:0,y:_9};switch(_2a){case 0:_34="middle";_33.y=_40;break;case 90:_34="start";_33.x=-_40*0.4;break;case 180:_34="middle";break;case 270:_34="end";_33.x=_40*0.4;break;default:if(_2a<(90-_a)){_34="start";_33.y=_29?_40:0;}else{if(_2a<(90+_a)){_34="start";_33.x=-_40*0.4;}else{if(_2a<180){_34="start";_33.y=_29?0:-_40;}else{if(_2a<(270-_a)){_34="end";_33.y=_29?0:-_40;}else{if(_2a<(270+_a)){_34="end";_33.y=_29?_40*0.4:0;}else{_34="end";_33.y=_29?_40:0;}}}}}}if(_29){_2b.y=_2c.y=dim.height-_28.b;_2e=(_3a&&_3a=="axis")?180:0;_2d.y=dim.height-_28.b+_2f-(_2e?_43:0);}else{_2b.y=_2c.y=_28.t;_2e=(_3a&&_3a=="away")?180:0;_2d.y=_28.t-_2f+(_2e?0:_43);_31.y=-1;_32.y=-_32.y;switch(_34){case "start":_34="end";break;case "end":_34="start";break;case "middle":_33.y-=_40;break;}}}this.cleanGroup();try{var s=this.group,c=this.scaler,t=this.ticks,_44,f=_7.getTransformerFromModel(this.scaler),_45=!_2e&&!_2a&&this.opt.htmlLabels&&!_1.isIE&&!_1.isOpera?"html":"gfx",dx=_31.x*_3b.length,dy=_31.y*_3b.length;s.createLine({x1:_2b.x,y1:_2b.y,x2:_2c.x,y2:_2c.y}).setStroke(_3f);if(o.title){var _46=_8.createText[_45](this.chart,s,_2d.x,_2d.y,"middle",o.title,_36,_38);if(_45=="html"){this.htmlElements.push(_46);}else{_46.setTransform(g.matrix.rotategAt(_2e,_2d.x,_2d.y));}}if(t==null){this.diry=false;return;}_1.forEach(t.major,function(_47){var _48=f(_47.value),_49,x=_2b.x+_30.x*_48,y=_2b.y+_30.y*_48;this.createLine(s,{x1:x,y1:y,x2:x+dx,y2:y+dy}).setStroke(_3b);if(_47.label){var _4a=o.maxLabelCharCount?this.getTextWithLimitCharCount(_47.label,_35,o.maxLabelCharCount):{text:_47.label,truncated:false};_4a=o.maxLabelSize?this.getTextWithLimitLength(_4a.text,_35,o.maxLabelSize,_4a.truncated):_4a;_49=this.createText(_45,s,x+dx+_32.x+(_2a?0:_33.x),y+dy+_32.y+(_2a?0:_33.y),_34,_4a.text,_35,_37);if(this.chart.truncateBidi&&_4a.truncated){this.chart.truncateBidi(_49,_47.label,_45);}_4a.truncated&&this.labelTooltip(_49,this.chart,_47.label,_4a.text,_35,_45);if(_45=="html"){this.htmlElements.push(_49);}else{if(_2a){_49.setTransform([{dx:_33.x,dy:_33.y},g.matrix.rotategAt(_2a,x+dx+_32.x,y+dy+_32.y)]);}}}},this);dx=_31.x*_3c.length;dy=_31.y*_3c.length;_44=c.minMinorStep<=c.minor.tick*c.bounds.scale;_1.forEach(t.minor,function(_4b){var _4c=f(_4b.value),_4d,x=_2b.x+_30.x*_4c,y=_2b.y+_30.y*_4c;this.createLine(s,{x1:x,y1:y,x2:x+dx,y2:y+dy}).setStroke(_3c);if(_44&&_4b.label){var _4e=o.maxLabelCharCount?this.getTextWithLimitCharCount(_4b.label,_35,o.maxLabelCharCount):{text:_4b.label,truncated:false};_4e=o.maxLabelSize?this.getTextWithLimitLength(_4e.text,_35,o.maxLabelSize,_4e.truncated):_4e;_4d=this.createText(_45,s,x+dx+_32.x+(_2a?0:_33.x),y+dy+_32.y+(_2a?0:_33.y),_34,_4e.text,_35,_37);if(this.chart.getTextDir&&_4e.truncated){this.chart.truncateBidi(_4d,_4b.label,_45);}_4e.truncated&&this.labelTooltip(_4d,this.chart,_4b.label,_4e.text,_35,_45);if(_45=="html"){this.htmlElements.push(_4d);}else{if(_2a){_4d.setTransform([{dx:_33.x,dy:_33.y},g.matrix.rotategAt(_2a,x+dx+_32.x,y+dy+_32.y)]);}}}},this);dx=_31.x*_3d.length;dy=_31.y*_3d.length;_1.forEach(t.micro,function(_4f){var _50=f(_4f.value),_51,x=_2b.x+_30.x*_50,y=_2b.y+_30.y*_50;this.createLine(s,{x1:x,y1:y,x2:x+dx,y2:y+dy}).setStroke(_3d);},this);}catch(e){}this.dirty=false;return this;},labelTooltip:function(_52,_53,_54,_55,_56,_57){if(!dijit||!dijit.Tooltip){return;}var _58={type:"rect"},_59=["above","below"],_5a=g._base._getTextBox(_55,{font:_56}).w||0,_5b=_56?g.normalizedLength(g.splitFontString(_56).size):0;if(_57=="html"){_1.mixin(_58,_1.coords(_52.firstChild,true));_58.width=Math.ceil(_5a);_58.height=Math.ceil(_5b);this._events.push({shape:_1,handle:_1.connect(_52.firstChild,"onmouseover",this,function(e){dijit.showTooltip(_54,_58,_59);})});this._events.push({shape:_1,handle:_1.connect(_52.firstChild,"onmouseout",this,function(e){dijit.hideTooltip(_58);})});}else{var shp=_52.getShape(),lt=_1.coords(_53.node,true);_58=_1.mixin(_58,{x:shp.x-_5a/2,y:shp.y});_58.x+=lt.x;_58.y+=lt.y;_58.x=Math.round(_58.x);_58.y=Math.round(_58.y);_58.width=Math.ceil(_5a);_58.height=Math.ceil(_5b);this._events.push({shape:_52,handle:_52.connect("onmouseenter",this,function(e){dijit.showTooltip(_54,_58,_59);})});this._events.push({shape:_52,handle:_52.connect("onmouseleave",this,function(e){dijit.hideTooltip(_58);})});}}});});