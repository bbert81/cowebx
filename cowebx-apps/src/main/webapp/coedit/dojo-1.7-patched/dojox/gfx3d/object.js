/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/lang","dojo/_base/array","dojox/gfx","./scheduler","./gradient","./vector","./matrix","./lighting"],function(){var _1=function(o,x){if(arguments.length>1){o=x;}var e={};for(var i in o){if(i in e){continue;}}};dojo.declare("dojox.gfx3d.Object",null,{constructor:function(){this.object=null;this.matrix=null;this.cache=null;this.renderer=null;this.parent=null;this.strokeStyle=null;this.fillStyle=null;this.shape=null;},setObject:function(_2){this.object=dojox.gfx.makeParameters(this.object,_2);return this;},setTransform:function(_3){this.matrix=dojox.gfx3d.matrix.clone(_3?dojox.gfx3d.matrix.normalize(_3):dojox.gfx3d.identity,true);return this;},applyRightTransform:function(_4){return _4?this.setTransform([this.matrix,_4]):this;},applyLeftTransform:function(_5){return _5?this.setTransform([_5,this.matrix]):this;},applyTransform:function(_6){return _6?this.setTransform([this.matrix,_6]):this;},setFill:function(_7){this.fillStyle=_7;return this;},setStroke:function(_8){this.strokeStyle=_8;return this;},toStdFill:function(_9,_a){return (this.fillStyle&&typeof this.fillStyle["type"]!="undefined")?_9[this.fillStyle.type](_a,this.fillStyle.finish,this.fillStyle.color):this.fillStyle;},invalidate:function(){this.renderer.addTodo(this);},destroy:function(){if(this.shape){var p=this.shape.getParent();if(p){p.remove(this.shape);}this.shape=null;}},render:function(_b){throw "Pure virtual function, not implemented";},draw:function(_c){throw "Pure virtual function, not implemented";},getZOrder:function(){return 0;},getOutline:function(){return null;}});dojo.declare("dojox.gfx3d.Scene",dojox.gfx3d.Object,{constructor:function(){this.objects=[];this.todos=[];this.schedule=dojox.gfx3d.scheduler.zOrder;this._draw=dojox.gfx3d.drawer.conservative;},setFill:function(_d){this.fillStyle=_d;dojo.forEach(this.objects,function(_e){_e.setFill(_d);});return this;},setStroke:function(_f){this.strokeStyle=_f;dojo.forEach(this.objects,function(_10){_10.setStroke(_f);});return this;},render:function(_11,_12){var m=dojox.gfx3d.matrix.multiply(_11,this.matrix);if(_12){this.todos=this.objects;}dojo.forEach(this.todos,function(_13){_13.render(m,_12);});},draw:function(_14){this.objects=this.schedule(this.objects);this._draw(this.todos,this.objects,this.renderer);},addTodo:function(_15){if(dojo.every(this.todos,function(_16){return _16!=_15;})){this.todos.push(_15);this.invalidate();}},invalidate:function(){this.parent.addTodo(this);},getZOrder:function(){var _17=0;dojo.forEach(this.objects,function(_18){_17+=_18.getZOrder();});return (this.objects.length>1)?_17/this.objects.length:0;}});dojo.declare("dojox.gfx3d.Edges",dojox.gfx3d.Object,{constructor:function(){this.object=dojo.clone(dojox.gfx3d.defaultEdges);},setObject:function(_19,_1a){this.object=dojox.gfx.makeParameters(this.object,(_19 instanceof Array)?{points:_19,style:_1a}:_19);return this;},getZOrder:function(){var _1b=0;dojo.forEach(this.cache,function(_1c){_1b+=_1c.z;});return (this.cache.length>1)?_1b/this.cache.length:0;},render:function(_1d){var m=dojox.gfx3d.matrix.multiply(_1d,this.matrix);this.cache=dojo.map(this.object.points,function(_1e){return dojox.gfx3d.matrix.multiplyPoint(m,_1e);});},draw:function(){var c=this.cache;if(this.shape){this.shape.setShape("");}else{this.shape=this.renderer.createPath();}var p=this.shape.setAbsoluteMode("absolute");if(this.object.style=="strip"||this.object.style=="loop"){p.moveTo(c[0].x,c[0].y);dojo.forEach(c.slice(1),function(_1f){p.lineTo(_1f.x,_1f.y);});if(this.object.style=="loop"){p.closePath();}}else{for(var i=0;i<this.cache.length;){p.moveTo(c[i].x,c[i].y);i++;p.lineTo(c[i].x,c[i].y);i++;}}p.setStroke(this.strokeStyle);}});dojo.declare("dojox.gfx3d.Orbit",dojox.gfx3d.Object,{constructor:function(){this.object=dojo.clone(dojox.gfx3d.defaultOrbit);},render:function(_20){var m=dojox.gfx3d.matrix.multiply(_20,this.matrix);var _21=[0,Math.PI/4,Math.PI/3];var _22=dojox.gfx3d.matrix.multiplyPoint(m,this.object.center);var _23=dojo.map(_21,function(_24){return {x:this.center.x+this.radius*Math.cos(_24),y:this.center.y+this.radius*Math.sin(_24),z:this.center.z};},this.object);_23=dojo.map(_23,function(_25){return dojox.gfx3d.matrix.multiplyPoint(m,_25);});var _26=dojox.gfx3d.vector.normalize(_23);_23=dojo.map(_23,function(_27){return dojox.gfx3d.vector.substract(_27,_22);});var A={xx:_23[0].x*_23[0].y,xy:_23[0].y*_23[0].y,xz:1,yx:_23[1].x*_23[1].y,yy:_23[1].y*_23[1].y,yz:1,zx:_23[2].x*_23[2].y,zy:_23[2].y*_23[2].y,zz:1,dx:0,dy:0,dz:0};var B=dojo.map(_23,function(_28){return -Math.pow(_28.x,2);});var X=dojox.gfx3d.matrix.multiplyPoint(dojox.gfx3d.matrix.invert(A),B[0],B[1],B[2]);var _29=Math.atan2(X.x,1-X.y)/2;var _2a=dojo.map(_23,function(_2b){return dojox.gfx.matrix.multiplyPoint(dojox.gfx.matrix.rotate(-_29),_2b.x,_2b.y);});var a=Math.pow(_2a[0].x,2);var b=Math.pow(_2a[0].y,2);var c=Math.pow(_2a[1].x,2);var d=Math.pow(_2a[1].y,2);var rx=Math.sqrt((a*d-b*c)/(d-b));var ry=Math.sqrt((a*d-b*c)/(a-c));this.cache={cx:_22.x,cy:_22.y,rx:rx,ry:ry,theta:_29,normal:_26};},draw:function(_2c){if(this.shape){this.shape.setShape(this.cache);}else{this.shape=this.renderer.createEllipse(this.cache);}this.shape.applyTransform(dojox.gfx.matrix.rotateAt(this.cache.theta,this.cache.cx,this.cache.cy)).setStroke(this.strokeStyle).setFill(this.toStdFill(_2c,this.cache.normal));}});dojo.declare("dojox.gfx3d.Path3d",dojox.gfx3d.Object,{constructor:function(){this.object=dojo.clone(dojox.gfx3d.defaultPath3d);this.segments=[];this.absolute=true;this.last={};this.path="";},_collectArgs:function(_2d,_2e){for(var i=0;i<_2e.length;++i){var t=_2e[i];if(typeof (t)=="boolean"){_2d.push(t?1:0);}else{if(typeof (t)=="number"){_2d.push(t);}else{if(t instanceof Array){this._collectArgs(_2d,t);}else{if("x" in t&&"y" in t){_2d.push(t.x);_2d.push(t.y);}}}}}},_validSegments:{m:3,l:3,z:0},_pushSegment:function(_2f,_30){var _31=this._validSegments[_2f.toLowerCase()],_32;if(typeof (_31)=="number"){if(_31){if(_30.length>=_31){_32={action:_2f,args:_30.slice(0,_30.length-_30.length%_31)};this.segments.push(_32);}}else{_32={action:_2f,args:[]};this.segments.push(_32);}}},moveTo:function(){var _33=[];this._collectArgs(_33,arguments);this._pushSegment(this.absolute?"M":"m",_33);return this;},lineTo:function(){var _34=[];this._collectArgs(_34,arguments);this._pushSegment(this.absolute?"L":"l",_34);return this;},closePath:function(){this._pushSegment("Z",[]);return this;},render:function(_35){var m=dojox.gfx3d.matrix.multiply(_35,this.matrix);var _36="";var _37=this._validSegments;dojo.forEach(this.segments,function(_38){_36+=_38.action;for(var i=0;i<_38.args.length;i+=_37[_38.action.toLowerCase()]){var pt=dojox.gfx3d.matrix.multiplyPoint(m,_38.args[i],_38.args[i+1],_38.args[i+2]);_36+=" "+pt.x+" "+pt.y;}});this.cache=_36;},_draw:function(){return this.parent.createPath(this.cache);}});dojo.declare("dojox.gfx3d.Triangles",dojox.gfx3d.Object,{constructor:function(){this.object=dojo.clone(dojox.gfx3d.defaultTriangles);},setObject:function(_39,_3a){if(_39 instanceof Array){this.object=dojox.gfx.makeParameters(this.object,{points:_39,style:_3a});}else{this.object=dojox.gfx.makeParameters(this.object,_39);}return this;},render:function(_3b){var m=dojox.gfx3d.matrix.multiply(_3b,this.matrix);var c=dojo.map(this.object.points,function(_3c){return dojox.gfx3d.matrix.multiplyPoint(m,_3c);});this.cache=[];var _3d=c.slice(0,2);var _3e=c[0];if(this.object.style=="strip"){dojo.forEach(c.slice(2),function(_3f){_3d.push(_3f);_3d.push(_3d[0]);this.cache.push(_3d);_3d=_3d.slice(1,3);},this);}else{if(this.object.style=="fan"){dojo.forEach(c.slice(2),function(_40){_3d.push(_40);_3d.push(_3e);this.cache.push(_3d);_3d=[_3e,_40];},this);}else{for(var i=0;i<c.length;){this.cache.push([c[i],c[i+1],c[i+2],c[i]]);i+=3;}}}},draw:function(_41){this.cache=dojox.gfx3d.scheduler.bsp(this.cache,function(it){return it;});if(this.shape){this.shape.clear();}else{this.shape=this.renderer.createGroup();}dojo.forEach(this.cache,function(_42){this.shape.createPolyline(_42).setStroke(this.strokeStyle).setFill(this.toStdFill(_41,dojox.gfx3d.vector.normalize(_42)));},this);},getZOrder:function(){var _43=0;dojo.forEach(this.cache,function(_44){_43+=(_44[0].z+_44[1].z+_44[2].z)/3;});return (this.cache.length>1)?_43/this.cache.length:0;}});dojo.declare("dojox.gfx3d.Quads",dojox.gfx3d.Object,{constructor:function(){this.object=dojo.clone(dojox.gfx3d.defaultQuads);},setObject:function(_45,_46){this.object=dojox.gfx.makeParameters(this.object,(_45 instanceof Array)?{points:_45,style:_46}:_45);return this;},render:function(_47){var m=dojox.gfx3d.matrix.multiply(_47,this.matrix),i;var c=dojo.map(this.object.points,function(_48){return dojox.gfx3d.matrix.multiplyPoint(m,_48);});this.cache=[];if(this.object.style=="strip"){var _49=c.slice(0,2);for(i=2;i<c.length;){_49=_49.concat([c[i],c[i+1],_49[0]]);this.cache.push(_49);_49=_49.slice(2,4);i+=2;}}else{for(i=0;i<c.length;){this.cache.push([c[i],c[i+1],c[i+2],c[i+3],c[i]]);i+=4;}}},draw:function(_4a){this.cache=dojox.gfx3d.scheduler.bsp(this.cache,function(it){return it;});if(this.shape){this.shape.clear();}else{this.shape=this.renderer.createGroup();}for(var x=0;x<this.cache.length;x++){this.shape.createPolyline(this.cache[x]).setStroke(this.strokeStyle).setFill(this.toStdFill(_4a,dojox.gfx3d.vector.normalize(this.cache[x])));}},getZOrder:function(){var _4b=0;for(var x=0;x<this.cache.length;x++){var i=this.cache[x];_4b+=(i[0].z+i[1].z+i[2].z+i[3].z)/4;}return (this.cache.length>1)?_4b/this.cache.length:0;}});dojo.declare("dojox.gfx3d.Polygon",dojox.gfx3d.Object,{constructor:function(){this.object=dojo.clone(dojox.gfx3d.defaultPolygon);},setObject:function(_4c){this.object=dojox.gfx.makeParameters(this.object,(_4c instanceof Array)?{path:_4c}:_4c);return this;},render:function(_4d){var m=dojox.gfx3d.matrix.multiply(_4d,this.matrix);this.cache=dojo.map(this.object.path,function(_4e){return dojox.gfx3d.matrix.multiplyPoint(m,_4e);});this.cache.push(this.cache[0]);},draw:function(_4f){if(this.shape){this.shape.setShape({points:this.cache});}else{this.shape=this.renderer.createPolyline({points:this.cache});}this.shape.setStroke(this.strokeStyle).setFill(this.toStdFill(_4f,dojox.gfx3d.matrix.normalize(this.cache)));},getZOrder:function(){var _50=0;for(var x=0;x<this.cache.length;x++){_50+=this.cache[x].z;}return (this.cache.length>1)?_50/this.cache.length:0;},getOutline:function(){return this.cache.slice(0,3);}});dojo.declare("dojox.gfx3d.Cube",dojox.gfx3d.Object,{constructor:function(){this.object=dojo.clone(dojox.gfx3d.defaultCube);this.polygons=[];},setObject:function(_51){this.object=dojox.gfx.makeParameters(this.object,_51);},render:function(_52){var a=this.object.top;var g=this.object.bottom;var b={x:g.x,y:a.y,z:a.z};var c={x:g.x,y:g.y,z:a.z};var d={x:a.x,y:g.y,z:a.z};var e={x:a.x,y:a.y,z:g.z};var f={x:g.x,y:a.y,z:g.z};var h={x:a.x,y:g.y,z:g.z};var _53=[a,b,c,d,e,f,g,h];var m=dojox.gfx3d.matrix.multiply(_52,this.matrix);var p=dojo.map(_53,function(_54){return dojox.gfx3d.matrix.multiplyPoint(m,_54);});a=p[0];b=p[1];c=p[2];d=p[3];e=p[4];f=p[5];g=p[6];h=p[7];this.cache=[[a,b,c,d,a],[e,f,g,h,e],[a,d,h,e,a],[d,c,g,h,d],[c,b,f,g,c],[b,a,e,f,b]];},draw:function(_55){this.cache=dojox.gfx3d.scheduler.bsp(this.cache,function(it){return it;});var _56=this.cache.slice(3);if(this.shape){this.shape.clear();}else{this.shape=this.renderer.createGroup();}for(var x=0;x<_56.length;x++){this.shape.createPolyline(_56[x]).setStroke(this.strokeStyle).setFill(this.toStdFill(_55,dojox.gfx3d.vector.normalize(_56[x])));}},getZOrder:function(){var top=this.cache[0][0];var _57=this.cache[1][2];return (top.z+_57.z)/2;}});dojo.declare("dojox.gfx3d.Cylinder",dojox.gfx3d.Object,{constructor:function(){this.object=dojo.clone(dojox.gfx3d.defaultCylinder);},render:function(_58){var m=dojox.gfx3d.matrix.multiply(_58,this.matrix);var _59=[0,Math.PI/4,Math.PI/3];var _5a=dojox.gfx3d.matrix.multiplyPoint(m,this.object.center);var _5b=dojo.map(_59,function(_5c){return {x:this.center.x+this.radius*Math.cos(_5c),y:this.center.y+this.radius*Math.sin(_5c),z:this.center.z};},this.object);_5b=dojo.map(_5b,function(_5d){return dojox.gfx3d.vector.substract(dojox.gfx3d.matrix.multiplyPoint(m,_5d),_5a);});var A={xx:_5b[0].x*_5b[0].y,xy:_5b[0].y*_5b[0].y,xz:1,yx:_5b[1].x*_5b[1].y,yy:_5b[1].y*_5b[1].y,yz:1,zx:_5b[2].x*_5b[2].y,zy:_5b[2].y*_5b[2].y,zz:1,dx:0,dy:0,dz:0};var B=dojo.map(_5b,function(_5e){return -Math.pow(_5e.x,2);});var X=dojox.gfx3d.matrix.multiplyPoint(dojox.gfx3d.matrix.invert(A),B[0],B[1],B[2]);var _5f=Math.atan2(X.x,1-X.y)/2;var _60=dojo.map(_5b,function(_61){return dojox.gfx.matrix.multiplyPoint(dojox.gfx.matrix.rotate(-_5f),_61.x,_61.y);});var a=Math.pow(_60[0].x,2);var b=Math.pow(_60[0].y,2);var c=Math.pow(_60[1].x,2);var d=Math.pow(_60[1].y,2);var rx=Math.sqrt((a*d-b*c)/(d-b));var ry=Math.sqrt((a*d-b*c)/(a-c));if(rx<ry){var t=rx;rx=ry;ry=t;_5f-=Math.PI/2;}var top=dojox.gfx3d.matrix.multiplyPoint(m,dojox.gfx3d.vector.sum(this.object.center,{x:0,y:0,z:this.object.height}));var _62=this.fillStyle.type=="constant"?this.fillStyle.color:dojox.gfx3d.gradient(this.renderer.lighting,this.fillStyle,this.object.center,this.object.radius,Math.PI,2*Math.PI,m);if(isNaN(rx)||isNaN(ry)||isNaN(_5f)){rx=this.object.radius,ry=0,_5f=0;}this.cache={center:_5a,top:top,rx:rx,ry:ry,theta:_5f,gradient:_62};},draw:function(){var c=this.cache,v=dojox.gfx3d.vector,m=dojox.gfx.matrix,_63=[c.center,c.top],_64=v.substract(c.top,c.center);if(v.dotProduct(_64,this.renderer.lighting.incident)>0){_63=[c.top,c.center];_64=v.substract(c.center,c.top);}var _65=this.renderer.lighting[this.fillStyle.type](_64,this.fillStyle.finish,this.fillStyle.color),d=Math.sqrt(Math.pow(c.center.x-c.top.x,2)+Math.pow(c.center.y-c.top.y,2));if(this.shape){this.shape.clear();}else{this.shape=this.renderer.createGroup();}this.shape.createPath("").moveTo(0,-c.rx).lineTo(d,-c.rx).lineTo(d,c.rx).lineTo(0,c.rx).arcTo(c.ry,c.rx,0,true,true,0,-c.rx).setFill(c.gradient).setStroke(this.strokeStyle).setTransform([m.translate(_63[0]),m.rotate(Math.atan2(_63[1].y-_63[0].y,_63[1].x-_63[0].x))]);if(c.rx>0&&c.ry>0){this.shape.createEllipse({cx:_63[1].x,cy:_63[1].y,rx:c.rx,ry:c.ry}).setFill(_65).setStroke(this.strokeStyle).applyTransform(m.rotateAt(c.theta,_63[1]));}}});dojo.declare("dojox.gfx3d.Viewport",dojox.gfx.Group,{constructor:function(){this.dimension=null;this.objects=[];this.todos=[];this.renderer=this;this.schedule=dojox.gfx3d.scheduler.zOrder;this.draw=dojox.gfx3d.drawer.conservative;this.deep=false;this.lights=[];this.lighting=null;},setCameraTransform:function(_66){this.camera=dojox.gfx3d.matrix.clone(_66?dojox.gfx3d.matrix.normalize(_66):dojox.gfx3d.identity,true);this.invalidate();return this;},applyCameraRightTransform:function(_67){return _67?this.setCameraTransform([this.camera,_67]):this;},applyCameraLeftTransform:function(_68){return _68?this.setCameraTransform([_68,this.camera]):this;},applyCameraTransform:function(_69){return this.applyCameraRightTransform(_69);},setLights:function(_6a,_6b,_6c){this.lights=(_6a instanceof Array)?{sources:_6a,ambient:_6b,specular:_6c}:_6a;var _6d={x:0,y:0,z:1};this.lighting=new dojox.gfx3d.lighting.Model(_6d,this.lights.sources,this.lights.ambient,this.lights.specular);this.invalidate();return this;},addLights:function(_6e){return this.setLights(this.lights.sources.concat(_6e));},addTodo:function(_6f){if(dojo.every(this.todos,function(_70){return _70!=_6f;})){this.todos.push(_6f);}},invalidate:function(){this.deep=true;this.todos=this.objects;},setDimensions:function(dim){if(dim){var w=dojo.isString(dim.width)?parseInt(dim.width):dim.width;var h=dojo.isString(dim.height)?parseInt(dim.height):dim.height;if(this.rawNode){var trs=this.rawNode.style;trs.height=h;trs.width=w;}this.dimension={width:w,height:h};}else{this.dimension=null;}},render:function(){if(!this.todos.length){return;}var m=dojox.gfx3d.matrix;for(var x=0;x<this.todos.length;x++){this.todos[x].render(dojox.gfx3d.matrix.normalize([m.cameraRotateXg(180),m.cameraTranslate(0,this.dimension.height,0),this.camera]),this.deep);}this.objects=this.schedule(this.objects);this.draw(this.todos,this.objects,this);this.todos=[];this.deep=false;}});dojox.gfx3d.Viewport.nodeType=dojox.gfx.Group.nodeType;dojox.gfx3d._creators={createEdges:function(_71,_72){return this.create3DObject(dojox.gfx3d.Edges,_71,_72);},createTriangles:function(_73,_74){return this.create3DObject(dojox.gfx3d.Triangles,_73,_74);},createQuads:function(_75,_76){return this.create3DObject(dojox.gfx3d.Quads,_75,_76);},createPolygon:function(_77){return this.create3DObject(dojox.gfx3d.Polygon,_77);},createOrbit:function(_78){return this.create3DObject(dojox.gfx3d.Orbit,_78);},createCube:function(_79){return this.create3DObject(dojox.gfx3d.Cube,_79);},createCylinder:function(_7a){return this.create3DObject(dojox.gfx3d.Cylinder,_7a);},createPath3d:function(_7b){return this.create3DObject(dojox.gfx3d.Path3d,_7b);},createScene:function(){return this.create3DObject(dojox.gfx3d.Scene);},create3DObject:function(_7c,_7d,_7e){var obj=new _7c();this.adopt(obj);if(_7d){obj.setObject(_7d,_7e);}return obj;},adopt:function(obj){obj.renderer=this.renderer;obj.parent=this;this.objects.push(obj);this.addTodo(obj);return this;},abandon:function(obj,_7f){for(var i=0;i<this.objects.length;++i){if(this.objects[i]==obj){this.objects.splice(i,1);}}obj.parent=null;return this;},setScheduler:function(_80){this.schedule=_80;},setDrawer:function(_81){this.draw=_81;}};dojo.extend(dojox.gfx3d.Viewport,dojox.gfx3d._creators);dojo.extend(dojox.gfx3d.Scene,dojox.gfx3d._creators);delete dojox.gfx3d._creators;dojo.extend(dojox.gfx.Surface,{createViewport:function(){var _82=this.createObject(dojox.gfx3d.Viewport,null,true);_82.setDimensions(this.getDimensions());return _82;}});return dojox.gfx3d.Object;});