/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/Stateful"],function(_1){return dojo.declare("dojox.mvc._DataBindingMixin",null,{ref:null,isValid:function(){return this.get("binding")?this.get("binding").get("valid"):true;},_dbstartup:function(){if(this._databound){return;}this._unwatchArray(this._viewWatchHandles);this._viewWatchHandles=[this.watch("ref",function(_2,_3,_4){if(this._databound){this._setupBinding();}}),this.watch("value",function(_5,_6,_7){if(this._databound){var _8=this.get("binding");if(_8){_8.set("value",_7);}}})];this._beingBound=true;this._setupBinding();delete this._beingBound;this._databound=true;},_setupBinding:function(_9){if(!this.ref){return;}var _a=this.ref,pw,pb,_b;if(_a&&dojo.isFunction(_a.toPlainObject)){_b=_a;}else{if(/^\s*expr\s*:\s*/.test(_a)){_a=_a.replace(/^\s*expr\s*:\s*/,"");_b=dojo.getObject(_a);}else{if(/^\s*rel\s*:\s*/.test(_a)){_a=_a.replace(/^\s*rel\s*:\s*/,"");_9=_9||this._getParentBindingFromDOM();if(_9){_b=dojo.getObject(_a,false,_9);}}else{if(/^\s*widget\s*:\s*/.test(_a)){_a=_a.replace(/^\s*widget\s*:\s*/,"");var _c=_a.split(".");if(_c.length==1){_b=dijit.byId(_a).get("binding");}else{pb=dijit.byId(_c.shift()).get("binding");_b=dojo.getObject(_c.join("."),false,pb);}}else{_9=_9||this._getParentBindingFromDOM();if(_9){_b=_9.get(_a);}else{try{_b=dojo.getObject(_a);}catch(err){if(_a.indexOf("${")==-1){throw new Error("dojox.mvc._DataBindingMixin: '"+this.domNode+"' widget with illegal ref expression: '"+_a+"'");}}}}}}}if(_b){if(dojo.isFunction(_b.toPlainObject)){this.binding=_b;this._updateBinding("binding",null,_b);}else{throw new Error("dojox.mvc._DataBindingMixin: '"+this.domNode+"' widget with illegal ref not evaluating to a dojo.Stateful node: '"+_a+"'");}}},_updateBinding:function(_d,_e,_f){this._unwatchArray(this._modelWatchHandles);var _10=this.get("binding");if(_10&&dojo.isFunction(_10.watch)){var _11=this;this._modelWatchHandles=[_10.watch("value",function(_12,old,_13){if(old===_13){return;}_11.set("value",_13);}),_10.watch("valid",function(_14,old,_15){_11._updateProperty(_14,old,_15,true);if(_15!==_11.get("binding").get(_14)){if(_11.validate&&dojo.isFunction(_11.validate)){_11.validate(true);}}}),_10.watch("required",function(_16,old,_17){_11._updateProperty(_16,old,_17,false,_16,_17);}),_10.watch("readOnly",function(_18,old,_19){_11._updateProperty(_18,old,_19,false,_18,_19);}),_10.watch("relevant",function(_1a,old,_1b){_11._updateProperty(_1a,old,_1b,false,"disabled",!_1b);})];var val=_10.get("value");if(val!=null){this.set("value",val);}}this._updateChildBindings();},_updateProperty:function(_1c,old,_1d,_1e,_1f,_20){if(old===_1d){return;}if(_1d===null&&_1e!==undefined){_1d=_1e;}if(_1d!==this.get("binding").get(_1c)){this.get("binding").set(_1c,_1d);}if(_1f){this.set(_1f,_20);}},_updateChildBindings:function(){var _21=this.get("binding");if(_21&&!this._beingBound){dojo.forEach(dijit.findWidgets(this.domNode),function(_22){if(_22._setupBinding){_22._setupBinding(_21);}});}},_getParentBindingFromDOM:function(){var pn=this.domNode.parentNode,pw,pb;while(pn){pw=dijit.getEnclosingWidget(pn);if(pw){pb=pw.get("binding");if(pb&&dojo.isFunction(pb.toPlainObject)){break;}}pn=pw?pw.domNode.parentNode:null;}return pb;},_unwatchArray:function(_23){dojo.forEach(_23,function(h){h.unwatch();});}});});