/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/lang","dojo/_base/declare","dojo/_base/html","dojo/_base/xhr","dojo/_base/connect","dojo/_base/window","dojox/gfx","dojox/geo/charting/_base","dojox/geo/charting/Feature","dojox/geo/charting/_Marker","dojo/number"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){return _1.declare("dojox.geo.charting.Map",null,{defaultColor:"#B7B7B7",highlightColor:"#D5D5D5",series:[],dataBindingAttribute:null,dataBindingValueFunction:null,dataStore:null,showTooltips:true,enableFeatureZoom:true,colorAnimationDuration:0,_idAttributes:null,_onSetListener:null,_onNewListener:null,_onDeleteListener:null,constructor:function(_c,_d){_1.style(_c,"display","block");this.container=_c;var _e=this._getContainerBounds();this.surface=_7.createSurface(_c,_e.w,_e.h);this._createZoomingCursor();this.mapObj=this.surface.createGroup();this.mapObj.features={};_1.xhrGet({url:_d,handleAs:"json",sync:true,load:_1.hitch(this,"_init")});},_getContainerBounds:function(){var _f=_1.coords(this.container);var _10=_1.marginBox(this.container);var _11=_1.contentBox(this.container);this._storedContainerBounds={x:_f.x,y:_f.y,w:_11.w||100,h:_11.h||100};return this._storedContainerBounds;},resize:function(_12,_13,_14){var _15=this._storedContainerBounds;var _16=this._getContainerBounds();if((_15.w==_16.w)&&(_15.h==_16.h)){return;}this.surface.setDimensions(_16.w,_16.h);this.mapObj.marker.hide();this.mapObj.marker._needTooltipRefresh=true;if(_12){var _17=this.getMapScale();var _18=_17;if(_13){var _19=this.mapObj.boundBox;var _1a=_16.w/_15.w;var _1b=_16.h/_15.h;_18=_17*Math.sqrt(_1a*_1b);}var _1c=this.screenCoordsToMapCoords(_15.w/2,_15.h/2);this.setMapCenterAndScale(_1c.x,_1c.y,_18,_14);}},_isMobileDevice:function(){return (_1.isSafari&&(navigator.userAgent.indexOf("iPhone")>-1||navigator.userAgent.indexOf("iPod")>-1||navigator.userAgent.indexOf("iPad")>-1))||(navigator.userAgent.toLowerCase().indexOf("android")>-1);},setMarkerData:function(_1d){_1.xhrGet({url:_1d,handleAs:"json",handle:_1.hitch(this,"_appendMarker")});},setDataBindingAttribute:function(_1e){this.dataBindingAttribute=_1e;if(this.dataStore){this._queryDataStore();}},setDataBindingValueFunction:function(_1f){this.dataBindingValueFunction=_1f;if(this.dataStore){this._queryDataStore();}},_queryDataStore:function(){if(!this.dataBindingAttribute||(this.dataBindingAttribute.length==0)){return;}var _20=this;this.dataStore.fetch({scope:this,onComplete:function(_21){this._idAttributes=_20.dataStore.getIdentityAttributes({});_1.forEach(_21,function(_22){var id=_20.dataStore.getValue(_22,this._idAttributes[0]);if(_20.mapObj.features[id]){var val=null;var _23=_20.dataStore.getValue(_22,_20.dataBindingAttribute);if(_23){if(this.dataBindingValueFunction){val=this.dataBindingValueFunction(_23);}else{if(isNaN(val)){val=_b.parse(_23);}else{val=_23;}}}if(val){_20.mapObj.features[id].setValue(val);}}},this);}});},_onSet:function(_24,_25,_26,_27){var id=this.dataStore.getValue(_24,this._idAttributes[0]);var _28=this.mapObj.features[id];if(_28&&(_25==this.dataBindingAttribute)){if(_27){_28.setValue(_27);}else{_28.unsetValue();}}},_onNew:function(_29,_2a){var id=this.dataStore.getValue(item,this._idAttributes[0]);var _2b=this.mapObj.features[id];if(_2b&&(attribute==this.dataBindingAttribute)){_2b.setValue(newValue);}},_onDelete:function(_2c){var id=_2c[this._idAttributes[0]];var _2d=this.mapObj.features[id];if(_2d){_2d.unsetValue();}},setDataStore:function(_2e,_2f){if(this.dataStore!=_2e){if(this._onSetListener){_1.disconnect(this._onSetListener);_1.disconnect(this._onNewListener);_1.disconnect(this._onDeleteListener);}this.dataStore=_2e;if(_2e){_onSetListener=_1.connect(this.dataStore,"onSet",this,this._onSet);_onNewListener=_1.connect(this.dataStore,"onNew",this,this._onNew);_onDeleteListener=_1.connect(this.dataStore,"onDelete",this,this._onDelete);}}if(_2f){this.setDataBindingAttribute(_2f);}},addSeries:function(_30){this.series=_30;for(var _31 in this.mapObj.features){var _32=this.mapObj.features[_31];_32.setValue(_32.value);}},setSeriesFile:function(_33){_1.xhrGet({url:_33,handleAs:"json",sync:true,load:_1.hitch(this,function(_34){if(_34.series){this.addSeries(_34.series);}})});},fitToMapArea:function(_35,_36,_37,_38){if(!_36){_36=0;}var _39=_35.w,_3a=_35.h,_3b=this._getContainerBounds(),_3c=Math.min((_3b.w-2*_36)/_39,(_3b.h-2*_36)/_3a);this.setMapCenterAndScale(_35.x+_35.w/2,_35.y+_35.h/2,_3c,_37,_38);},fitToMapContents:function(_3d,_3e,_3f){var _40=this.mapObj.boundBox;this.fitToMapArea(_40,_3d,_3e,_3f);},setMapCenter:function(_41,_42,_43,_44){var _45=this.getMapScale();this.setMapCenterAndScale(_41,_42,_45,_43,_44);},_createAnimation:function(_46,_47,_48,_49){var _4a=_47.dx?_47.dx:0;var _4b=_47.dy?_47.dy:0;var _4c=_48.dx?_48.dx:0;var _4d=_48.dy?_48.dy:0;var _4e=_47.xx?_47.xx:1;var _4f=_48.xx?_48.xx:1;var _50=_7.fx.animateTransform({duration:1000,shape:_46,transform:[{name:"translate",start:[_4a,_4b],end:[_4c,_4d]},{name:"scale",start:[_4e],end:[_4f]}]});if(_49){var _51=_1.connect(_50,"onEnd",this,function(_52){_49(_52);_1.disconnect(_51);});}return _50;},setMapCenterAndScale:function(_53,_54,_55,_56,_57){var _58=this.mapObj.boundBox;var _59=this._getContainerBounds();var _5a=_59.w/2-_55*(_53-_58.x);var _5b=_59.h/2-_55*(_54-_58.y);var _5c=new _7.matrix.Matrix2D({xx:_55,yy:_55,dx:_5a,dy:_5b});var _5d=this.mapObj.getTransform();if(!_56||!_5d){this.mapObj.setTransform(_5c);}else{var _5e=this._createAnimation(this.mapObj,_5d,_5c,_57);_5e.play();}},getMapCenter:function(){var _5f=this._getContainerBounds();return this.screenCoordsToMapCoords(_5f.w/2,_5f.h/2);},setMapScale:function(_60,_61,_62){var _63=this._getContainerBounds();var _64=this.screenCoordsToMapCoords(_63.w/2,_63.h/2);this.setMapScaleAt(_60,_64.x,_64.y,_61,_62);},setMapScaleAt:function(_65,_66,_67,_68,_69){var _6a=null;var _6b=null;_6a={x:_66,y:_67};_6b=this.mapCoordsToScreenCoords(_6a.x,_6a.y);var _6c=this.mapObj.boundBox;var _6d=_6b.x-_65*(_6a.x-_6c.x);var _6e=_6b.y-_65*(_6a.y-_6c.y);var _6f=new _7.matrix.Matrix2D({xx:_65,yy:_65,dx:_6d,dy:_6e});var _70=this.mapObj.getTransform();if(!_68||!_70){this.mapObj.setTransform(_6f);}else{var _71=this._createAnimation(this.mapObj,_70,_6f,_69);_71.play();}},getMapScale:function(){var mat=this.mapObj.getTransform();var _72=mat?mat.xx:1;return _72;},mapCoordsToScreenCoords:function(_73,_74){var _75=this.mapObj.getTransform();var _76=_7.matrix.multiplyPoint(_75,_73,_74);return _76;},screenCoordsToMapCoords:function(_77,_78){var _79=_7.matrix.invert(this.mapObj.getTransform());var _7a=_7.matrix.multiplyPoint(_79,_77,_78);return _7a;},deselectAll:function(){for(var _7b in this.mapObj.features){this.mapObj.features[_7b].select(false);}this.selectedFeature=null;this.focused=false;},_init:function(_7c){this.mapObj.boundBox={x:_7c.layerExtent[0],y:_7c.layerExtent[1],w:(_7c.layerExtent[2]-_7c.layerExtent[0]),h:_7c.layerExtent[3]-_7c.layerExtent[1]};this.fitToMapContents(3);_1.forEach(_7c.featureNames,function(_7d){var _7e=_7c.features[_7d];_7e.bbox.x=_7e.bbox[0];_7e.bbox.y=_7e.bbox[1];_7e.bbox.w=_7e.bbox[2];_7e.bbox.h=_7e.bbox[3];var _7f=new _9(this,_7d,_7e);_7f.init();this.mapObj.features[_7d]=_7f;},this);this.mapObj.marker=new _a({},this);},_appendMarker:function(_80){this.mapObj.marker=new _a(_80,this);},_createZoomingCursor:function(){if(!_1.byId("mapZoomCursor")){var _81=_1.doc.createElement("div");_1.attr(_81,"id","mapZoomCursor");_1.addClass(_81,"mapZoomIn");_1.style(_81,"display","none");_1.body().appendChild(_81);}},onFeatureClick:function(_82){},onFeatureOver:function(_83){},onZoomEnd:function(_84){}});});