/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo","dijit","dojox","dojox/rpc/Service","dojox/data/JsonRestStore","dojox/json/schema","dojo/data/api/Read","dojo/data/ItemFileReadStore"],function(_1,_2,_3){_1.getObject("dojox.data.tests.stores.JsonRestStore",1);_3.data.tests.stores.JsonRestStore.error=function(t,d,_4){d.errback(_4);};testServices=new _3.rpc.Service(_1.moduleUrl("dojox.rpc.tests.resources","test.smd"));testServices.jsonRestStore.servicePath="/jsonRest.Store/";jsonStore=new _3.data.JsonRestStore({service:testServices.jsonRestStore});doh.register("dojox.data.tests.stores.JsonRestStore",[{name:"Fetch some items",timeout:10000,runTest:function(t){var d=new doh.Deferred();jsonStore.fetch({query:"query",onComplete:function(_5,_6){t.is(4,_5.length);d.callback(true);},onError:_1.partial(_3.data.tests.stores.JsonRestStore.error,doh,d)});return d;}},{name:"fetch by id",timeout:10000,runTest:function(t){var d=new doh.Deferred();jsonStore.fetch({query:"obj1",onComplete:function(_7,_8){t.is("Object 1",_7.name);t.t(jsonStore.hasAttribute(_7,"name"));t.is(jsonStore.getValues(_7,"name").length,1);t.t(jsonStore.isItem(_7));d.callback(true);},onError:_1.partial(_3.data.tests.stores.JsonRestStore.error,doh,d)});return d;}},{name:"Modify,save, check by id",timeout:10000,runTest:function(t){var d=new doh.Deferred();jsonStore.fetch({query:"query",onComplete:function(_9,_a){var _b=new Date().getTime();jsonStore.setValue(_9[0],"updated",_b);jsonStore.setValue(_9[0],"obj",{foo:"bar"});jsonStore.setValue(_9[0],"obj dup",_9[0].obj);jsonStore.setValue(_9[0],"testArray",[1,2,3,4]);jsonStore.save({onComplete:function(){jsonStore.fetchItemByIdentity({identity:"obj1",onItem:function(_c,_d){t.is("Object 1",_c.name);t.is(_b,_c.updated);t.is("bar",_c.obj.foo);t.is(_c.obj,_c["obj dup"]);d.callback(true);},onError:_1.partial(_3.data.tests.stores.JsonRestStore.error,doh,d)});}});},onError:_1.partial(_3.data.tests.stores.JsonRestStore.error,doh,d)});return d;}},{name:"Revert",timeout:10000,runTest:function(t){var d=new doh.Deferred();jsonStore.fetch({query:"obj1",onComplete:function(_e,_f){jsonStore.setValue(_e,"name","new name");jsonStore.setValue(_e,"newProp","new value");jsonStore.unsetAttribute(_e,"updated");t.is(jsonStore.getValue(_e,"name"),"new name");t.is(jsonStore.getValue(_e,"newProp"),"new value");t.is(jsonStore.getValue(_e,"updated"),undefined);jsonStore.revert();t.is(jsonStore.getValue(_e,"name"),"Object 1");t.is(jsonStore.getValue(_e,"newProp"),undefined);t.t(typeof jsonStore.getValue(_e,"updated")=="number");d.callback(true);},onError:_1.partial(_3.data.tests.stores.JsonRestStore.error,doh,d)});return d;}},{name:"Delete",timeout:10000,runTest:function(t){var d=new doh.Deferred();jsonStore.fetchItemByIdentity({identity:"obj1",onItem:function(_10,_11){var _12=jsonStore.newItem({directRef:_10,name:"Foo"});jsonStore.setValue(_12,"arrayRef",[1,{subobject:_10},_10]);jsonStore.deleteItem(_10);t.is(jsonStore.getValue(_12,"directRef"),undefined);t.is(jsonStore.getValue(_12,"arrayRef").length,2);t.is(jsonStore.getValue(_12,"arrayRef")[1].subobject,undefined);jsonStore.revert();d.callback(true);},onError:_1.partial(_3.data.tests.stores.JsonRestStore.error,doh,d)});return d;}},{name:"Lazy loading",timeout:10000,runTest:function(t){var d=new doh.Deferred();jsonStore.fetch({query:"query",onComplete:function(_13,_14){var _15=_13[2];t.f(jsonStore.isItemLoaded(_15));jsonStore.getValue(_15,"name");t.is(_13[2],_15);t.is(_15.name,"Object 3");d.callback(true);},onError:_1.partial(_3.data.tests.stores.JsonRestStore.error,doh,d)});return d;}},{name:"Lazy loading 2",timeout:10000,runTest:function(t){var d=new doh.Deferred();jsonStore.fetch({query:"query",onComplete:function(_16,_17){t.f(jsonStore.isItemLoaded(_16[3]));jsonStore.loadItem({item:_16[3],onItem:function(_18){t.t(jsonStore.isItemLoaded(_16[3]));t.is(_18,_16[3]);t.is(_18.name,"Object 4");d.callback(true);}});},onError:_1.partial(_3.data.tests.stores.JsonRestStore.error,doh,d)});return d;}},{name:"IdentityAPI: fetchItemByIdentity and getIdentity",timeout:30000,runTest:function(t){var d=new doh.Deferred();jsonStore.fetchItemByIdentity({identity:"obj3",onItem:function(_19,_1a){t.t(jsonStore.isItemLoaded(_19));t.is(jsonStore.getIdentity(_19),"obj3");}});}},{name:"ReadAPI:  Fetch_20_Streaming",timeout:10000,runTest:function(t){var d=new doh.Deferred();var _1b=0;function _1c(_1d,_1e){t.assertTrue(typeof _1d=="number");_1b++;};function _1f(_20,_21){t.is(20,_1b);d.callback(true);};jsonStore.fetch({query:"bigQuery",onBegin:null,count:20,onItem:_1c,onComplete:_1f,onError:_1.partial(_3.data.tests.stores.JsonRestStore.error,t,d)});return d;}},function testSchema(t){var d=new doh.Deferred();jsonStore.fetchItemByIdentity({identity:"obj3",onItem:function(_22,_23){var set=false;try{jsonStore.setValue(_22,"name",333);set=true;}catch(e){}try{jsonStore.setValue(_22,"name","a");set=true;}catch(e){}t.f(set);d.callback(true);}});},function testReadAPI_functionConformance(t){var _24=new _1.data.api.Read();var _25=true;for(i in _24){if(i.toString().charAt(0)!=="_"){var _26=_24[i];if(typeof _26==="function"){var _27=jsonStore[i];if(!(typeof _27==="function")){_25=false;break;}}}}},function tryToLoadSameTarget(t){t.is(_3.data.JsonRestStore.getStore({target:"/something/"},_3.data.JsonRestStore),_3.data.JsonRestStore.getStore({target:"/something/"}));}]);performanceTest=function(){jsonStore.fetch({query:"obj1",onComplete:function(_28){var now=new Date().getTime();var _29;for(var i=0;i<100000;i++){}now=new Date().getTime();for(i=0;i<100000;i++){_29=_28.name;}now=new Date().getTime();for(i=0;i<100000;i++){_29=jsonStore.getValue(_28,"name");}var _2a=new _1.data.ItemFileReadStore({data:{identifier:"id",items:[{id:"1",name:"Fozzie Bear",wears:["hat","tie"]},{id:"2",name:"Miss Piggy",pets:"Foo-Foo"}]}});_2a.fetchItemByIdentity({identity:"1",onItem:function(_2b){_28=_2b;}});now=new Date().getTime();for(i=0;i<100000;i++){_29=_2a.getValue(_28,"name");}}});};});require(["dojox/data/tests/stores/JsonRestStore"]);