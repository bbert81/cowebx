/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/kernel",".","dojo/on","dojo/aspect","dojo/Stateful","dojo/window","./_base/manager","dojo/_base/declare","dojo/_base/html","dojo/_base/lang","dojo/_base/load","dojo/_base/sniff","dojo/_base/unload","dojo/_base/window"],function(_1,_2,_3,_4,_5){var _6=_1.declare([_5,_3.Evented],{curNode:null,activeStack:[],constructor:function(){var _7=_1.hitch(this,function(_8){if(_1.isDescendant(this.curNode,_8)){this.set("curNode",null);}if(_1.isDescendant(this.prevNode,_8)){this.set("prevNode",null);}});_4.before(_1,"empty",_7);_4.before(_1,"destroy",_7);},registerIframe:function(_9){return this.registerWin(_9.contentWindow,_9);},unregisterIframe:function(_a){this.unregisterWin(_a);},registerWin:function(_b,_c){var _d=this;var _e=function(_f){_d._justMouseDowned=true;setTimeout(function(){_d._justMouseDowned=false;},0);if(_1.isIE&&_f&&_f.srcElement&&_f.srcElement.parentNode==null){return;}_d._onTouchNode(_c||_f.target||_f.srcElement,"mouse");};var doc=_1.isIE?_b.document.documentElement:_b.document;if(doc){if(_1.isIE){_b.document.body.attachEvent("onmousedown",_e);var _10=function(evt){if(evt.srcElement.tagName.toLowerCase()!="#document"&&_2.isTabNavigable(evt.srcElement)){_d._onFocusNode(_c||evt.srcElement);}else{_d._onTouchNode(_c||evt.srcElement);}};doc.attachEvent("onactivate",_10);var _11=function(evt){_d._onBlurNode(_c||evt.srcElement);};doc.attachEvent("ondeactivate",_11);return function(){_b.document.detachEvent("onmousedown",_e);doc.detachEvent("onactivate",_10);doc.detachEvent("ondeactivate",_11);doc=null;};}else{doc.body.addEventListener("mousedown",_e,true);var _12=function(evt){_d._onFocusNode(_c||evt.target);};doc.addEventListener("focus",_12,true);var _13=function(evt){_d._onBlurNode(_c||evt.target);};doc.addEventListener("blur",_13,true);return function(){doc.body.removeEventListener("mousedown",_e,true);doc.removeEventListener("focus",_12,true);doc.removeEventListener("blur",_13,true);doc=null;};}}},unregisterWin:function(_14){_14&&_14();},_onBlurNode:function(_15){this.set("prevNode",this.curNode);this.set("curNode",null);if(this._justMouseDowned){return;}if(this._clearActiveWidgetsTimer){clearTimeout(this._clearActiveWidgetsTimer);}this._clearActiveWidgetsTimer=setTimeout(_1.hitch(this,function(){delete this._clearActiveWidgetsTimer;this._setStack([]);this.prevNode=null;}),100);},_onTouchNode:function(_16,by){if(this._clearActiveWidgetsTimer){clearTimeout(this._clearActiveWidgetsTimer);delete this._clearActiveWidgetsTimer;}var _17=[];try{while(_16){var _18=_1.attr(_16,"dijitPopupParent");if(_18){_16=_2.byId(_18).domNode;}else{if(_16.tagName&&_16.tagName.toLowerCase()=="body"){if(_16===_1.body()){break;}_16=_1.window.get(_16.ownerDocument).frameElement;}else{var id=_16.getAttribute&&_16.getAttribute("widgetId"),_19=id&&_2.byId(id);if(_19&&!(by=="mouse"&&_19.get("disabled"))){_17.unshift(id);}_16=_16.parentNode;}}}}catch(e){}this._setStack(_17,by);},_onFocusNode:function(_1a){if(!_1a){return;}if(_1a.nodeType==9){return;}this._onTouchNode(_1a);if(_1a==this.curNode){return;}this.set("curNode",_1a);},_setStack:function(_1b,by){var _1c=this.activeStack;this.set("activeStack",_1b);for(var _1d=0;_1d<Math.min(_1c.length,_1b.length);_1d++){if(_1c[_1d]!=_1b[_1d]){break;}}var _1e;for(var i=_1c.length-1;i>=_1d;i--){_1e=_2.byId(_1c[i]);if(_1e){_1e._hasBeenBlurred=true;_1e.set("focused",false);if(_1e._focusManager==this){_1e._onBlur(by);}this.emit("widget-blur",_1e,by);}}for(i=_1d;i<_1b.length;i++){_1e=_2.byId(_1b[i]);if(_1e){_1e.set("focused",true);if(_1e._focusManager==this){_1e._onFocus(by);}this.emit("widget-focus",_1e,by);}}}});var _1f=new _6();_1.addOnLoad(function(){var _20=_1f.registerWin(window);if(_1.isIE){_1.addOnWindowUnload(function(){_1f.unregisterWin(_20);_20=null;});}});return _1f;});