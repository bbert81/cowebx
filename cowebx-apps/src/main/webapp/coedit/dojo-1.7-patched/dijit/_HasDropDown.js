/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/kernel",".","./popup","./_FocusMixin","dojo/_base/connect","dojo/_base/declare","dojo/_base/event","dojo/_base/html","dojo/_base/lang","dojo/_base/window","dojo/window"],function(_1,_2,_3){_1.declare("dijit._HasDropDown",_2._FocusMixin,{_buttonNode:null,_arrowWrapperNode:null,_popupStateNode:null,_aroundNode:null,dropDown:null,autoWidth:true,forceWidth:false,maxHeight:0,dropDownPosition:["below","above"],_stopClickEvents:true,_onDropDownMouseDown:function(e){if(this.disabled||this.readOnly){return;}_1.stopEvent(e);this._docHandler=this.connect(_1.doc,"onmouseup","_onDropDownMouseUp");this.toggleDropDown();},_onDropDownMouseUp:function(e){if(e&&this._docHandler){this.disconnect(this._docHandler);}var _4=this.dropDown,_5=false;if(e&&this._opened){var c=_1.position(this._buttonNode,true);if(!(e.pageX>=c.x&&e.pageX<=c.x+c.w)||!(e.pageY>=c.y&&e.pageY<=c.y+c.h)){var t=e.target;while(t&&!_5){if(_1.hasClass(t,"dijitPopup")){_5=true;}else{t=t.parentNode;}}if(_5){t=e.target;if(_4.onItemClick){var _6;while(t&&!(_6=_2.byNode(t))){t=t.parentNode;}if(_6&&_6.onClick&&_6.getParent){_6.getParent().onItemClick(_6,e);}}return;}}}if(this._opened&&_4.focus&&_4.autoFocus!==false){window.setTimeout(_1.hitch(_4,"focus"),1);}},_onDropDownClick:function(e){if(this._stopClickEvents){_1.stopEvent(e);}},buildRendering:function(){this.inherited(arguments);this._buttonNode=this._buttonNode||this.focusNode||this.domNode;this._popupStateNode=this._popupStateNode||this.focusNode||this._buttonNode;var _7={"after":this.isLeftToRight()?"Right":"Left","before":this.isLeftToRight()?"Left":"Right","above":"Up","below":"Down","left":"Left","right":"Right"}[this.dropDownPosition[0]]||this.dropDownPosition[0]||"Down";_1.addClass(this._arrowWrapperNode||this._buttonNode,"dijit"+_7+"ArrowButton");},postCreate:function(){this.inherited(arguments);this.connect(this._buttonNode,"onmousedown","_onDropDownMouseDown");this.connect(this._buttonNode,"onclick","_onDropDownClick");this.connect(this.focusNode,"onkeypress","_onKey");this.connect(this.focusNode,"onkeyup","_onKeyUp");},destroy:function(){if(this.dropDown){if(!this.dropDown._destroyed){this.dropDown.destroyRecursive();}delete this.dropDown;}this.inherited(arguments);},_onKey:function(e){if(this.disabled||this.readOnly){return;}var d=this.dropDown,_8=e.target;if(d&&this._opened&&d.handleKey){if(d.handleKey(e)===false){_1.stopEvent(e);return;}}if(d&&this._opened&&e.charOrCode==_1.keys.ESCAPE){this.closeDropDown();_1.stopEvent(e);}else{if(!this._opened&&(e.charOrCode==_1.keys.DOWN_ARROW||((e.charOrCode==_1.keys.ENTER||e.charOrCode==" ")&&((_8.tagName||"").toLowerCase()!=="input"||(_8.type&&_8.type.toLowerCase()!=="text"))))){this._toggleOnKeyUp=true;_1.stopEvent(e);}}},_onKeyUp:function(){if(this._toggleOnKeyUp){delete this._toggleOnKeyUp;this.toggleDropDown();var d=this.dropDown;if(d&&d.focus){setTimeout(_1.hitch(d,"focus"),1);}}},_onBlur:function(){var _9=_2._curFocus&&this.dropDown&&_1.isDescendant(_2._curFocus,this.dropDown.domNode);this.closeDropDown(_9);this.inherited(arguments);},isLoaded:function(){return true;},loadDropDown:function(_a){_a();},toggleDropDown:function(){if(this.disabled||this.readOnly){return;}if(!this._opened){if(!this.isLoaded()){this.loadDropDown(_1.hitch(this,"openDropDown"));}else{this.openDropDown();}}else{this.closeDropDown();}},openDropDown:function(){var _b=this.dropDown,_c=_b.domNode,_d=this._aroundNode||this.domNode,_e=this;if(!this._preparedNode){this._preparedNode=true;if(_c.style.width){this._explicitDDWidth=true;}if(_c.style.height){this._explicitDDHeight=true;}}if(this.maxHeight||this.forceWidth||this.autoWidth){var _f={display:"",visibility:"hidden"};if(!this._explicitDDWidth){_f.width="";}if(!this._explicitDDHeight){_f.height="";}_1.style(_c,_f);var _10=this.maxHeight;if(_10==-1){var _11=_1.window.getBox(),_12=_1.position(_d,false);_10=Math.floor(Math.max(_12.y,_11.h-(_12.y+_12.h)));}_3.moveOffScreen(_b);if(_b.startup&&!_b._started){_b.startup();}var mb=_1._getMarginSize(_c);var _13=(_10&&mb.h>_10);_1.style(_c,{overflowX:"hidden",overflowY:_13?"auto":"hidden"});if(_13){mb.h=_10;if("w" in mb){mb.w+=16;}}else{delete mb.h;}if(this.forceWidth){mb.w=_d.offsetWidth;}else{if(this.autoWidth){mb.w=Math.max(mb.w,_d.offsetWidth);}else{delete mb.w;}}if(_1.isFunction(_b.resize)){_b.resize(mb);}else{_1.marginBox(_c,mb);}}var _14=_3.open({parent:this,popup:_b,around:_d,orient:this.dropDownPosition,onExecute:function(){_e.closeDropDown(true);},onCancel:function(){_e.closeDropDown(true);},onClose:function(){_1.attr(_e._popupStateNode,"popupActive",false);_1.removeClass(_e._popupStateNode,"dijitHasDropDownOpen");_e._opened=false;}});_1.attr(this._popupStateNode,"popupActive","true");_1.addClass(_e._popupStateNode,"dijitHasDropDownOpen");this._opened=true;return _14;},closeDropDown:function(_15){if(this._opened){if(_15){this.focus();}_3.close(this.dropDown);this._opened=false;}}});return _2._HasDropDown;});