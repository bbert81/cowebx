/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

define(["dojo/_base/kernel","..","dojo/dnd/common","./_dndContainer","dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/_base/event","dojo/_base/lang","dojo/_base/window","dojo/mouse"],function(_1,_2){_1.declare("dijit.tree._dndSelector",_2.tree._dndContainer,{constructor:function(_3,_4){this.selection={};this.anchor=null;_2.setWaiState(this.tree.domNode,"multiselect",!this.singular);this.events.push(_1.connect(this.tree.domNode,"onmousedown",this,"onMouseDown"),_1.connect(this.tree.domNode,"onmouseup",this,"onMouseUp"),_1.connect(this.tree.domNode,"onmousemove",this,"onMouseMove"));},singular:false,getSelectedTreeNodes:function(){var _5=[],_6=this.selection;for(var i in _6){_5.push(_6[i]);}return _5;},selectNone:function(){this.setSelection([]);return this;},destroy:function(){this.inherited(arguments);this.selection=this.anchor=null;},addTreeNode:function(_7,_8){this.setSelection(this.getSelectedTreeNodes().concat([_7]));if(_8){this.anchor=_7;}return _7;},removeTreeNode:function(_9){this.setSelection(this._setDifference(this.getSelectedTreeNodes(),[_9]));return _9;},isTreeNodeSelected:function(_a){return _a.id&&!!this.selection[_a.id];},setSelection:function(_b){var _c=this.getSelectedTreeNodes();_1.forEach(this._setDifference(_c,_b),_1.hitch(this,function(_d){_d.setSelected(false);if(this.anchor==_d){delete this.anchor;}delete this.selection[_d.id];}));_1.forEach(this._setDifference(_b,_c),_1.hitch(this,function(_e){_e.setSelected(true);this.selection[_e.id]=_e;}));this._updateSelectionProperties();},_setDifference:function(xs,ys){_1.forEach(ys,function(y){y.__exclude__=true;});var _f=_1.filter(xs,function(x){return !x.__exclude__;});_1.forEach(ys,function(y){delete y["__exclude__"];});return _f;},_updateSelectionProperties:function(){var _10=this.getSelectedTreeNodes();var _11=[],_12=[];_1.forEach(_10,function(_13){_12.push(_13);_11.push(_13.getTreePath());});var _14=_1.map(_12,function(_15){return _15.item;});this.tree._set("paths",_11);this.tree._set("path",_11[0]||[]);this.tree._set("selectedNodes",_12);this.tree._set("selectedNode",_12[0]||null);this.tree._set("selectedItems",_14);this.tree._set("selectedItem",_14[0]||null);},onMouseDown:function(e){if(!this.current||this.tree.isExpandoNode(e.target,this.current)){return;}if(e.button==_1.mouseButtons.RIGHT){return;}_1.stopEvent(e);var _16=this.current,_17=_1.isCopyKey(e),id=_16.id;if(!this.singular&&!e.shiftKey&&this.selection[id]){this._doDeselect=true;return;}else{this._doDeselect=false;}this.userSelect(_16,_17,e.shiftKey);},onMouseUp:function(e){if(!this._doDeselect){return;}this._doDeselect=false;this.userSelect(this.current,_1.isCopyKey(e),e.shiftKey);},onMouseMove:function(e){this._doDeselect=false;},userSelect:function(_18,_19,_1a){if(this.singular){if(this.anchor==_18&&_19){this.selectNone();}else{this.setSelection([_18]);this.anchor=_18;}}else{if(_1a&&this.anchor){var cr=_2.tree._compareNodes(this.anchor.rowNode,_18.rowNode),_1b,end,_1c=this.anchor;if(cr<0){_1b=_1c;end=_18;}else{_1b=_18;end=_1c;}var _1d=[];while(_1b!=end){_1d.push(_1b);_1b=this.tree._getNextNode(_1b);}_1d.push(end);this.setSelection(_1d);}else{if(this.selection[_18.id]&&_19){this.removeTreeNode(_18);}else{if(_19){this.addTreeNode(_18,true);}else{this.setSelection([_18]);this.anchor=_18;}}}}},forInSelectedItems:function(f,o){o=o||_1.global;for(var id in this.selection){f.call(o,this.getItem(id),id,this);}}});return _2.tree._dndSelector;});